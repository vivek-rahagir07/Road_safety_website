<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Safety Awareness – Safe Return</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- === FIREBASE SDKs === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            setLogLevel,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc,
            onSnapshot, // <-- NEW: Import onSnapshot
            where // <-- NEW: Import where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NEW: Import Firebase Storage
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAhRd4r8xBzJFKpgAIgXoR1rsun0F7p4_Q",
            authDomain: "road-safety05.firebaseapp.com",
            databaseURL: "https://road-safety05-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-safety05",
            storageBucket: "road-safety05.firebasestorage.app",
            messagingSenderId: "710275213811",
            appId: "1:710275213811:web:6a66835798ae912d47ca86",
            measurementId: "G-70YQ76X8H1"
        };

        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // NEW: Initialize Storage
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- NEW: Make critical instances available globally ---
        window.db = db;
        window.auth = auth;
        window.storage = storage; // NEW: Add storage to global window
        window.appId = appId;
        window.currentUserId = null;
        window.currentUserData = {};
        // --- NEW: Global listeners for real-time data ---
        window.rideRequestsListener = null;
        window.activeAlertsListener = null;

        // --- FIX: Attach Firestore FUNCTIONS to window ---
        window.fs = {
            doc,
            setDoc,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc,
            onSnapshot, // <-- NEW: Add onSnapshot
            where, // <-- NEW: Add where
            // NEW: Add storage functions to global fs object
            storage_ref: ref,
            uploadBytes,
            getDownloadURL
        };
        // --- END FIX ---


        // --- NEW: Helper function to format email as name ---
        const formatEmailAsName = (email) => {
            if (!email || email.indexOf('@') === -1) return 'User'; // Return 'User' if no email or invalid
            try {
                const namePart = email.split('@')[0];
                return namePart
                    .split(/[\._\-]/) // Split by dot, underscore, or dash
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1)) // Capitalize each part
                    .join(' '); // Join with space
            } catch (e) {
                console.warn("Could not format email:", email, e);
                return 'User'; // Fallback
            }
        };
        // --- END NEW ---

        // --- NEW: Password Validation Helper ---
        const validatePassword = (password) => {
            if (password.length < 8) {
                return 'Password must be at least 8 characters long.';
            }
            // Check for at least one lowercase letter
            if (!/[a-z]/.test(password)) {
                return 'Password must contain at least one lowercase letter (a-z).';
            }
            // Check for at least one uppercase letter
            if (!/[A-Z]/.test(password)) {
                return 'Password must contain at least one uppercase letter (A-Z).';
            }
            // Check for at least one number
            if (!/\d/.test(password)) {
                return 'Password must contain at least one number (0-9).';
            }
            // Check for at least one special character
            if (!/[^a-zA-Z0-9]/.test(password)) {
                return 'Password must contain at least one special sign (e.g., !, @, #, $).';
            }
            return null; // Password is valid
        };
        // --- END NEW ---

        // --- FIX: Wait for DOM to be loaded before accessing elements ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- AUTHENTICATION LOGIC ---

            // Get elements for showing auth state
            const navAuthLinks = document.getElementById('nav-auth-links'); // Container for Login/Sign Up
            const navUserInfo = document.getElementById('nav-user-info');
            const navUserPhoto = document.getElementById('nav-user-photo'); // <-- CHANGED from navUserInitial
            const navLogoutBtn = document.getElementById('nav-logout-btn');
            const womenShieldLink = document.getElementById('nav-women-shield-link'); // <-- NEW

            // --- FIX 2: Moved these definitions up ---
            // Get elements for dynamic content
            const communityLoginPrompt = document.getElementById('community-login-prompt');
            const communityRegisterView = document.getElementById('community-register-view');
            const communityProfileView = document.getElementById('community-profile-view');
            const communityProfileName = document.getElementById('community-profile-name');
            const communityRegisterTitle = document.getElementById('community-register-title');
            const communityRegisterSubtitle = document.getElementById('community-register-subtitle');

            // --- NEW: Role-specific action buttons ---
            const travelerActions = document.getElementById('traveler-actions');
            const driverActions = document.getElementById('driver-actions');
            const emergencyActions = document.getElementById('emergency-actions');
            const onDutyToggleContainer = document.getElementById('on-duty-toggle-container');
            const onDutyToggle = document.getElementById('on-duty-toggle');
            const onDutyStatusText = document.getElementById('on-duty-status-text');
            // --- END NEW ---

            // --- NEW: Profile Dropdown Elements ---
            const profileDropdownName = document.getElementById('profile-dropdown-name');
            const profileDropdownContact = document.getElementById('profile-dropdown-contact');
            // --- END NEW ---

            // --- NEW: Referral Modal Elements ---
            const referralCodeInput = document.getElementById('referral-code');
            const referralCopyBtn = document.getElementById('referral-copy-btn');
            // --- END NEW ---


            // Listen for authentication state changes (login/logout)
            onAuthStateChanged(auth, async (user) => {

                // --- NEW: Add click listener for Women Shield ---
                // We set the listener *once* and just toggle behavior
                if (womenShieldLink && !womenShieldLink.listenerAdded) {
                    womenShieldLink.addEventListener('click', (e) => {
                        if (womenShieldLink.classList.contains('disabled')) {
                            e.preventDefault();
                            // Use the global showAlert
                            window.showAlert('Login Required', 'You must be signed up and logged in to access the Women Shield.', 'warning');
                        }
                    });
                    womenShieldLink.listenerAdded = true; // Flag to prevent multiple listeners
                }
                // --- END NEW ---

                if (user) {
                    // User is signed in
                    console.log('User logged in:', user.email);
                    navAuthLinks.style.display = 'none'; // Hide Login/Sign Up
                    navUserInfo.style.display = 'flex';
                    // navUserEmail.textContent = user.email; // <-- REMOVED

                    // --- LOGIC TO FETCH USER ROLE AND NAME ---
                    let userRole = 'unknown';
                    let userName = formatEmailAsName(user.email); // Default to formatted email
                    const userId = user.uid;
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId);

                    window.currentUserId = userId; // <-- NEW: Set global userId

                    let userData = {}; // --- FIX 3: Initialize userData ---
                    let photoUrl; // <-- NEW: Declare photoUrl here

                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            userData = userDoc.data(); // --- FIX 3: Assign userData here ---
                            userRole = userData.role || 'unknown';

                            // Get name based on role
                            if (userRole === 'driver') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'traveler') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'emergency') userName = userData.operatorName || formatEmailAsName(user.email);
                            else userName = user.isAnonymous ? 'Guest' : formatEmailAsName(user.email); // No role yet or anonymous

                            // --- NEW: Set photoUrl from userData ---
                            photoUrl = userData.photoUrl;
                            // --- END NEW ---

                            // --- NEW: Seed Demo Data (Rides & Rewards) ---
                            if (!userData.demoDataSeeded && !user.isAnonymous) {
                                console.log("Seeding demo data for user...");
                                const ridesColRef = collection(db, 'artifacts', appId, 'users', userId, 'rides');
                                await addDoc(ridesColRef, {
                                    location: "City Center to Airport",
                                    date: "2025-10-28T15:30:00Z",
                                    driver: "Ramesh Kumar",
                                    price: 450,
                                    type: "car"
                                });
                                await addDoc(ridesColRef, {
                                    location: "Sector 14 to Cyber Hub",
                                    date: "2025-10-27T09:00:00Z",
                                    driver: "Priya Singh",
                                    price: 120,
                                    type: "motorcycle"
                                });

                                const rewardsColRef = collection(db, 'artifacts', appId, 'users', userId, 'rewards');
                                await addDoc(rewardsColRef, {
                                    title: "50% Off First Ride",
                                    description: "Valid for your first ride. Expires in 7 days.",
                                    icon: "fa-percentage",
                                    claimed: false
                                });
                                await addDoc(rewardsColRef, {
                                    title: "₹25 Wallet Credit",
                                    description: "From 'Refer a Friend' bonus.",
                                    icon: "fa-rupee-sign",
                                    claimed: true
                                });

                                // Mark as seeded
                                await updateDoc(userDocRef, { demoDataSeeded: true });
                                userData.demoDataSeeded = true; // Update local copy
                            }
                            // --- END Seed Demo Data ---


                        } else {
                            if (!user.isAnonymous) {
                                console.warn("User document not found for UID:", userId, "Creating one.");
                                // This is a new user who just signed up, create a base doc
                                await setDoc(userDocRef, {
                                    email: user.email,
                                    role: 'unknown',
                                    createdAt: new Date().toISOString(),
                                    walletBalance: 0,
                                    onDuty: false // <-- NEW: Add onDuty status
                                });
                                userRole = 'unknown';
                                userData = { role: 'unknown', email: user.email, walletBalance: 0, onDuty: false };
                            } else {
                                userRole = 'guest';
                                userName = 'Guest';
                                userData = { role: 'guest', name: 'Guest' };
                            }
                        }

                        window.currentUserData = userData; // <-- NEW: Set global userData

                        // --- NEW: Populate Profile Dropdown ---
                        // --- FIX 3: This code is now safe because userData is always an object ---
                        let userPhone = userData.phone || (user.isAnonymous ? 'Anonymous Guest' : 'No contact info');
                        if (profileDropdownName) profileDropdownName.textContent = userName;
                        if (profileDropdownContact) profileDropdownContact.textContent = userPhone;
                        // --- END NEW ---

                        // --- NEW: Populate Referral Code ---
                        if (referralCodeInput) {
                            // Generate a simple code from the user's ID
                            referralCodeInput.value = `SR-${userId.substring(0, 6).toUpperCase()}`;
                        }
                        // --- END NEW ---

                    } catch (error) {
                        console.error("Error fetching user document:", error);
                        window.currentUserData = { role: 'guest' }; // Set fallback
                    }

                    // --- NEW LOGIC FOR PROFILE PHOTO ---
                    if (navUserPhoto) {
                        if (photoUrl) {
                            navUserPhoto.src = photoUrl;
                        } else {
                            let initial = 'G'; // Default 'Guest'
                            if (userName) {
                                initial = userName.charAt(0).toUpperCase();
                            }
                            // Use placeholder service to generate an initial image
                            navUserPhoto.src = `https://placehold.co/40x40/ccc/eee?text=${initial}`;
                        }
                    }
                    // --- END NEW LOGIC ---

                    // --- NEW: Enable/Disable Women Shield based on gender ---
                    const userGender = window.currentUserData?.gender; // Get gender from global data
                    if (user.isAnonymous || userGender !== 'female') {
                        console.log(`User is anonymous or not female (gender: ${userGender}), disabling Women Shield.`);
                        if (womenShieldLink) {
                            womenShieldLink.classList.add('disabled');
                            womenShieldLink.style.color = ''; // Let CSS class handle it
                        }
                    } else {
                        // User is signed up AND is female
                        console.log('User is signed up and female, enabling Women Shield.');
                        if (womenShieldLink) {
                            womenShieldLink.classList.remove('disabled');
                            womenShieldLink.style.color = 'var(--accent-color)'; // Restore color
                        }
                    }
                    // --- END NEW ---

                    // --- NEW LOGIC TO SHOW CORRECT COMMUNITY VIEW ---
                    // --- FIX 2: These variables are now defined and this block will work ---
                    // --- HIDE ALL ROLE-SPECIFIC ELEMENTS FIRST ---
                    if (travelerActions) travelerActions.style.display = 'none';
                    if (driverActions) driverActions.style.display = 'none';
                    if (emergencyActions) emergencyActions.style.display = 'none';
                    if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'none';

                    if (userRole === 'driver' || userRole === 'traveler' || userRole === 'emergency') {
                        // User is logged in AND has a role
                        communityLoginPrompt.style.display = 'none';
                        communityRegisterView.style.display = 'none';
                        communityProfileView.style.display = 'block';

                        communityProfileName.textContent = userName;
                        communityProfileView.className = `profile-view-${userRole}`;
                        if (navUserInfo) navUserInfo.className = `dropdown profile-role-${userRole}`; // <!-- ADDED LINE -->

                        // --- NEW: Show correct action buttons ---
                        if (userRole === 'traveler') {
                            if (travelerActions) travelerActions.style.display = 'flex';
                        } else if (userRole === 'driver') {
                            if (driverActions) driverActions.style.display = 'flex';
                            if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'flex';
                        } else if (userRole === 'emergency') {
                            if (emergencyActions) emergencyActions.style.display = 'flex';
                            if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'flex';
                        }

                        // --- NEW: Set On Duty Toggle State ---
                        if (onDutyToggle) {
                            const onDuty = window.currentUserData.onDuty || false;
                            onDutyToggle.checked = onDuty;
                            onDutyStatusText.textContent = onDuty ? 'On Duty' : 'Off Duty';
                            onDutyStatusText.className = onDuty ? 'on-duty' : 'off-duty';

                            // --- NEW: Add event listener for duty toggle ---
                            // Remove old listener to avoid duplicates, then add new one
                            const newOnDutyToggle = onDutyToggle.cloneNode(true);
                            onDutyToggle.parentNode.replaceChild(newOnDutyToggle, onDutyToggle);

                            newOnDutyToggle.addEventListener('change', async () => {
                                const isChecked = newOnDutyToggle.checked;
                                onDutyStatusText.textContent = isChecked ? 'On Duty' : 'Off Duty';
                                onDutyStatusText.className = isChecked ? 'on-duty' : 'off-duty';

                                try {
                                    const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUserId);
                                    await updateDoc(userDocRef, { onDuty: isChecked });
                                    window.currentUserData.onDuty = isChecked; // Update local state
                                    // Use the global showAlert
                                    window.showAlert('Status Updated', `You are now ${isChecked ? 'On Duty' : 'Off Duty'}.`, 'success');
                                } catch (error) {
                                    console.error("Error updating duty status:", error);
                                    // Use the global showAlert
                                    window.showAlert('Update Failed', 'Could not update your status. Please try again.', 'error');
                                    // Revert UI on failure
                                    newOnDutyToggle.checked = !isChecked;
                                    onDutyStatusText.textContent = !isChecked ? 'On Duty' : 'Off Duty';
                                    onDutyStatusText.className = !isChecked ? 'on-duty' : 'off-duty';
                                }
                            });
                            // --- END NEW ---
                        }
                        // --- END NEW ---

                    } else {
                        // User is logged in but has NO role (e.g., 'unknown' or 'guest')
                        communityLoginPrompt.style.display = 'none';
                        communityRegisterView.style.display = 'block'; // Show role selection
                        communityProfileView.style.display = 'none';
                        if (navUserInfo) navUserInfo.className = `dropdown profile-role-${userRole}`; // <!-- ADDED LINE -->

                        // Update titles to prompt for profile completion
                        communityRegisterTitle.innerHTML = '<i class="fas fa-user-plus"></i> Complete Your Profile';
                        communityRegisterSubtitle.textContent = 'You are logged in. Please select your role in the community to continue.';
                    }

                    // --- NEW: Populate Modals ---
                    if (window.populateWallet) window.populateWallet();
                    if (window.populateRides) window.populateRides();
                    if (window.populateRewards) window.populateRewards();
                    // --- END NEW ---

                    closeModal(); // Hide any open auth modals

                } else {
                    // User is signed out
                    console.log('User logged out');
                    navAuthLinks.style.display = 'flex'; // Show Login/Sign Up
                    navUserInfo.style.display = 'none';
                    if (navUserPhoto) navUserPhoto.src = 'https://placehold.co/40x40/ccc/eee?text=G'; // <-- ADDED: Reset photo
                    if (navUserInfo) navUserInfo.className = 'dropdown'; // <!-- ADDED LINE -->

                    // --- NEW: Disable Women Shield Link ---
                    if (womenShieldLink) {
                        womenShieldLink.classList.add('disabled');
                        womenShieldLink.style.color = ''; // Let CSS class handle it
                    }
                    // --- END NEW ---

                    window.currentUserId = null; // <-- NEW
                    window.currentUserData = {}; // <-- NEW

                    // --- NEW: Reset Profile Dropdown ---
                    if (profileDropdownName) profileDropdownName.textContent = 'Guest';
                    if (profileDropdownContact) profileDropdownContact.textContent = 'Please log in';
                    // --- END NEW ---

                    // --- NEW: Reset Referral Code ---
                    if (referralCodeInput) referralCodeInput.value = 'LOGIN-TO-SEE-CODE';
                    // --- END NEW ---

                    // --- FIX 2: These variables are now defined and this block will work ---
                    // Show the default "login prompt" view
                    communityLoginPrompt.style.display = 'block';
                    communityRegisterView.style.display = 'none';
                    communityProfileView.style.display = 'none';
                    communityProfileView.className = '';

                    // --- NEW: Hide all role-specific elements ---
                    if (travelerActions) travelerActions.style.display = 'none';
                    if (driverActions) driverActions.style.display = 'none';
                    if (emergencyActions) emergencyActions.style.display = 'none';
                    if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'none';
                    // --- END NEW ---

                    // --- NEW: Clear Modals ---
                    if (window.populateWallet) window.populateWallet();
                    if (window.populateRides) window.populateRides();
                    if (window.populateRewards) window.populateRewards();
                    // --- END NEW ---
                }
            });

            // Sign in with custom token if available, otherwise anonymously
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial authentication:", error);
                }
            })();


            // --- Get all modal elements ---
            const regModal = document.getElementById('reg-modal');
            const regCloseBtn = regModal.querySelector('.reg-form-close');

            // Form Wrappers
            const loginFormWrapper = document.getElementById('login-form-wrapper');
            const signupFormWrapper = document.getElementById('signup-form-wrapper'); // NEW
            const driverFormWrapper = document.getElementById('driver-form-wrapper');
            const emergencyFormWrapper = document.getElementById('emergency-form-wrapper');
            const travelerFormWrapper = document.getElementById('traveler-form-wrapper');

            // Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form'); // NEW
            const driverForm = document.getElementById('driver-registration-form');
            const emergencyForm = document.getElementById('emergency-registration-form');
            const travelerForm = document.getElementById('traveler-registration-form');

            // Success Messages
            const driverSuccess = document.getElementById('driver-success-message');
            const emergencySuccess = document.getElementById('emergency-success-message');
            const travelerSuccess = document.getElementById('traveler-success-message');

            // Error Messages
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error'); // NEW
            const driverRegError = document.getElementById('driver-reg-error');
            const travelerRegError = document.getElementById('traveler-reg-error');
            const emergencyRegError = document.getElementById('emergency-reg-error');

            // Map Containers
            const driverMapContainer = document.getElementById('driver-map-container');
            const emergencyMapContainer = document.getElementById('emergency-map-container');

            // --- NEW: Photo File Holders ---
            let driverPhotoFile = null;
            let travelerPhotoFile = null;
            let emergencyPhotoFile = null;
            // --- END NEW ---

            // --- Modal Control Functions ---
            const allFormWrappers = [loginFormWrapper, signupFormWrapper, driverFormWrapper, emergencyFormWrapper, travelerFormWrapper];
            const allSuccessMessages = [driverSuccess, emergencySuccess, travelerSuccess];
            const allErrorMessages = [loginError, signupError, driverRegError, travelerRegError, emergencyRegError];

            // Reset all modal content
            const resetModalForms = () => {
                allFormWrappers.forEach(form => {
                    if (form) form.style.display = 'none';
                });
                allSuccessMessages.forEach(msg => {
                    if (msg) msg.style.display = 'none';
                });
                allErrorMessages.forEach(msg => {
                    if (msg) {
                        msg.style.display = 'none';
                        msg.textContent = '';
                    }
                });

                // Reset the forms themselves
                if (loginForm) loginForm.reset();
                if (signupForm) signupForm.reset(); // NEW
                if (driverForm) driverForm.reset();
                if (emergencyForm) emergencyForm.reset();
                if (travelerForm) travelerForm.reset();

                // --- NEW: Reset photo previews ---
                const previews = document.querySelectorAll('.photo-preview');
                const icons = document.querySelectorAll('.upload-icon');
                previews.forEach(p => p.classList.remove('active'));
                icons.forEach(i => i.classList.remove('hidden'));
                driverPhotoFile = null;
                travelerPhotoFile = null;
                emergencyPhotoFile = null;
                // --- END NEW ---

                if (driverMapContainer) {
                    driverMapContainer.style.display = 'none';
                    driverMapContainer.innerHTML = '';
                }
                if (emergencyMapContainer) {
                    emergencyMapContainer.style.display = 'none';
                    emergencyMapContainer.innerHTML = '';
                }

                // --- NEW: Reset gender buttons ---
                document.querySelectorAll('.gender-btn.active').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('input[name="gender"]').forEach(input => input.value = '');
                // --- END NEW ---
            };

            // Close Modal
            const closeModal = () => {
                if (regModal) regModal.classList.remove('active');
                setTimeout(resetModalForms, 300);
            };

            if (regCloseBtn) regCloseBtn.addEventListener('click', closeModal);
            if (regModal) regModal.addEventListener('click', (e) => {
                if (e.target === regModal) {
                    closeModal();
                }
            });

            // --- NEW: Gender Button Logic ---
            const setupGenderButtons = (groupId, inputId) => {
                const group = document.getElementById(groupId);
                const input = document.getElementById(inputId);
                if (!group || !input) return;

                const buttons = group.querySelectorAll('.gender-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active from all buttons in this group
                        buttons.forEach(btn => btn.classList.remove('active'));
                        // Add active to the clicked one
                        button.classList.add('active');
                        // Set the hidden input's value
                        input.value = button.dataset.value;
                    });
                });
            };

            setupGenderButtons('traveler-gender-group', 'travelerGender');
            setupGenderButtons('driver-gender-group', 'driverGender');
            setupGenderButtons('emergency-gender-group', 'emergencyGender');
            // --- END NEW ---

            // --- EVENT LISTENERS ---

            // 1. Listen for clicks on "Login" button in nav
            const navLoginBtn = document.getElementById('nav-login-btn');
            if (navLoginBtn) {
                navLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (loginFormWrapper) loginFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 2. NEW: Listen for clicks on "Sign Up" button in nav
            const navSignupBtn = document.getElementById('nav-signup-btn');
            if (navSignupBtn) {
                navSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (signupFormWrapper) signupFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 3. Listen for clicks on the "Logout" button
            if (navLogoutBtn) {
                navLogoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });
            }

            // 4. Listen for clicks on the role registration cards (Driver, Traveler, Emergency)
            document.querySelectorAll('.reg-card[data-form-type]').forEach(card => {
                card.addEventListener('click', () => {
                    resetModalForms();
                    const formType = card.dataset.formType;

                    if (formType === 'driver') {
                        if (driverFormWrapper) driverFormWrapper.style.display = 'block';
                    } else if (formType === 'emergency') {
                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'block';
                    } else if (formType === 'traveler') {
                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'block';
                    }

                    if (regModal) regModal.classList.add('active');
                });
            });

            // --- FORM SUBMISSION LOGIC ---

            // 1. Handle Login Form Submission
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = loginForm.loginEmail.value;
                    const password = loginForm.loginPassword.value;
                    if (loginError) loginError.style.display = 'none';

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();
                    } catch (error) {
                        console.error("Login Error:", error.message);
                        if (loginError) {
                            loginError.textContent = `Login Failed: ${error.message}`;
                            loginError.style.display = 'block';
                        }
                    }
                });
            }

            // 2. NEW: Handle Sign Up Form Submission
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = signupForm.signupEmail.value;
                    const password = signupForm.signupPassword.value;
                    const confirmPassword = signupForm.signupConfirmPassword.value;
                    if (signupError) signupError.style.display = 'none';

                    // --- MODIFIED: New Password Validation ---
                    const passwordError = validatePassword(password);
                    if (passwordError) {
                        if (signupError) {
                            signupError.textContent = passwordError;
                            signupError.style.display = 'block';
                        }
                        return;
                    }
                    // --- END MODIFICATION ---

                    if (password !== confirmPassword) {
                        if (signupError) {
                            signupError.textContent = 'Passwords do not match.';
                            signupError.style.display = 'block';
                        }
                        return;
                    }

                    try {
                        // Step 1: Create user in Auth
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const userId = user.uid;

                        // Step 2: Create a basic user doc in Firestore with 'unknown' role
                        // onAuthStateChanged will see this 'unknown' role and prompt user to select one
                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), {
                            email: email,
                            role: 'unknown',
                            createdAt: new Date().toISOString(),
                            walletBalance: 0,
                            onDuty: false // <-- NEW: Add onDuty status
                        });

                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();

                    } catch (error) {
                        console.error("Sign Up Error:", error.message);
                        if (signupError) {
                            signupError.textContent = `Sign Up Failed: ${error.message}`;
                            signupError.style.display = 'block';
                        }
                    }
                });
            }

            // 3. Handle Driver Registration (Role Completion)
            if (driverForm) {
                driverForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (driverRegError) driverRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (driverRegError) {
                            driverRegError.textContent = 'You are not logged in. Please log in first.';
                            driverRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = driverForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(driverForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED driverPhoto from data destructuring ---
                    const { driverName, driverPhone, vehicleType, licensePlate, vehicleMake, vehicleModel, baseLocation, gender } = data; // <-- FIX: Changed 'driverDestination' to 'baseLocation' & ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.driverPhotoFile) { // <-- Use global file var
                            if (driverRegError) {
                                driverRegError.textContent = 'Uploading photo...'; // Show status
                                driverRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.driverPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (driverRegError) driverRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from the logged-in user
                            name: driverName,
                            phone: driverPhone,
                            role: 'driver', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            vehicleType: vehicleType,
                            licensePlate: licensePlate,
                            vehicleMake: vehicleMake,
                            vehicleModel: vehicleModel,
                            baseLocation: baseLocation, // <-- MODIFIED: Was 'destination'
                            onDuty: false, // <-- NEW
                            createdAt: new Date().toISOString() // Or update, but new timestamp is fine
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        window.driverPhotoFile = null; // <-- Use global file var
                        const driverPreview = document.getElementById('driver-photo-preview');
                        const driverIcon = document.getElementById('driver-photo-icon');
                        if (driverPreview) driverPreview.classList.remove('active');
                        if (driverIcon) driverIcon.classList.remove('hidden');
                        // --- END NEW ---

                        // Show success
                        if (driverFormWrapper) driverFormWrapper.style.display = 'none';
                        if (driverSuccess) driverSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Driver Registration Error:", error.message);
                        if (driverRegError) {
                            driverRegError.textContent = `Registration Failed: ${error.message}`;
                            driverRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register Driver';
                    }
                });
            }

            // 4. Handle Traveler Registration (Role Completion)
            if (travelerForm) {
                travelerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (travelerRegError) travelerRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (travelerRegError) {
                            travelerRegError.textContent = 'You are not logged in. Please log in first.';
                            travelerRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = travelerForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(travelerForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED travelerPhoto from data destructuring ---
                    const { travelerName, travelerPhone, travelerLocation, gender } = data; // <-- ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.travelerPhotoFile) { // <-- Use global file var
                            if (travelerRegError) {
                                travelerRegError.textContent = 'Uploading photo...'; // Show status
                                travelerRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.travelerPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (travelerRegError) travelerRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from logged-in user
                            name: travelerName,
                            phone: travelerPhone,
                            role: 'traveler', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            defaultLocation: travelerLocation, // <-- MODIFIED: Kept as defaultLocation
                            createdAt: new Date().toISOString()
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        window.travelerPhotoFile = null; // <-- Use global file var
                        const travelerPreview = document.getElementById('traveler-photo-preview');
                        const travelerIcon = document.getElementById('traveler-photo-icon');
                        if (travelerPreview) travelerPreview.classList.remove('active');
                        if (travelerIcon) travelerIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'none';
                        if (travelerSuccess) travelerSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Traveler Registration Error:", error.message);
                        if (travelerRegError) {
                            travelerRegError.textContent = `Registration Failed: ${error.message}`;
                            travelerRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register as Traveler';
                    }
                });
            }

            // 5. Handle Emergency Registration (Role Completion)
            if (emergencyForm) {
                emergencyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (emergencyRegError) emergencyRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (emergencyRegError) {
                            emergencyRegError.textContent = 'You are not logged in. Please log in first.';
                            emergencyRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = emergencyForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(emergencyForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED servicePhoto from data destructuring ---
                    const { serviceType, serviceId, serviceName, servicePhone, serviceVehicleId, serviceVehicleType, baseLocation, gender } = data; // <-- MODIFIED: Was 'emergencyDestination' & ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.emergencyPhotoFile) { // <-- Use global file var
                            if (emergencyRegError) {
                                emergencyRegError.textContent = 'Uploading photo...'; // Show status
                                emergencyRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.emergencyPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (emergencyRegError) emergencyRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const serviceData = {
                            email: user.email, // Get email from logged-in user
                            operatorName: serviceName,
                            phone: servicePhone,
                            role: 'emergency', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            serviceType: serviceType,
                            serviceId: serviceId,
                            vehicleId: serviceVehicleId,
                            vehicleType: serviceVehicleType,
                            baseLocation: baseLocation, // <-- MODIFIED: Was 'destination'
                            onDuty: false, // <-- NEW
                            bestRoute: formData.has('bestRoute'),
                            createdAt: new Date().toISOString()
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), serviceData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        window.emergencyPhotoFile = null; // <-- Use global file var
                        const emergencyPreview = document.getElementById('emergency-photo-preview');
                        const emergencyIcon = document.getElementById('emergency-photo-icon');
                        if (emergencyPreview) emergencyPreview.classList.remove('active');
                        if (emergencyIcon) emergencyIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'none';
                        if (emergencySuccess) emergencySuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Emergency Registration Error:", error.message);
                        if (emergencyRegError) {
                            emergencyRegError.textContent = `Registration Failed: ${error.message}`;
                            emergencyRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register Service';
                    }
                });
            }
        }); // --- End of DOMContentLoaded ---
    </script>

    <style>
        :root {
            --primary-color: #ff4d4d;
            --secondary-color: #222;
            --light-bg: #f4f4f4;
            --card-bg: #fff;
            --text-color: #333;
            --hover-color: #e63939;
            --dark-red-outline: #cc0000;
            --transition-speed: 0.3s;
            --footer-bg: #1a1a1a;
            --footer-text: #fff;
            --footer-accent: #ffcc00;
            --footer-hover: #e6b800;
            --dark-bg: #1a1a1a;
            --light-text: #fff;
            --accent-color: #ffcc00;
            --accent-hover: #e6b800;
            --border-color: #444;

            /* --- NEW Role Colors --- */
            --traveler-color: #007bff;
            --traveler-hover: #0056b3;
            --traveler-bg: #f0f7ff;

            --driver-color: #4CAF50;
            --driver-hover: #45a049;
            --driver-bg: #f0fff0;

            --emergency-color: var(--primary-color);
            --emergency-hover: var(--hover-color);
            --emergency-bg: #fff0f0;
            /* --- END NEW --- */
        }

        /* --- NEW: Gender Button Styles --- */
        .gender-button-group {
            display: flex;
            gap: 10px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }

        .gender-btn {
            flex: 1;
            background: #f9f9f9;
            color: #555;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gender-btn:hover {
            background: #f0f0f0;
        }

        .gender-btn.active {
            color: white;
        }

        .gender-btn[data-value="male"].active {
            background: var(--traveler-color);
            /* Blue for male */
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }

        .gender-btn[data-value="female"].active {
            background: var(--primary-color);
            /* Red/Pink for female */
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.3);
        }

        /* --- END NEW --- */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* * ===========================================
         * HERE IS THE BACKGROUND IMAGE FIX
         * ===========================================
        */
        body {
            font-family: 'Open Sans', sans-serif;

            /* 1. Make sure your image (e.g., 'my-background.jpg') is inside the 'Photoes' folder.
               2. Change 'your-background-image.jpg' below to match your image file name.
            */
            background: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)),
                url('Photoes/index.jpg') center/cover no-repeat fixed;



            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            /* === NEW STICKY FOOTER STYLES === */
            display: flex;
            flex-direction: column;
        }

        /* =========================================== */


        .sidebar-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 999;
            border-radius: 10px 0 0 10px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .sidebar-toggle i {
            margin-bottom: 8px;
            display: block;
        }

        .sidebar-toggle:hover {
            background: var(--hover-color);
            padding-right: 15px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90%;
            height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }

        .sidebar-header h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .sidebar-close:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .news-item,
        .event-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .news-item:hover,
        .event-item:hover {
            box-shadow: 0 5px 20px rgba(255, 77, 77, 0.3);
            transform: translateX(-5px);
            border-left-color: var(--primary-color);
        }

        .news-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .news-item h4,
        .event-item h4 {
            color: var(--secondary-color);
            font-size: 1em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .news-item p,
        .event-item p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .news-date,
        .event-date {
            color: var(--primary-color);
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .event-date i {
            color: var(--primary-color);
        }

        .event-item {
            border-left: 4px solid var(--footer-accent);
        }

        .event-item:hover {
            border-left-color: var(--footer-hover);
            box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em 3em;
            background: rgba(34, 34, 34, 0.85);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: background 0.3s ease;
        }

        nav:hover {
            background: rgba(34, 34, 34, 0.95);
        }

        .nav-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
            transition: color 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .nav-title:hover {
            color: var(--primary-color);
        }

        #website_logo {
            height: 40px;
            width: auto;
            vertical-align: middle;
            margin-right: 10px;
            transition: transform 0.3s ease;
            background-color: #fff;
            border-radius: 50%;
        }

        .nav-title:hover #website_logo {
            transform: scale(1.1);
        }

        .nav-links {
            display: flex;
            gap: 2em;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 1em;
            padding: 0.5em 0;
            font-weight: 600;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3em;
        }

        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* --- NEW: Disabled Nav Link Style --- */
        .nav-links a.disabled {
            color: #888 !important;
            /* Muted color */
            cursor: not-allowed;
        }

        .nav-links a.disabled:hover {
            color: #888 !important;
        }

        .nav-links a.disabled::after {
            display: none !important;
            /* No underline effect */
        }

        /* --- END NEW --- */

        /* === END NEW === */

        /* --- NEW: Profile Icon Color by Role --- */
        .profile-role-traveler .nav-user-photo-class {
            background: var(--traveler-color);
            border-color: var(--traveler-bg);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-traveler:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-driver .nav-user-photo-class {
            background: var(--driver-color);
            border-color: var(--driver-bg);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-driver:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-emergency .nav-user-photo-class {
            background: var(--emergency-color);
            /* Already red */
            border-color: var(--emergency-bg);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover #nav-user-initial {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        /* --- END NEW --- */

        .dropdown-menu#profile-dropdown-menu {
            display: none;
            /* Hidden by default */
            position: absolute;
            top: 100%;
            /* Position below the icon */
            right: 0;
            /* Align to the right */
            left: auto;
            background: #fff;
            /* Light background */
            color: var(--secondary-color);
            min-width: 300px;
            /* Wider than other menus */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 0;
            margin-top: 10px;
            /* Space from icon */
            z-index: 2000;
            border: 1px solid #eee;
            overflow: hidden;
            /* For border-radius on items */

            /* Animation */
            transform-origin: top right;
            transition: all 0.2s ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        .dropdown-menu#profile-dropdown-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Stop CSS hover from opening this specific menu */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu {
            display: none;
        }

        /* ...but allow it to stay open if active */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu.active {
            display: block;
        }

        #profile-dropdown-menu li {
            width: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        /* Special Header Item */
        .profile-dropdown-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-dropdown-header .icon {
            font-size: 1.8em;
            color: var(--primary-color);
            background: #fef0f0;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .profile-dropdown-header .details {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .profile-dropdown-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: #222;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-dropdown-header p {
            margin: 0;
            font-size: 0.9em;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- NEW: Photo Upload Options --- */
        .profile-photo-options {
            display: flex;
            justify-content: space-around;
            padding: 10px 5px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
        }

        .profile-photo-options a {
            flex: 1;
            text-align: center;
            padding: 10px 5px !important;
            font-size: 0.9em !important;
            gap: 8px !important;
            flex-direction: column;
            color: #555 !important;
        }

        .profile-photo-options a i {
            margin: 0 !important;
            width: auto !important;
            font-size: 1.4em !important;
            color: var(--primary-color);
        }

        .profile-photo-options a:hover {
            background: #f5f5f5 !important;
            color: var(--primary-color) !important;
        }

        /* --- END NEW --- */

        /* Standard Menu Items */
        #profile-dropdown-menu li a {
            color: #333;
            /* Dark text for links */
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            padding: 15px 20px;
            font-size: 1em;
            transition: background 0.2s ease, color 0.2s ease;
        }

        #profile-dropdown-menu li a::after {
            display: none;
            /* Remove underline effect */
        }

        #profile-dropdown-menu li a i {
            width: 25px;
            text-align: center;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        #profile-dropdown-menu li a .chevron {
            margin-left: auto;
            color: #aaa;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }

        #profile-dropdown-menu li a:hover {
            background: #f9f9f9;
            color: var(--primary-color);
            /* Hover color */
        }

        #profile-dropdown-menu li a:hover .chevron {
            color: var(--primary-color);
        }

        /* Special item styles */
        .profile-menu-rating {
            background: #fdfaf0;
            /* Light yellow bg */
        }

        .profile-menu-rating a:hover {
            background: #fbf5e6;
        }

        .profile-menu-rating a i.fa-star {
            color: #f39c12;
            /* Star color */
        }

        #profile-dropdown-menu li.logout-item a {
            color: var(--primary-color);
            /* Red for logout */
        }

        #profile-dropdown-menu li.logout-item a:hover {
            background: #fef0f0;
        }

        /* --- END NEW Profile Dropdown Styles --- */


        /* --- NEW: Generic Profile Modal Styles --- */
        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9998;
            /* Below reg-modal (9999) but above rest */
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .profile-modal-content {
            background: #fff;
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            max-height: 90vh;
            /* <-- NEW */
            overflow-y: auto;
            /* <-- NEW */
        }

        .profile-modal-overlay.active .profile-modal-content {
            transform: scale(1);
        }

        .profile-modal-content h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Make sure modal h2 styles don't conflict */
        .profile-modal-content h2 {
            color: var(--primary-color) !important;
            border-bottom: 2px solid #eee !important;
        }

        /* --- NEW: Modal Role-Specific Header Colors --- */
        #book-ride-modal .profile-modal-content h2 {
            color: var(--traveler-color) !important;
            border-bottom-color: var(--traveler-color) !important;
        }

        #ride-requests-modal .profile-modal-content h2 {
            color: var(--driver-color) !important;
            border-bottom-color: var(--driver-color) !important;
        }

        #active-alerts-modal .profile-modal-content h2,
        #priority-route-modal .profile-modal-content h2 {
            color: var(--emergency-color) !important;
            border-bottom-color: var(--emergency-color) !important;
        }

        /* --- END NEW --- */


        .profile-modal-content p {
            font-size: 1em;
            color: #555;
            line-height: 1.6;
        }

        .profile-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .profile-modal-close:hover {
            color: var(--primary-color);
        }

        /* --- END NEW Profile Modal Styles --- */

        /* --- NEW: Styles for Rating Modal --- */
        .star-rating-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2.5em;
            /* Bigger stars */
            color: #ccc;
            margin: 20px 0 25px;
            cursor: pointer;
        }

        .star-rating-container .star {
            transition: color 0.2s, transform 0.2s;
        }

        /* Hover effect: all stars up to and including the hovered one */
        .star-rating-container:hover .star {
            color: var(--accent-color);
        }

        .star-rating-container .star:hover~.star {
            color: #ccc;
        }

        /* Selected stars (after click) */
        .star-rating-container .star.selected {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        /* Keep hover effect working */
        .star-rating-container:hover .star.selected {
            color: var(--accent-color);
        }

        .star-rating-container .star.selected:hover~.star {
            color: #ccc;
        }

        .star-rating-container .star.selected~.star {
            color: #ccc;
        }


        .review-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            resize: vertical;
            margin-bottom: 20px;
        }

        .review-textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .submit-review-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-review-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .submit-review-btn:hover:not(:disabled) {
            background: var(--hover-color);
        }

        #rating-modal .success-message {
            /* display: none; */
            /* Handled inline */
            padding: 20px 0;
            text-align: center;
        }

        #rating-modal .success-message i {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        #rating-modal .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        #rating-modal .success-message p {
            color: #666;
            font-size: 1em;
        }

        /* --- END Rating Modal Styles --- */

        /* --- NEW: Styles for FAQ in Help Modal --- */
        .faq-accordion {
            margin-top: 25px;
        }

        .faq-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            /* To contain details */
        }

        .faq-title {
            padding: 15px 20px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .faq-title:hover {
            background: #f1f1f1;
        }

        .faq-chevron {
            font-size: 0.9em;
            color: #aaa;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .faq-item.active .faq-title {
            color: var(--primary-color);
        }

        .faq-item.active .faq-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .faq-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out;
            padding: 0 20px;
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .faq-details.open {
            opacity: 1;
            padding: 0 20px 20px;
            /* Add bottom padding when open */
        }

        .faq-details p {
            margin: 0;
        }

        .faq-details a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }

        .faq-details a:hover {
            text-decoration: underline;
        }

        /* --- END FAQ Styles --- */

        /* --- NEW: Styles for Wallet Modal --- */
        #payment-modal .wallet-balance {
            background: linear-gradient(135deg, var(--secondary-color), #444);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #payment-modal .wallet-balance p {
            font-size: 1.1em;
            color: #eee;
            margin: 0;
        }

        #payment-modal .wallet-balance h3 {
            font-size: 3em;
            color: white;
            margin: 5px 0 15px;
            font-family: 'Montserrat', sans-serif;
        }

        .add-money-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-money-btn:hover {
            background: var(--hover-color);
        }

        #add-money-section {
            display: none;
            /* Hidden by default */
            padding: 20px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Use existing form styles */
        #add-money-section .form-group {
            margin-bottom: 20px;
        }

        #add-money-section .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        #add-money-section .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        #add-money-section .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        /* --- */

        #payment-modal h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .saved-payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .saved-payment-method .icon {
            font-size: 2.2em;
            color: #007bff;
            /* Visa blue */
        }

        .saved-payment-method .details {
            flex-grow: 1;
        }

        .saved-payment-method .details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .saved-payment-method .details span {
            font-size: 0.9em;
            color: #777;
        }

        .saved-payment-method .remove-btn {
            font-size: 0.9em;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            background: none;
            border: none;
        }

        .saved-payment-method .remove-btn:hover {
            text-decoration: underline;
        }

        /* --- END Wallet Styles --- */

        /* --- NEW: Styles for My Rides Modal --- */
        .ride-history-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ride-history-list li {
            padding: 10px 5px;
        }

        .ride-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .ride-item .icon {
            font-size: 1.8em;
            color: var(--primary-color);
        }

        .ride-item .ride-details {
            flex-grow: 1;
        }

        .ride-item .ride-details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .ride-item .ride-details span {
            font-size: 0.9em;
            color: #777;
            display: block;
        }

        .ride-item .ride-price {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--secondary-color);
        }

        /* --- NEW: Styles for Ride Requests & Alerts Modals --- */
        .modal-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 350px;
            overflow-y: auto;
        }

        .modal-list-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .modal-list-item .icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }

        .modal-list-item .details {
            flex-grow: 1;
        }

        .modal-list-item .details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .modal-list-item .details span {
            font-size: 0.9em;
            color: #777;
            display: block;
            line-height: 1.4;
        }

        /* Ride Request Item */
        .ride-request-item .icon {
            color: var(--traveler-color);
        }

        .ride-request-item .accept-btn {
            background: var(--driver-color);
            color: white;
            border: none;
            padding: 8px 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            align-self: center;
        }

        .ride-request-item .accept-btn:hover {
            background: var(--driver-hover);
        }

        /* Alert Item */
        .alert-item .icon {
            color: var(--emergency-color);
        }

        .alert-item .details span {
            font-weight: 600;
            color: #555;
        }

        .alert-item .details .timestamp {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
        }

        /* --- END NEW --- */


        /* --- NEW: Styles for Safety Modal --- */
        .safety-features {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        .safety-feature-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .safety-feature-btn i {
            font-size: 1.8em;
        }

        .safety-feature-btn.share-btn {
            background: #007bff;
            color: white;
        }

        .safety-feature-btn.share-btn:hover {
            background: #0056b3;
            transform: translateY(-3px);
        }

        .safety-feature-btn.sos-btn {
            background: var(--primary-color);
            color: white;
        }

        .safety-feature-btn.sos-btn:hover {
            background: var(--hover-color);
            transform: translateY(-3px);
        }

        .safety-tips-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .safety-tips-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .safety-tips-list li i {
            color: #4CAF50;
            font-size: 1.2em;
        }

        /* --- END Safety & Rides Styles --- */

        /* --- NEW: Styles for Refer & Rewards Modals --- */
        #refer-modal .referral-code-box {
            display: flex;
            margin: 25px 0;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
        }

        #referral-code {
            flex-grow: 1;
            padding: 15px;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--secondary-color);
            border: none;
            background: #fdf0f0;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
        }

        #referral-code:focus {
            outline: none;
        }

        #referral-copy-btn {
            padding: 0 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        #referral-copy-btn:hover {
            background: var(--hover-color);
        }

        #referral-copy-btn:active {
            transform: scale(0.95);
        }

        #refer-modal .social-share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .social-share-btn {
            font-size: 1.8em;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .social-share-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .social-share-btn.whatsapp {
            background: #25D366;
        }

        .social-share-btn.twitter {
            background: #1DA1F2;
        }

        .social-share-btn.facebook {
            background: #1877F2;
        }

        .social-share-btn.sms {
            background: #777;
        }

        .rewards-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .rewards-list li {
            padding: 5px 0;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }

        .reward-item .icon {
            font-size: 2.5em;
            color: var(--accent-color);
        }

        .reward-item .details {
            flex-grow: 1;
        }

        .reward-item .details h4 {
            font-size: 1.1em;
            color: var(--secondary-color);
            margin: 0 0 5px;
            padding: 0;
            border: none;
        }

        .reward-item .details p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }

        .reward-item .claim-btn {
            background: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 8px 15px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .reward-item .claim-btn:hover {
            background: var(--accent-hover);
        }

        .reward-item .claim-btn[disabled] {
            background: #ccc;
            cursor: not-allowed;
        }

        /* --- END Refer & Rewards Styles --- */


        header {
            margin-top: 70px;
            background: rgba(255, 77, 77, 0.9);
            color: var(--card-bg);
            padding: 2em 1em 2.5em;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        header main h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(2em, 4vw, 2.6em);
            margin-bottom: 0.5em;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }

        header main p {
            font-size: 1.1em;
            color: #f0f0f0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            margin-bottom: 1em;
        }

        header main figure {
            margin: 0;
            padding: 0;
        }

        header main figure blockquote {
            font-style: italic;
            font-size: 1.1em;
            margin: 1em auto 0;
            color: #ffffff;
            max-width: 600px;
            padding: 0.8em 1em;
            border-left: 5px solid rgb(255, 255, 255);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        .content {
            max-width: 1000px;
            margin: 2.5em auto;
            padding: 2em 1.5em;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .content h2#why-ai-traffic-lights {
            font-size: 2em;
            text-align: center;
            padding-bottom: 0.5em;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 1.5em;
        }

        .flex-cards {
            display: flex;
            gap: 2em;
            flex-wrap: wrap;
            margin-bottom: 2.5em;
        }

        .flex-cards>article {
            flex: 1;
            min-width: 300px;
        }

        .education,
        .tips {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow var(--transition-speed);
        }

        .education:hover,
        .tips:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        h2:not(#why-ai-traffic-lights) {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            margin-bottom: 1.5em;
        }

        .tip,
        .edu-item {
            margin-bottom: 15px;
            padding: 1.2em 1.5em;
            background: var(--light-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .tip.active,
        .edu-item.active {
            background: #ffffff;
            border-color: var(--primary-color);
        }

        .tip-title,
        .edu-title {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .tip-title i,
        .edu-title i {
            margin-right: 10px;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .tip-chevron,
        .edu-chevron {
            flex-shrink: 0;
            transition: transform var(--transition-speed) ease, color var(--transition-speed);
            color: #aaa;
        }

        .tip.active .tip-chevron,
        .edu-item.active .edu-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .tip-details,
        .edu-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out, opacity 0.4s ease-in-out 0.2s, padding 0.5s ease;
            padding: 0 1.5em;
            color: #555;
            font-weight: normal;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .tip-details.open,
        .edu-details.open {
            opacity: 1;
            padding: 0 1.5em 1.5em;
        }

        .community-box {
            margin: 3em 0;
            padding: 2.5em;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 2px solid var(--footer-accent);
        }

        .community-box h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .community-box h2 i {
            color: var(--footer-accent);
        }

        .community-box>p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 2em;
            line-height: 1.7;
        }

        /* === NEW: Style for the logged-out prompt === */
        #community-login-prompt {
            text-align: center;
        }

        #community-login-prompt p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 1.5em;
        }

        .community-login-btns {
            display: flex;
            justify-content: center;
            gap: 1em;
            flex-wrap: wrap;
        }

        .community-login-btns .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .community-login-btns .btn-primary {
            background: var(--primary-color);
        }

        .community-login-btns .btn-primary:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .community-login-btns .btn-secondary {
            background: #007bff;
        }

        .community-login-btns .btn-secondary:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        /* === END NEW === */


        .registration-options {
            display: flex;
            gap: 1.5em;
            /* Reduced from 2em */
            justify-content: center;
            flex-wrap: wrap;
        }

        .reg-card {
            flex: 1;
            min-width: 260px;
            /* Reduced from 280px */
            max-width: 400px;
            background: white;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .reg-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .reg-card.driver:hover {
            border-color: var(--driver-color);
        }

        .reg-card.emergency:hover {
            border-color: var(--emergency-color);
        }

        .reg-card-icon {
            font-size: 4em;
            margin-bottom: 0.5em;
        }

        .reg-card.driver .reg-card-icon {
            color: var(--driver-color);
        }

        .reg-card.emergency .reg-card-icon {
            color: var(--emergency-color);
        }

        .reg-card h3 {
            font-size: 1.5em;
            margin-bottom: 0.5em;
            color: var(--secondary-color);
        }

        .reg-card p {
            color: #666;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }

        .reg-btn {
            padding: 12px 30px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reg-btn:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .reg-card.driver .reg-btn {
            background: var(--driver-color);
        }

        .reg-card.driver .reg-btn:hover {
            background: var(--driver-hover);
        }

        /* === NEW TRAVELER CARD STYLES === */
        .reg-card.traveler:hover {
            border-color: var(--traveler-color);
            /* Blue */
        }

        .reg-card.traveler .reg-card-icon {
            color: var(--traveler-color);
        }

        .reg-card.traveler .reg-btn {
            background: var(--traveler-color);
        }

        .reg-card.traveler .reg-btn:hover {
            background: var(--traveler-hover);
        }

        /* === END TRAVELER CARD STYLES === */

        .reg-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .reg-modal-overlay.active {
            display: flex;
        }

        .reg-form-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* === NEW: Password Instructions Styles === */
        .password-instructions {
            display: block;
            /* MODIFIED: Was 'none', now always visible */
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .password-instructions h4 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .password-instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .password-instructions li {
            color: #666;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
            transition: color 0.3s ease;
        }

        .password-instructions li::before {
            content: '\f00d';
            /* fas fa-times */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .password-instructions li.valid {
            color: #333;
            text-decoration: line-through;
        }

        .password-instructions li.valid::before {
            content: '\f00c';
            /* fas fa-check */
            color: #4CAF50;
            transform: scale(1.1);
        }

        /* === END NEW === */

        /* === NEW: Hide wrappers by default === */
        #login-form-wrapper,
        #signup-form-wrapper,
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            display: none;
        }

        /* === END NEW === */


        .reg-form-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .reg-form-close:hover {
            color: var(--primary-color);
        }

        .reg-form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .reg-form-header h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }

        .reg-form-header p {
            color: #666;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: 'Open Sans', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .success-message i {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            font-size: 1.1em;
        }

        /* Styles for new registration forms */
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        /* Add traveler wrapper */
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            /* Add traveler success */
            display: none;
            /* Hidden by default */
        }

        .form-group-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-group-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
            color: #555;
        }

        .submit-btn.emergency-btn {
            background: var(--emergency-color);
        }

        .submit-btn.emergency-btn:hover:not(:disabled) {
            background: var(--emergency-hover);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .submit-btn.driver-btn {
            background: var(--driver-color);
        }

        .submit-btn.driver-btn:hover:not(:disabled) {
            background: var(--driver-hover);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        /* === NEW TRAVELER BUTTON STYLE === */
        .submit-btn.traveler-btn {
            background: var(--traveler-color);
        }

        .submit-btn.traveler-btn:hover:not(:disabled) {
            background: var(--traveler-hover);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        /* === END TRAVELER BUTTON STYLE === */

        /* === NEW MAP STYLES === */
        .map-preview-btn {
            background-color: #6c757d;
            /* A neutral gray */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
            padding: 12px;
        }

        .map-preview-btn:hover:not(:disabled) {
            background-color: #5a6268;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f4f4f4;
            border: 2px solid #ddd;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .map-api-notice {
            color: #b22222;
            /* Firebrick red */
            text-align: center;
            padding: 20px;
            font-weight: 600;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .map-api-notice i {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* === END NEW MAP STYLES === */

        /* End of new styles */


        .pledge-box {
            margin-top: 3em;
            padding: 2.5em;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        .pledge-box h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5em;
            margin-bottom: 0.8em;
            font-size: 2em;
        }

        .pledge-box p {
            margin-bottom: 1.5em;
            color: var(--text-color);
        }

        .pledge-form-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 2em;
        }

        .pledge-form-group label {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pledge-form-group input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1;
            max-width: 300px;
            transition: border-color 0.3s;
        }

        .pledge-form-group input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.5);
        }

        #generate-pledge-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
        }

        #generate-pledge-btn:hover {
            background-color: var(--hover-color);
        }

        #generate-pledge-btn:active {
            transform: scale(0.98);
        }

        .pledge-output {
            margin-top: 1.5em;
            padding: 1.5em;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            background: #ffecec;
            font-style: italic;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.6;
        }

        .pledge-output p {
            margin-bottom: 0;
        }

        .pledge-output strong {
            color: var(--secondary-color);
            font-size: 1.1em;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: auto;
            padding: 20px;
        }

        .certificate-container {
            width: 750px;
            max-width: 95%;
            background: #fff8e7;
            border: 12px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
            font-family: 'Montserrat', sans-serif;
            margin: 20px 0;
        }

        .cert-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #d4af37;
            cursor: pointer;
        }

        .certificate-logo {
            height: 80px;
            margin-bottom: 10px;
        }

        .certificate-header h2 {
            color: #b8860b;
            margin-bottom: 5px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .certificate-header p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        .certificate-body {
            margin: 20px 0;
        }

        .certificate-body blockquote {
            font-style: italic;
            margin: 20px auto;
            padding: 15px;
            border-left: 5px solid #d4af37;
            background: #fff3c2;
            border-radius: 5px;
            max-width: 600px;
            color: #555;
            font-size: 1em;
        }

        .cert-name {
            display: block;
            font-size: 1.6em;
            font-weight: 700;
            margin: 10px 0;
            color: #b8860b;
            text-transform: uppercase;
        }

        .certificate-footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .signature-img {
            height: 60px;
        }

        .certificate-date p,
        .certificate-signature p {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .cert-btn {
            background: #d4af37;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .cert-btn:hover {
            background: #b8860b;
        }

        .cert-btn i {
            margin-right: 8px;
        }

        .cert-btn.fab {
            background-color: #25D366;
        }

        .cert-btn.fab:hover {
            background-color: #128C7E;
        }

        .cert-button-group {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }

        .hero-modal-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #c0392b 100%);
            color: #fff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            font-family: 'Montserrat', sans-serif;
            border: 4px solid #fff;
        }

        #hero-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        #hero-close-btn:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        .hero-modal-content h1 {
            font-size: 2.8em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero-modal-content h2 {
            font-size: 1.5em;
            font-weight: 400;
            opacity: 0.9;
            color: #fff !important;
            border: none !important;
            margin-bottom: 0 !important;
        }

        .hero-modal-content p {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .hero-modal-content p.emphasis {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--footer-accent);
        }

        /* Simple error message style for forms */
        .form-error {
            color: var(--primary-color);
            background: #ffecec;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: none;
            /* Hidden by default */
            text-align: center;
            font-weight: 600;
        }

        /* --- NEW: Form Error for Modals --- */
        .modal-form-error {
            color: var(--primary-color);
            background: #ffecec;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            display: none;
            /* Hidden by default */
            text-align: center;
            font-weight: 600;
        }

        /* --- END NEW --- */

        /* === NEW: Circular Photo Uploader === */
        .profile-photo-uploader {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
            /* Center it */
            cursor: pointer;
            border-radius: 50%;
            background: #f0f0f0;
            border: 3px dashed #ccc;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* To keep image circular */
        }

        .profile-photo-uploader:hover {
            border-color: var(--primary-color);
            background: #e9e9e9;
        }

        .profile-photo-uploader .upload-icon {
            font-size: 3em;
            color: #aaa;
            transition: all 0.3s ease;
        }

        .profile-photo-uploader:hover .upload-icon {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .profile-photo-uploader .photo-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* This is key */
            border-radius: 50%;
            display: none;
            /* Hide by default */
        }

        .profile-photo-uploader .photo-preview.active {
            display: block;
        }

        .profile-photo-uploader .upload-icon.hidden {
            display: none;
        }

        /* === END NEW === */

        /* === NEW: File Input Styles === */
        .form-group-file label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group-file input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            background: #f9f9f9;
        }

        .form-group-file input[type="file"]::file-selector-button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .form-group-file input[type="file"]::file-selector-button:hover {
            background: #555;
        }

        /* === END NEW === */

        /* === NEW PROFILE VIEW STYLES === */
        #community-profile-view {
            border: 4px solid var(--border-color);
            border-radius: 12px;
            padding: 2em;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        /* Driver Profile = Green */
        .profile-view-driver {
            border-color: var(--driver-color) !important;
            background: var(--driver-bg) !important;
        }

        .profile-view-driver h2 i {
            color: var(--driver-color);
        }

        .profile-view-driver #community-profile-name {
            color: var(--driver-color);
        }

        /* Traveler Profile = Blue */
        .profile-view-traveler {
            border-color: var(--traveler-color) !important;
            background: var(--traveler-bg) !important;
        }

        .profile-view-traveler h2 i {
            color: var(--traveler-color);
        }

        .profile-view-traveler #community-profile-name {
            color: var(--traveler-color);
        }

        /* Emergency Profile = Red */
        .profile-view-emergency {
            border-color: var(--emergency-color) !important;
            background: var(--emergency-bg) !important;
        }

        .profile-view-emergency h2 i {
            color: var(--emergency-color);
        }

        .profile-view-emergency #community-profile-name {
            color: var(--emergency-color);
        }

        /* Default/Unknown/Guest */
        .profile-view-unknown h2 i,
        .profile-view-guest h2 i {
            color: var(--secondary-color);
        }

        .profile-view-unknown #community-profile-name,
        .profile-view-guest #community-profile-name {
            color: var(--secondary-color);
        }

        /* --- NEW: Role Action Buttons --- */
        .profile-action-buttons {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed #ccc;
        }

        .profile-view-traveler .profile-action-buttons {
            border-top-color: var(--traveler-color);
        }

        .profile-view-driver .profile-action-buttons {
            border-top-color: var(--driver-color);
        }

        .profile-view-emergency .profile-action-buttons {
            border-top-color: var(--emergency-color);
        }

        .role-actions {
            display: flex;
            /* Will be set to 'flex' by JS */
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .profile-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-btn i {
            font-size: 1.1em;
        }

        .profile-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-btn-traveler {
            background-color: var(--traveler-color);
        }

        .profile-btn-traveler:hover {
            background-color: var(--traveler-hover);
        }

        .profile-btn-driver {
            background-color: var(--driver-color);
        }

        .profile-btn-driver:hover {
            background-color: var(--driver-hover);
        }

        .profile-btn-emergency {
            background-color: var(--emergency-color);
        }

        .profile-btn-emergency:hover {
            background-color: var(--emergency-hover);
        }

        /* --- NEW: On Duty Toggle --- */
        .on-duty-toggle-container {
            display: flex;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        #on-duty-status-text {
            font-size: 1.1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        #on-duty-status-text.on-duty {
            color: var(--driver-color);
        }

        #on-duty-status-text.off-duty {
            color: #777;
        }

        .profile-view-emergency #on-duty-status-text.on-duty {
            color: var(--emergency-color);
        }

        .duty-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .duty-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .duty-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .duty-toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.duty-toggle-slider {
            background-color: var(--driver-color);
        }

        .profile-view-emergency input:checked+.duty-toggle-slider {
            background-color: var(--emergency-color);
        }

        input:checked+.duty-toggle-slider:before {
            transform: translateX(26px);
        }

        /* --- END NEW --- */

        /* === END NEW PROFILE STYLES === */

        /* === NEW STICKY FOOTER STYLES === */
        #main-footer {
            background-color: var(--dark-bg);
            color: var(--light-text);
            padding: 50px 0;
            font-family: 'Poppins', sans-serif;
            margin-top: auto;
            /* This pushes it to the bottom */
        }

        /* === END NEW STICKY FOOTER STYLES === */

        @media print {
            body>*:not(#certificate-modal) {
                display: none;
            }

            #certificate-modal {
                display: flex !important;
                background: none !important;
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }

            .certificate-container {
                box-shadow: none !important;
                border: 10px solid #d4af37 !important;
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100% !important;
                page-break-inside: avoid;
                border-radius: 0 !important;
            }

            .cert-close-btn,
            .cert-button-group {
                display: none !important;
            }

            #confetti-canvas {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-newspaper"></i> NEWS & EVENTS
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-newspaper"></i> Latest Updates</h2>
            <button class="sidebar-close" id="sidebarClose">&times;</button>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-newspaper"></i> News & Updates</h3>
            <div class="news-item">
                <img src="Photoes/report 1.png" alt="Road safety news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>Road Accident Deaths Rise by 12%</h4>
                <p>Latest government reports show a concerning increase in road fatalities across major highways.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 22, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report3.png" alt="Traffic rules update"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>New Helmet Law Enforcement</h4>
                <p>Stricter penalties announced for riding without helmets. Fine increased to ₹5,000 for repeat
                    offenders.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 18, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 4.jpg" alt="Safety campaign"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>National Road Safety Week Announced</h4>
                <p>Government launches awareness campaign with focus on drunk driving prevention and seatbelt usage.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 15, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 2 .png" alt="Technology news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>AI Traffic Signals Reduce Congestion by 30%</h4>
                <p>Pilot project in Delhi shows promising results with intelligent traffic management systems.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 10, 2025
                </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
            <div class="event-item">
                <h4>🎓 Road Safety Workshop</h4>
                <p>Free workshop for drivers on defensive driving techniques and road safety awareness.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Mph
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 5, 2025 - 10:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>🚦 Traffic Rules Seminar</h4>
                <p>Interactive session covering updated traffic laws and regulations with traffic police officials.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Amphitheater
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 12, 2025 - 3:00 PM
                </div>
            </div>
            <div class="event-item">
                <h4>🏃 Road Safety Marathon</h4>
                <p>Join the city-wide marathon to promote awareness about pedestrian safety and responsible driving.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i>cricket ground
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 20, 2025 - 6:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>👨‍👩‍👧‍👦 Family Safety Day</h4>
                <p>Fun-filled day with safety demonstrations, first-aid training, and activities for children.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Seminar Hall
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 25, 2025 - 9:00 AM
                </div>
            </div>
        </div>
    </aside>

    <nav aria-label="Main Navigation">
        <a href="#home" class="nav-title" aria-label="Home">
            <img id="website_logo" src="Photoes/logo.png" alt="SafeReturn Logo"
                onerror="this.src='https://placehold.co/40x40/ffffff/E63939?text=SR'; this.onerror=null;">
            SafeReturn
        </a>

        <ul class="nav-links">
            <li><a href="#home">Home</a></li>
            <li class="dropdown">
                <a href="#road-safety" aria-expanded="false" aria-haspopup="true">Road Safety Tips <i
                        class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="Road Safety.html">Fundamentals</a></li>
                    <li><a href="vehicles Mechanics.html">Vehicles Mechanics</a></li>
                    <li><a href="Essential Road Safety Instructions.html">Essential Road Safety Instructions</a></li>
                </ul>
            </li>
            <li><a href="Quiz.html">Quiz</a></li>
            <!-- === NEW: Women Shield Link === -->
            <li><a href="Women Shield.html" id="nav-women-shield-link" style="color: var(--accent-color);"><i
                        class="fas fa-shield-alt"></i> Women Shield</a></li>
            <!-- === END NEW === -->
            <li class="dropdown">
                <a href="#why-AI-traffic-lights" aria-expanded="false" aria-haspopup="true">Why AI Traffic Lights <i
                        class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="AI based traffic lights image.html">AI Based traffic lights</a></li>
                    <li><a href="#how-it-works">How it Works</a></li>
                    <li><a href="#benefits">Benefits</a></li>
                    <li><a href="#challenges">Challenges</a></li>
                </ul>
            </li>
            <li><a href="Collage.html">Collage</a></li>
            <li><a href="footer.html">Contact</a></li>

            <!-- === NEW AUTH LINKS === -->
            <!-- These show when logged OUT -->
            <span id="nav-auth-links" style="display: flex; gap: 1.5em; align-items: center;">
                <li><a href="#" id="nav-login-btn">Login</a></li>
                <li><a href="#" id="nav-signup-btn">Sign Up</a></li>
            </span>

            <!-- This shows when logged IN -->
            <li id="nav-user-info" class="dropdown" style="display: none; align-items: center; gap: 15px;">
                <!-- NEW: Profile Photo Circle -->
                <img id="nav-user-photo" src="https://placehold.co/40x40/ccc/eee?text=G" alt="Profile"
                    class="nav-user-photo-class">
                <!-- <a href="#" id="nav-logout-btn" style="color: #fff; background: var(--primary-color); padding: 5px 10px; border-radius: 5px;">Logout</a> -->
                <!-- OLD LOGOUT BTN - REMOVED -->

                <!-- === NEW PROFILE DROPDOWN MENU === -->
                <ul class="dropdown-menu" id="profile-dropdown-menu">
                    <li class="profile-dropdown-header">
                        <div class="icon"><i class="fas fa-user"></i></div>
                        <div class="details">
                            <h4 id="profile-dropdown-name">Guest</h4>
                            <p id="profile-dropdown-contact">Please log in</p>
                        </div>
                    </li>
                    <!-- NEW PHOTO UPLOAD OPTIONS -->
                    <li class="profile-photo-options">
                        <a href="#" id="photo-gallery-btn">
                            <i class="fas fa-images"></i>
                            <span>Add from Gallery</span>
                        </a>
                        <a href="#" id="photo-camera-btn">
                            <i class="fas fa-camera"></i>
                            <span>Click a Photo</span>
                        </a>
                    </li>
                    <!-- END NEW PHOTO UPLOAD OPTIONS -->
                    <li class="profile-menu-rating">
                        <a href="#" data-modal-target="rating-modal">
                            <i class="fas fa-star"></i>
                            <span>My Rating</span>
                            <i class="fas fa-chevron-right chevron"></i>
                        </a>
                    </li>
                    <li><a href="#" data-modal-target="help-modal"><i
                                class="fas fa-question-circle"></i><span>Help</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="payment-modal"><i
                                class="fas fa-credit-card"></i><span>Wallet</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="rides-modal"><i class="fas fa-route"></i><span>My Rides</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="safety-modal"><i
                                class="fas fa-shield-alt"></i><span>Safety</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="refer-modal"><i class="fas fa-gift"></i><span>Refer and
                                Earn</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="rewards-modal"><i class="fas fa-trophy"></i><span>My
                                Rewards</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="pass-modal"><i class="fas fa-ticket-alt"></i><span>Power
                                Pass</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li class="logout-item">
                        <!-- Moved logout button here -->
                        <a href="#" id="nav-logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
                <!-- === END NEW MENU === -->
            </li>
        </ul>
    </nav>

    <header id="home">
        <main>
            <h1>Drive Smart. Stay Safe.</h1>
            <p>Your journey is precious. Awareness is your best defense.</p>
            <figure>
                <blockquote>"The only thing we need from your trip is your safe return."</blockquote>
            </figure>
        </main>
    </header>

    <main class="content">
        <div class="flex-cards">
            <article class="education" id="education">
                <h2><i class="fas fa-book-open"></i> Safety Education</h2>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-car-crash"></i> Understanding Blind Spots</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>A blind spot is an area around a vehicle that the driver cannot see through their mirrors or by
                        looking directly. These hidden zones can exist on both sides of the car, behind it, and
                        sometimes even in front of large vehicles like trucks and buses. Blind spots are dangerous
                        because another vehicle, a cyclist, or a pedestrian can be present without the driver realizing
                        it. Many crashes happen when drivers change lanes or turn without checking these areas properly.
                        To stay safe, drivers should always adjust their mirrors correctly, look over their shoulder
                        before switching lanes, and be extra careful around heavy vehicles, which have much bigger blind
                        spots. Road users like cyclists and pedestrians should also avoid staying close to the sides of
                        large vehicles. Understanding blind spots helps everyone share the road more safely and prevent
                        accidents.</p>
                </div>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-road"></i> Hydroplaning Explained</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>Hydroplaning (or aquaplaning) happens when a vehicle’s tires lose contact with the road due to a
                        layer of water between the tire and the surface. This causes the vehicle to “float” on water,
                        reducing the driver’s ability to steer, brake, or control speed. Hydroplaning usually occurs at
                        higher speeds on wet roads, especially when tires are worn-out or water on the road is deep. To
                        prevent hydroplaning, drivers should slow down during rain, maintain proper tire pressure, avoid
                        sudden turns or braking, and stay away from areas where water collects.</p>
                </div>
            </article>

            <article class="tips" id="tips">
                <h2><i class="fas fa-lightbulb"></i> Top Safety Tips</h2>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-mobile-alt"></i> Avoid Distractions</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Avoiding distractions while driving is essential for road safety. Drivers should keep their
                        phones away, avoid multitasking like eating or adjusting controls while the vehicle is moving,
                        and set up mirrors, navigation, and music before starting the journey. Passengers, children, or
                        pets should be managed so they do not divert the driver’s attention. If phone use or any other
                        task becomes necessary, it is always safer to pull over first. Even a moment of distraction can
                        lead to a serious crash, so staying focused on the road is the key to preventing accidents.</p>
                </div>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-tachometer-alt"></i> Watch Your Speed</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Controlling your speed is one of the most important aspects of safe driving. Driving too fast
                        reduces your reaction time and increases the distance your vehicle travels before you can
                        stop—this means hazards that you might otherwise avoid become much more dangerous. Roads vary in
                        surface, condition, and layout, so even the posted speed limit may be too fast under certain
                        conditions like rain, fog, heavy traffic, or when sharing the road with pedestrians and
                        cyclists. Always adjust your speed to suit the conditions, anticipate hazards ahead, and
                        maintain safe following distance. By doing so, you give yourself a better chance to respond
                        safely and avoid serious accidents.</p>
                </div>
            </article>
        </div>

        <!-- 
            FIX: REMOVED DUPLICATE COMMUNITY SECTION. 
            The section below is the correct, complete one.
        -->

        <section class="community-box" id="community">

            <!-- View 1: Logged OUT (NEW) -->
            <div id="community-login-prompt">
                <h2><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p>Register or log in to get localized alerts, contribute to safer roads, and access community features.
                </p>
                <div class="community-login-btns">
                    <button id="community-signup-btn" class="btn btn-primary"
                        onclick="document.getElementById('nav-signup-btn').click();">Sign Up Now</button>
                    <button id="community-login-btn" class="btn btn-secondary"
                        onclick="document.getElementById('nav-login-btn').click();">Login</button>
                </div>
            </div>

            <!-- View 2: Logged IN, No Role Selected (MOVED) -->
            <div id="community-register-view" style="display: none;">
                <h2 id="community-register-title"><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p id="community-register-subtitle">Register as a community driver or an emergency responder to get
                    localized alerts and contribute to safer
                    roads for everyone.</p>
                <div class="registration-options">
                    <div class="reg-card driver" data-form-type="driver">
                        <div class="reg-card-icon"><i class="fas fa-car"></i></div>
                        <h3>Driver Registration</h3>
                        <p>Get alerts on road conditions, accidents, and construction in your area. Report hazards and
                            help
                            others.</p>
                        <button class="reg-btn">Register as Driver</button>
                    </div>

                    <!-- === NEW TRAVELER CARD === -->
                    <div class="reg-card traveler" data-form-type="traveler">
                        <div class="reg-card-icon"><i class="fas fa-user-plus"></i></div>
                        <h3>Community Registration</h3>
                        <p>Register as a traveler to book cabs, bikes, and other registered vehicles from our community.
                        </p>
                        <button class="reg-btn">Register as Traveler</button>
                    </div>
                    <!-- === END NEW TRAVELER CARD === -->

                    <div class="reg-card emergency" data-form-type="emergency">
                        <div class="reg-card-icon"><i class="fas fa-first-aid"></i></div>
                        <h3>Emergency Services</h3>
                        <p>Register your service to get priority access to AI-optimized routes and real-time incident
                            data.
                        </p>
                        <button class="reg-btn">Register Service</button>
                    </div>
                </div>
            </div> <!-- End register view -->

            <!-- View 3: Logged IN, Role Selected (MOVED) -->
            <div id="community-profile-view" style="display: none;"> <!-- Class will be added by JS -->
                <h2><i class="fas fa-user-check"></i> Welcome to the Community!</h2>
                <p style="font-size: 1.2em;">You are logged in as: <strong id="community-profile-name"></strong></p>

                <!-- === NEW: On Duty Toggle === -->
                <div id="on-duty-toggle-container" class="on-duty-toggle-container" style="display: none;">
                    <span id="on-duty-status-text" class="off-duty">Off Duty</span>
                    <label class="duty-toggle">
                        <input type="checkbox" id="on-duty-toggle">
                        <span class="duty-toggle-slider"></span>
                    </label>
                </div>
                <!-- === END NEW === -->

                <!-- === NEW: Role Action Buttons === -->
                <div class="profile-action-buttons">
                    <!-- Traveler Buttons -->
                    <div id="traveler-actions" class="role-actions" style="display: none;">
                        <button id="book-my-ride-btn" class="profile-btn profile-btn-traveler">
                            <i class="fas fa-taxi"></i> Book My Ride
                        </button>
                    </div>
                    <!-- Driver Buttons -->
                    <div id="driver-actions" class="role-actions" style="display: none;">
                        <button id="view-ride-requests-btn" class="profile-btn profile-btn-driver">
                            <i class="fas fa-list-alt"></i> View Ride Requests
                        </button>
                    </div>
                    <!-- Emergency Buttons -->
                    <div id="emergency-actions" class="role-actions" style="display: none;">
                        <button id="view-active-alerts-btn" class="profile-btn profile-btn-emergency">
                            <i class="fas fa-exclamation-triangle"></i> View Active Alerts
                        </button>
                        <button id="get-priority-route-btn" class="profile-btn profile-btn-emergency"
                            style="background-color: #555;">
                            <i class="fas fa-route"></i> Get Priority Route
                        </button>
                    </div>
                </div>
                <!-- === END NEW === -->
            </div>
        </section>


        <section class="pledge-box" id="pledge">
            <h2><i class="fas fa-hands-helping"></i> Take the Road Safety Pledge</h2>
            <p>Enter your name below and commit to safer roads for everyone. Let's drive responsibly!</p>
            <div class="pledge-form-group">
                <label for="pledge-name">Your Name:</label>
                <input type="text" id="pledge-name" placeholder="Eg : vivek yadav "
                    aria-label="Enter your name for the pledge">
                <button id="generate-pledge-btn" aria-label="Generate my road safety pledge">Generate Pledge</button>
            </div>
            <div id="pledge-output" class="pledge-output">
                <p>
                    <strong>This pledge is not just a promise,</strong>
                    It is a movement</em> —<br>
                    a movement that begins with one responsible citizen…<br>
                    <strong>And Today</strong>, that responsible citizen is <strong><em>YOU</em>.</strong><br>
                    <strong>Your decision</strong> can influence others,<br>
                    <em>Your voice</em> can inspire change,<br>
                    and <strong><em>Your action</em> can save lives.</strong>
                </p>
            </div>
        </section>

    </main>

    <!-- Hidden File Inputs for Profile Photo -->
    <input type="file" id="photo-gallery-input" accept="image/*" style="display: none;">
    <input type="file" id="photo-camera-input" accept="image/*" capture="user" style="display: none;">

    <!-- === NEW: Custom Alert Modal === -->
    <div id="custom-alert-modal" class="profile-modal-overlay" style="z-index: 10001;"> <!-- Highest z-index -->
        <div class="profile-modal-content" style="max-width: 400px; text-align: center;">
            <span class="profile-modal-close">&times;</span>
            <div id="custom-alert-icon" style="font-size: 3em; margin-bottom: 15px;">
                <!-- Icon will be set by JS -->
            </div>
            <h3 id="custom-alert-title" style="font-size: 1.5em; color: var(--secondary-color); margin-bottom: 10px;">
            </h3>
            <p id="custom-alert-message" style="font-size: 1em; color: #555; line-height: 1.6;"></p>
            <button id="custom-alert-close-btn" class="submit-btn" style="margin-top: 20px;">OK</button>
        </div>
    </div>
    <!-- === END Custom Alert Modal === -->


    <!-- 
        FIX: The broken HTML fragment that was here has been removed.
        The block below is the correct, functioning modal.
    -->
    <div class="reg-modal-overlay" id="reg-modal">
        <div class="reg-form-container">
            <span class="reg-form-close">&times;</span>

            <!-- === LOGIN FORM === -->
            <div id="login-form-wrapper">
                <div class="reg-form-header">
                    <h2>Community Login</h2>
                    <p>Welcome back! Sign in to access your account.</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="loginEmail" name="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i>Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required>
                    </div>
                    <div id="login-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: #007bff;">Login</button>
                </form>
            </div>

            <!-- === NEW SIGNUP FORM === -->
            <div id="signup-form-wrapper">
                <div class="reg-form-header">
                    <h2>Create Your Account</h2>
                    <p>Sign up to join the community. It's fast and free.</p>
                </div>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signupEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="signupEmail" name="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword"><i class="fas fa-lock"></i>Password</label>
                        <!-- MODIFIED: Removed text -->
                        <input type="password" id="signupPassword" name="signupPassword" required minlength="8">
                        <!-- MODIFIED: minlength 8 -->

                        <!-- NEW: Password Instructions -->
                        <div id="password-instructions" class="password-instructions">
                            <h4>Password must contain:</h4>
                            <ul>
                                <li id="pass-length">At least 8 characters</li>
                                <li id="pass-lower">At least one lowercase letter (a-z)</li>
                                <li id="pass-upper">At least one uppercase letter (A-Z)</li>
                                <li id="pass-number">At least one number (0-9)</li>
                                <li id="pass-special">At least one special character (!, @, #, etc.)</li>
                            </ul>
                        </div>
                        <!-- END NEW -->

                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword"><i class="fas fa-check-circle"></i>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" name="signupConfirmPassword" required
                            minlength="8"> <!-- MODIFIED: minlength 8 -->
                    </div>
                    <div id="signup-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: var(--primary-color);">Create
                        Account</button>
                </form>
            </div>

            <!-- === DRIVER REGISTRATION FORM (Role Completion) === -->
            <div id="driver-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-driver">Complete Driver Profile</h2>
                    <p id="reg-form-subtitle-driver">Please provide your driver and vehicle details.</p>
                </div>
                <form id="driver-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="driver-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="driver-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="driver-photo-preview">
                    </div>
                    <input type="file" id="driver-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="driverName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="driverName" name="driverName" required>
                    </div>
                    <div class="form-group">
                        <label for="driverPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="driverPhone" name="driverPhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="driver-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="driverGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleType"><i class="fas fa-car-side"></i>Vehicle Type</label>
                            <select id="vehicleType" name="vehicleType">
                                <option value="car">Car</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="truck">Truck</option>
                                <option value="bus">Bus</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="licensePlate"><i class="fas fa-id-card"></i>License Plate</label>
                            <input type="text" id="licensePlate" name="licensePlate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleMake"><i class="fas fa-industry"></i>Vehicle Make</label>
                            <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., Toyota">
                        </div>
                        <div class="form-group">
                            <label for="vehicleModel"><i class="fas fa-car"></i>Vehicle Model</label>
                            <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., Camry">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Trip Details</h3>
                    <div class="form-group">
                        <label for="baseLocation"><i class="fas fa-map-marker-alt"></i>Base Location / City</label>
                        <!-- <-- MODIFIED -->
                        <input type="text" id="baseLocation" name="baseLocation" <!-- <-- MODIFIED -->
                        placeholder="e.g., Gurugram"> <!-- <-- MODIFIED -->
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewDriverMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="driver-map-container" class="map-container" style="display: none;"></div>

                    <div id="driver-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn">Register Driver</button>
                </form>
            </div>

            <!-- === TRAVELER REGISTRATION FORM (Role Completion) === -->
            <div id="traveler-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-traveler">Complete Traveler Profile</h2>
                    <p id="reg-form-subtitle-traveler">Tell us a bit about yourself.</p>
                </div>
                <form id="traveler-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="traveler-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="traveler-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="traveler-photo-preview">
                    </div>
                    <input type="file" id="traveler-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="travelerName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="travelerName" name="travelerName" required>
                    </div>
                    <div class="form-group">
                        <label for="travelerPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="travelerPhone" name="travelerPhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="traveler-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="travelerGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->
                    <div class="form-group">
                        <label for="travelerLocation"><i class="fas fa-map-marker-alt"></i>Default Pickup Location
                            (Optional)</label>
                        <input type="text" id="travelerLocation" name="travelerLocation"
                            placeholder="Enter your home or work address">
                    </div>

                    <div id="traveler-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn traveler-btn">Register as Traveler</button>
                </form>
            </div>
            <!-- === END TRAVELER REGISTRATION FORM === -->

            <!-- === EMERGENCY REGISTRATION FORM (Role Completion) === -->
            <div id="emergency-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-emergency">Complete Service Profile</h2>
                    <p id="reg-form-subtitle-emergency">Register your service for priority routing.</p>
                </div>
                <form id="emergency-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="emergency-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="emergency-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="emergency-photo-preview">
                    </div>
                    <input type="file" id="emergency-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Service Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceType"><i class="fas fa-briefcase-medical"></i>Service Type</label>
                            <select id="serviceType" name="serviceType">
                                <option value="ambulance">Ambulance</option>
                                <option value="police">Police</option>
                                <option value="fire">Fire Dept.</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceId"><i class="fas fa-id-badge"></i>Service ID / Unit No.</label>
                            <input type="text" id="serviceId" name="serviceId" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="serviceName"><i class="fas fa-user-md"></i>Operator Name</label>
                        <input type="text" id="serviceName" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label for="servicePhone"><i class="fas fa-phone-alt"></i>Dispatch Phone</label>
                        <input type="tel" id="servicePhone" name="servicePhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="emergency-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="emergencyGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceVehicleId"><i class="fas fa-car"></i>Vehicle ID / Plate</label>
                            <input type="text" id="serviceVehicleId" name="serviceVehicleId" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceVehicleType"><i class="fas fa-ambulance"></i>Vehicle Type</label>
                            <input type="text" id="serviceVehicleType" name="serviceVehicleType"
                                placeholder="e.g., Type II Ambulance">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Routing Details</h3>
                    <div class="form-group">
                        <label for="baseLocation"><i class="fas fa-map-marked-alt"></i>Base Location / City</label>
                        <!-- <-- MODIFIED -->
                        <input type="text" id="baseLocation" name="baseLocation" <!-- <-- MODIFIED -->
                        placeholder="e.g., Gurugram"> <!-- <-- MODIFIED -->
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewEmergencyMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="emergency-map-container" class="map-container" style="display: none;"></div>

                    <div class="form-group-checkbox">
                        <input type="checkbox" id="bestRoute" name="bestRoute">
                        <label for="bestRoute">Give best possible route option</label>
                    </div>

                    <div id="emergency-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn emergency-btn">Register Service</button>
                </form>
            </div>

            <!-- === SUCCESS MESSAGES === -->
            <div class="success-message" id="driver-success-message">
                <i class="fas fa-check-circle"></i>
                <h3>Registration Successful!</h3>
                <p>Thank you for joining the driver community.</p>
            </div>
            <div class="success-message" id="emergency-success-message">
                <i class="fas fa-check-circle" style="color: var(--primary-color);"></i>
                <h3>Service Registered!</h3>
                <p>Your unit is now active. Thank you for your service.</p>
            </div>

            <!-- === TRAVELER SUCCESS MESSAGE === -->
            <div class="success-message" id="traveler-success-message">
                <i class="fas fa-check-circle" style="color: #007bff;"></i>
                <h3>Welcome to the Community!</h3>
                <p>You can now book rides from registered community vehicles.</p>
            </div>
            <!-- === END TRAVELER SUCCESS MESSAGE === -->

        </div>
    </div>

    <!-- === NEW: Profile Modals === -->

    <!-- My Rating Modal -->
    <div id="rating-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>

            <!-- Rating Content -->
            <div id="rating-content">
                <h2><i class="fas fa-star"></i> Rate Your Experience</h2>
                <p>We value your feedback. Please rate your experience with safe return and leave a comment below.</p>

                <div class="star-rating-container" data-rating="0">
                    <span class="star" data-value="1"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="2"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="3"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="4"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="5"><i class="fas fa-star"></i></span>
                </div>

                <textarea id="review-comment" class="review-textarea"
                    placeholder="Write your review here... (optional)"></textarea>

                <button id="submit-review-btn" class="submit-review-btn">Submit Review</button>
            </div>

            <!-- Success Message -->
            <div id="rating-success-message" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>Thank You!</h3>
                <p>Your feedback has been submitted.</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-question-circle"></i> Help & Support</h2>
            <p>Welcome to our support center. Find answers to common questions below or contact us directly for
                assistance.</p>

            <!-- NEW: FAQ Accordion -->
            <div class="faq-accordion">
                <!-- FAQ 1 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How do I reset my password?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>To reset your password, please log out, click "Sign In" on the main page, and then look for a
                            "Forgot Password?" link on the sign-in form. (Note: This link is not yet implemented, but
                            this is where it would be.)</I></p>
                    </div>
                </div>

                <!-- FAQ 2 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How does community registration work?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>First, you must "Create Account" with your email and password. After you are logged in, the
                            "Join Our Safety Community" section on the main page will allow you to select a role
                            (Driver, Traveler, or Emergency) and complete your profile.</p>
                    </div>
                </div>

                <!-- FAQ 3 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How do I report a road hazard?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>Once you are registered as a "Driver," a "Report Hazard" button will become available on your
                            community dashboard. This feature allows you to report accidents, construction, or other
                            dangers in real-time. (This feature is coming soon!)</p>
                    </div>
                </div>

                <!-- FAQ 4 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>Contact Us</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>For any technical issues or support requests not covered here, please email our team directly
                            at <a href="mailto:support@safereturn.com">support@safereturn.com</a>.</p>
                    </div>
                </div>
            </div>
            <!-- END NEW FAQ -->

        </div>
    </div>



    <!-- Payment Modal -->
    <div id="payment-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-wallet"></i> Wallet</h2>

            <div class="wallet-balance">
                <p>Current Balance</p>
                <h3>₹0.00</h3>
                <button id="show-add-money-btn" class="add-money-btn"><i class="fas fa-plus-circle"></i> Add
                    Money</button>
            </div>

            <div id="add-money-section">
                <div class="form-group">
                    <label for="add-money-amount">Enter Amount (₹)</label>
                    <input type="number" id="add-money-amount" placeholder="e.g., 500">
                </div>
                <button id="confirm-add-money-btn" class="submit-btn driver-btn" style="background: #4CAF50;">Proceed to
                    Pay</button>
            </div>

            <h4>Saved Payment Methods</h4>
            <div class="saved-payment-method">
                <div class="icon"><i class="fab fa-cc-visa"></i></div>
                <div class="details">
                    <p>Visa .... 4242</p>
                    <span>Expires 12/26</span>
                </div>
                <button class="remove-btn"><i class="fas fa-trash"></i> Remove</button>
            </div>
            <div class="saved-payment-method">
                <div class="icon" style="color: #5abf2e;"><i class="fas fa-mobile-alt"></i></div>
                <div class="details">
                    <p>UPI</p>
                    <span>vivek@okbank</span>
                </div>
                <button class="remove-btn"><i class="fas fa-trash"></i> Remove</button>
            </div>

        </div>
    </div>

    <!-- My Rides Modal -->
    <div id="rides-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-route"></i> My Rides</h2>
            <p>Here is a history of your recent rides with SafeReturn community drivers.</p>

            <ul class="ride-history-list">
                <!-- Static content removed, will be populated by JS -->
                <li>
                    <p>Loading ride history...</p>
                </li>
            </ul>
        </div>
    </div>

    <!-- Safety Modal -->
    <div id="safety-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-shield-alt"></i> Safety Center</h2>
            <p>Your safety is our priority. Use these tools in case of an emergency or to share your trip details.</p>

            <div class="safety-features">
                <button class="safety-feature-btn share-btn" id="share-ride-btn">
                    <i class="fas fa-share-alt"></i>
                    <span>Share My Ride</span>
                </button>
                <button class="safety-feature-btn sos-btn" id="sos-btn">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Emergency SOS</span>
                </button>
            </div>

            <h4
                style="font-family: 'Montserrat', sans-serif; color: var(--secondary-color); font-size: 1.2em; margin-top: 30px; margin-bottom: 15px;">
                Safety Tips:</h4>
            <ul class="safety-tips-list">
                <li><i class="fas fa-check-circle"></i> Always verify the driver's name and vehicle license plate.</li>
                <li><i class="fas fa-check-circle"></i> Wear your seatbelt at all times.</li>
                <li><i class="fas fa-check-circle"></i> Share your trip status with a trusted contact.</li>
                <li><i class="fas fa-check-circle"></i> Avoid sharing personal information with the driver.</li>
            </ul>
        </div>
    </div>

    <!-- Refer and Earn Modal -->
    <div id="refer-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-gift"></i> Refer and Earn</h2>
            <p>Share your code with friends. When they sign up, you both get a reward!</p>

            <div class="referral-code-box">
                <input type="text" id="referral-code" value="LOGIN-TO-SEE-CODE" readonly>
                <button id="referral-copy-btn"><i class="fas fa-copy"></i></button>
            </div>

            <div class="social-share-buttons">
                <a href="#" class="social-share-btn whatsapp" id="share-whatsapp"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="social-share-btn twitter" id="share-twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="social-share-btn facebook" id="share-facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-share-btn sms" id="share-sms"><i class="fas fa-comment-dots"></i></a>
            </div>
        </div>
    </div>

    <!-- My Rewards Modal -->
    <div id="rewards-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-trophy"></i> My Rewards</h2>
            <p>Here are your available coupons and rewards. Click "Claim" to use them.</p>

            <ul class="rewards-list">
                <!-- Static content removed, will be populated by JS -->
                <li>
                    <p>Loading rewards...</p>
                </li>
            </ul>
        </div>
    </div>

    <!-- Power Pass Modal -->
    <div id="pass-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-ticket-alt"></i> Power Pass</h2>
            <p>This section will contain information about subscription passes for rides or services. (Content to be
                built)</p>
        </div>
    </div>

    <!-- === NEW: ROLE-SPECIFIC MODALS === -->

    <!-- 1. Book a Ride Modal (Traveler) -->
    <div id="book-ride-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-taxi"></i> Book a Ride</h2>
            <p>Find a safe ride from our community of registered drivers.</p>
            <form id="book-ride-form" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="pickup-location"><i class="fas fa-map-marker-alt"></i> From:</label>
                    <input type="text" id="pickup-location" name="pickup-location" placeholder="Enter pickup location"
                        required>
                </div>
                <div class="form-group">
                    <label for="dropoff-location"><i class="fas fa-map-pin"></i> To:</label>
                    <input type="text" id="dropoff-location" name="dropoff-location" placeholder="Enter destination"
                        required>
                </div>
                <div class="form-group">
                    <label for="ride-vehicle-type"><i class="fas fa-car-side"></i> Vehicle Type:</label>
                    <select id="ride-vehicle-type" name="ride-vehicle-type">
                        <option value="any">Any</option>
                        <option value="car">Car</option>
                        <option value="motorcycle">Motorcycle</option>
                    </select>
                </div>
                <div id="book-ride-error" class="modal-form-error"></div>
                <button type="submit" class="submit-btn traveler-btn">Find My Ride</button>
            </form>
        </div>
    </div>

    <!-- 2. Ride Requests Modal (Driver) -->
    <div id="ride-requests-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-list-alt"></i> Ride Requests</h2>
            <p>Available ride requests from travelers. New requests will appear here.</p>
            <ul id="ride-requests-list" class="modal-list">
                <!-- Populated by JS -->
                <li>
                    <p>Loading requests...</p>
                </li>
            </ul>
        </div>
    </div>

    <!-- 3. Active Alerts Modal (Emergency) -->
    <div id="active-alerts-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> Active Alerts</h2>
            <p>Real-time alerts reported by community members and drivers.</p>
            <ul id="active-alerts-list" class="modal-list">
                <!-- Populated by JS -->
                <li>
                    <p>Loading alerts...</p>
                </li>
            </ul>
        </div>
    </div>

    <!-- 4. Priority Route Modal (Emergency) -->
    <div id="priority-route-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-route"></i> Priority Route</h2>
            <p>Get an AI-optimized route for your emergency vehicle.</p>
            <form id="priority-route-form" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="incident-location"><i class="fas fa-map-marker-alt"></i> From (Your Location):</label>
                    <input type="text" id="incident-location" name="incident-location" placeholder="e.g., City Hospital"
                        required>
                </div>
                <div class="form-group">
                    <label for="incident-destination"><i class="fas fa-map-pin"></i> To (Incident Location):</label>
                    <input type="text" id="incident-destination" name="incident-destination"
                        placeholder="Enter incident address" required>
                </div>
                <div id="priority-route-error" class="modal-form-error"></div>
                <button type="submit" class="submit-btn emergency-btn">Generate Route</button>
            </form>
        </div>
    </div>

    <!-- === END NEW ROLE-SPECIFIC MODALS === -->

    <!-- === END NEW Profile Modals === -->


    <!-- THIS IS THE CERTIFICATE CODE YOU PROVIDED -->
    <div id="certificate-modal" class="modal-overlay">
        <div class="certificate-container">
            <span id="cert-close-btn" class="cert-close-btn">&times;</span>
            <div class="certificate-header">
                <img src="Photoes/logo.png" class="certificate-logo" alt="SafeReturn Logo"
                    onerror="this.src='https://placehold.co/80x80/ffffff/E63939?text=SR'; this.onerror=null;">
                <h2 id="certificate-title">Certificate of Road Safety</h2>
                <p>For a steadfast commitment to responsible driving</p>
            </div>
            <div class="certificate-body">
                <p>This certificate is proudly presented to:</p>
                <span id="cert-name" class="cert-name">[Your Name Here]</span>
                <p>for pledging to be a responsible road user:</p>
                <blockquote>
                    "I commit to never drive distracted, to always follow traffic laws, and to prioritize the safety of
                    myself and others."
                </blockquote>
            </div>
            <div class="certificate-footer">
                <div class="certificate-signature">
                    <img src="Photoes/signature.png" class="signature-img" alt="Signature"
                        onerror="this.src='https://placehold.co/150x60/333333/ffffff?text=Signature'; this.onerror=null;">
                    <p>The SafeReturn Team</p>
                </div>
                <div class="certificate-date">
                    <p>Date: <span id="current-date"></span></p>
                </div>
            </div>
            <div class="cert-button-group">
                <button id="cert-print-btn" class="cert-btn"><i class="fas fa-print"></i> Print</button>
                <button id="cert-pdf-btn" class="cert-btn"><i class="fas fa-file-pdf"></i> Download PDF</button>
                <a id="cert-whatsapp" target="_blank" class="cert-btn fab fa-whatsapp"><i class="fab fa-whatsapp"></i>
                    Share
                    WhatsApp</a>
            </div>
        </div>
        <canvas id="confetti-canvas"></canvas>
    </div>

    <div id="hero-modal" class="modal-overlay">
        <div class="hero-modal-content">
            <span id="hero-close-btn">&times;</span>
            <h2>We are proud to call you a:</h2>
            <h1>ROAD SAFETY HERO</h1>
            <p>A defender of lives.</p>
            <p>A protector of families.</p>
            <!-- 
                FIX 1: This block of JS was here, causing a syntax error.
                It has been MOVED to the main <script> tag below.
            -->
        </div>
    </div>


    <script>
        // --- FIX: This script block needs to be *outside* the <script type="module"> block ---
        // --- but *inside* a DOMContentLoaded listener ---

        // --- Google Maps API Key ---
        // API Key provided by the user.
        const GOOGLE_MAPS_API_KEY = "AIzaSyAArI6WKeTuv8LlDzhKEJl4sGc3s4rKRE8";

        document.addEventListener('DOMContentLoaded', () => {

            // --- FIX 1: This logic was moved from the hero-modal div ---
            // --- NEW PROFILE MENU CLICK LOGIC ---
            const profileMenuTrigger = document.getElementById('nav-user-info');
            const profileMenu = document.getElementById('profile-dropdown-menu');

            if (profileMenuTrigger && profileMenu) {
                profileMenuTrigger.addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop click from bubbling to the document
                    profileMenu.classList.toggle('active');
                });
            }

            // Listener to close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (profileMenu && profileMenu.classList.contains('active')) {
                    // Check if the click was outside the menu AND outside the trigger
                    if (!profileMenu.contains(e.target) && !profileMenuTrigger.contains(e.target)) {
                        profileMenu.classList.remove('active');
                    }
                }
            });
            // --- END NEW PROFILE MENU CLICK LOGIC ---
            // --- END FIX 1 ---

            // --- NEW: Custom Alert Modal Logic ---
            const alertModal = document.getElementById('custom-alert-modal');
            const alertIcon = document.getElementById('custom-alert-icon');
            const alertTitle = document.getElementById('custom-alert-title');
            const alertMessage = document.getElementById('custom-alert-message');
            const alertClose = alertModal.querySelector('.profile-modal-close');
            const alertCloseBtn = document.getElementById('custom-alert-close-btn');

            const showAlert = (title, message, icon = 'info') => {
                if (!alertModal) return; // Safety check

                alertTitle.textContent = title;
                alertMessage.innerHTML = message; // Use innerHTML to allow simple line breaks

                // Set icon
                if (icon === 'success') {
                    alertIcon.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i>';
                } else if (icon === 'warning') {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i>';
                } else if (icon === 'error') {
                    alertIcon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--primary-color);"></i>';
                } else {
                    alertIcon.innerHTML = '<i class="fas fa-info-circle" style="color: #007bff;"></i>';
                }

                alertModal.classList.add('active');
            };

            // --- NEW: Make showAlert global ---
            window.showAlert = showAlert;

            const closeAlertModal = () => {
                if (alertModal) alertModal.classList.remove('active');
            };

            if (alertClose) alertClose.addEventListener('click', closeAlertModal);
            if (alertCloseBtn) alertCloseBtn.addEventListener('click', closeAlertModal);
            // --- END Custom Alert Modal Logic ---


            // --- NEW: Photo Upload Logic ---
            const galleryBtn = document.getElementById('photo-gallery-btn');
            const cameraBtn = document.getElementById('photo-camera-btn');
            const galleryInput = document.getElementById('photo-gallery-input');
            const cameraInput = document.getElementById('photo-camera-input');
            const navUserPhotoEl = document.getElementById('nav-user-photo');

            if (galleryBtn) {
                galleryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (galleryInput) galleryInput.click();
                });
            }

            if (cameraBtn) {
                cameraBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (cameraInput) cameraInput.click();
                });
            }

            const handlePhotoUpload = (file) => {
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    showAlert('Invalid File', 'Please select an image file.', 'warning');
                    return;
                }

                // Use the globally set instances
                if (!window.currentUserId || !window.storage || !window.db || !window.fs) {
                    showAlert('Not Logged In', 'You must be logged in to change your photo.', 'error');
                    return;
                }

                // Close the profile dropdown
                const profileMenu = document.getElementById('profile-dropdown-menu');
                if (profileMenu) profileMenu.classList.remove('active');

                showAlert('Uploading...', 'Your photo is being uploaded. Please wait.', 'info');

                const userId = window.currentUserId;
                const appId = window.appId;
                // Use window.fs.storage_ref
                const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                let fileDownloadURL = ''; // Variable to hold the URL

                // Use window.fs.uploadBytes
                window.fs.uploadBytes(photoRef, file)
                    .then(snapshot => {
                        // Use window.fs.getDownloadURL
                        return window.fs.getDownloadURL(snapshot.ref);
                    })
                    .then(downloadURL => {
                        fileDownloadURL = downloadURL; // Store URL
                        // Update Firestore
                        // Use window.fs.doc
                        const userDocRef = window.fs.doc(window.db, 'artifacts', appId, 'users', userId);
                        // Use window.fs.updateDoc
                        return window.fs.updateDoc(userDocRef, {
                            photoUrl: fileDownloadURL
                        });
                    })
                    .then(() => {
                        // Update UI
                        if (navUserPhotoEl) {
                            navUserPhotoEl.src = fileDownloadURL; // Use stored URL
                        }
                        // Update global data
                        if (window.currentUserData) {
                            window.currentUserData.photoUrl = fileDownloadURL;
                        }

                        showAlert('Success', 'Profile photo updated!', 'success');
                    })
                    .catch(error => {
                        console.error("Photo upload error:", error);
                        showAlert('Upload Failed', `Error: ${error.message}`, 'error');
                    });
            };

            if (galleryInput) {
                galleryInput.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files[0]);
                    e.target.value = null; // Reset input
                });
            }

            if (cameraInput) {
                cameraInput.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files[0]);
                    e.target.value = null; // Reset input
                });
            }
            // --- END Photo Upload Logic ---


            // --- NEW: Circular Photo Uploader Logic ---
            const setupPhotoUploader = (portId, inputId, previewId, iconId, fileStore) => {
                const port = document.getElementById(portId);
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const icon = document.getElementById(iconId);

                if (!port || !input || !preview || !icon) return;

                port.addEventListener('click', () => input.click());

                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.add('active');
                            icon.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);

                        // Store the file object
                        if (fileStore === 'driver') window.driverPhotoFile = file;
                        if (fileStore === 'traveler') window.travelerPhotoFile = file;
                        if (fileStore === 'emergency') window.emergencyPhotoFile = file;

                    } else {
                        // Reset
                        preview.src = '#';
                        preview.classList.remove('active');
                        icon.classList.remove('hidden');
                        if (fileStore === 'driver') window.driverPhotoFile = null;
                        if (fileStore === 'traveler') window.travelerPhotoFile = null;
                        if (fileStore === 'emergency') window.emergencyPhotoFile = null;
                    }
                    // Clear the input value to allow re-uploading the same file
                    e.target.value = null;
                });
            };

            setupPhotoUploader('driver-photo-uploader-port', 'driver-photo-input-hidden', 'driver-photo-preview', 'driver-photo-icon', 'driver');
            setupPhotoUploader('traveler-photo-uploader-port', 'traveler-photo-input-hidden', 'traveler-photo-preview', 'traveler-photo-icon', 'traveler');
            setupPhotoUploader('emergency-photo-uploader-port', 'emergency-photo-input-hidden', 'emergency-photo-preview', 'emergency-photo-icon', 'emergency');
            // --- END NEW ---


            // --- Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            const toggleSidebar = () => {
                if (sidebar) sidebar.classList.toggle('active');
                if (sidebarOverlay) sidebarOverlay.classList.toggle('active');
            };

            if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
            if (sidebarClose) sidebarClose.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            // --- NEW: Password Validation UI Logic ---
            const signupPasswordInput = document.getElementById('signupPassword');
            const passwordInstructions = document.getElementById('password-instructions');

            if (signupPasswordInput && passwordInstructions) {
                const passLength = document.getElementById('pass-length');
                const passLower = document.getElementById('pass-lower'); // MODIFIED
                const passUpper = document.getElementById('pass-upper'); // MODIFIED
                const passNumber = document.getElementById('pass-number');
                const passSpecial = document.getElementById('pass-special');

                // Show instructions on focus - REMOVED
                // signupPasswordInput.addEventListener('focus', () => {
                //     passwordInstructions.style.display = 'block';
                // });

                // Hide instructions on blur (optional, you might want to keep it visible)
                // signupPasswordInput.addEventListener('blur', () => {
                //     passwordInstructions.style.display = 'none';
                // });

                // Validate as user types
                signupPasswordInput.addEventListener('input', () => {
                    const password = signupPasswordInput.value;

                    // Check length
                    if (password.length >= 8) {
                        passLength.classList.add('valid');
                    } else {
                        passLength.classList.remove('valid');
                    }

                    // Check for lowercase letter
                    if (/[a-z]/.test(password)) {
                        passLower.classList.add('valid');
                    } else {
                        passLower.classList.remove('valid');
                    }

                    // Check for uppercase letter
                    if (/[A-Z]/.test(password)) {
                        passUpper.classList.add('valid');
                    } else {
                        passUpper.classList.remove('valid');
                    }

                    // Check for number
                    if (/\d/.test(password)) {
                        passNumber.classList.add('valid');
                    } else {
                        passNumber.classList.remove('valid');
                    }

                    // Check for special character
                    if (/[^a-zA-Z0-9]/.test(password)) {
                        passSpecial.classList.add('valid');
                    } else {
                        passSpecial.classList.remove('valid');
                    }
                });
            }
            // --- END NEW Password Validation UI Logic ---

            // --- NEW: Profile Dropdown Modal Logic ---
            const profileMenuLinks = document.getElementById('profile-dropdown-menu');

            if (profileMenuLinks) {
                profileMenuLinks.addEventListener('click', (e) => {
                    // Find the clicked <a> tag
                    const link = e.target.closest('a');
                    if (!link) return; // Didn't click a link

                    // Check if it's a modal trigger
                    const modalTargetId = link.dataset.modalTarget;
                    if (modalTargetId) {
                        e.preventDefault(); // Stop page from jumping

                        // Find the modal
                        const modal = document.getElementById(modalTargetId);
                        if (modal) {
                            // Show the target modal
                            modal.classList.add('active');

                            // Hide the profile dropdown
                            if (profileMenu) profileMenu.classList.remove('active');
                        }
                    }

                    // If it's the logout button, the existing listener in the other script block will handle it.
                });
            }

            // Add close logic for ALL new profile modals
            document.querySelectorAll('.profile-modal-overlay').forEach(modal => {
                // Close on 'X' button click
                const closeBtn = modal.querySelector('.profile-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        modal.classList.remove('active');

                        // --- NEW: Detach listeners on close ---
                        if (modal.id === 'ride-requests-modal' && window.rideRequestsListener) {
                            window.rideRequestsListener(); // Detach
                            window.rideRequestsListener = null;
                            console.log('Detached ride requests listener.');
                        }
                        if (modal.id === 'active-alerts-modal' && window.activeAlertsListener) {
                            window.activeAlertsListener(); // Detach
                            window.activeAlertsListener = null;
                            console.log('Detached active alerts listener.');
                        }
                    });
                }

                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');

                        // --- NEW: Detach listeners on close ---
                        if (modal.id === 'ride-requests-modal' && window.rideRequestsListener) {
                            window.rideRequestsListener(); // Detach
                            window.rideRequestsListener = null;
                            console.log('Detached ride requests listener.');
                        }
                        if (modal.id === 'active-alerts-modal' && window.activeAlertsListener) {
                            window.activeAlertsListener(); // Detach
                            window.activeAlertsListener = null;
                            console.log('Detached active alerts listener.');
                        }
                    }
                });
            });
            // --- END NEW Profile Dropdown Modal Logic ---


            // --- NEW: Star Rating Logic ---
            const ratingModal = document.getElementById('rating-modal');
            const starContainer = ratingModal ? ratingModal.querySelector('.star-rating-container') : null;
            const stars = starContainer ? starContainer.querySelectorAll('.star') : [];
            const submitReviewBtn = document.getElementById('submit-review-btn');
            const ratingContent = document.getElementById('rating-content');
            const ratingSuccess = document.getElementById('rating-success-message');

            let currentRating = 0;

            const setRating = (rating) => {
                currentRating = rating;
                if (starContainer) starContainer.dataset.rating = rating;
                stars.forEach(star => {
                    if (star.dataset.value <= rating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            };

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    setRating(value);
                });

                // Keep hover effect in JS to avoid CSS-only limitations
                star.addEventListener('mouseover', () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        s.style.color = s.dataset.value <= value ? 'var(--accent-color)' : '#ccc';
                    });
                });
            });

            if (starContainer) {
                starContainer.addEventListener('mouseleave', () => {
                    // Reset to the last clicked rating
                    stars.forEach(s => {
                        if (s.dataset.value <= currentRating) {
                            s.style.color = 'var(--accent-color)';
                        } else {
                            s.style.color = '#ccc';
                        }
                    });
                });
            }

            if (submitReviewBtn) {
                submitReviewBtn.addEventListener('click', async () => { // <-- Add async
                    if (currentRating === 0) {
                        showAlert('Rating Required', 'Please select a star rating before submitting.', 'warning');
                        return;
                    }

                    // --- MODIFIED: Real Firestore Submission ---
                    if (!window.db || !window.fs || !window.currentUserId) {
                        showAlert('Error', 'Cannot submit review. You are not logged in.', 'error');
                        return;
                    }

                    const reviewComment = document.getElementById('review-comment').value;

                    // Simulate submission
                    submitReviewBtn.textContent = 'Submitting...';
                    submitReviewBtn.disabled = true;

                    try {
                        const reviewData = {
                            userId: window.currentUserId,
                            userName: window.currentUserData.name || formatEmailAsName(window.currentUserData.email) || 'Anonymous User',
                            userPhotoUrl: window.currentUserData.photoUrl || null,
                            rating: currentRating,
                            comment: reviewComment,
                            createdAt: new Date().toISOString()
                        };

                        // Add to a PUBLIC 'reviews' collection
                        const reviewsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'reviews');

                        // To prevent spam, let's set the doc ID as the user's ID.
                        // This means a user can only have ONE review.
                        // When they submit again, it just overwrites their old one.
                        const reviewDocRef = window.fs.doc(reviewsColRef, window.currentUserId);
                        await window.fs.setDoc(reviewDocRef, reviewData);

                        // Show success
                        if (ratingContent) ratingContent.style.display = 'none';
                        if (ratingSuccess) ratingSuccess.style.display = 'block';

                        // Reset after 2.5 seconds
                        setTimeout(() => {
                            if (ratingModal) ratingModal.classList.remove('active');
                            // Restore modal for next time
                            if (ratingContent) ratingContent.style.display = 'block';
                            if (ratingSuccess) ratingSuccess.style.display = 'none';
                            if (submitReviewBtn) {
                                submitReviewBtn.textContent = 'Submit Review';
                                submitReviewBtn.disabled = false;
                            }
                            // Reset rating
                            setRating(0);
                            const reviewCommentEl = document.getElementById('review-comment');
                            if (reviewCommentEl) reviewCommentEl.value = '';
                        }, 2500);

                    } catch (error) {
                        console.error("Error submitting review:", error);
                        showAlert('Error', `Could not submit review: ${error.message}`, 'error');
                        submitReviewBtn.textContent = 'Submit Review';
                        submitReviewBtn.disabled = false;
                    }
                    // --- END MODIFICATION ---
                });
            }
            // --- END Star Rating Logic ---

            // --- NEW: Populate Wallet Modal ---
            window.populateWallet = () => {
                const walletModal = document.getElementById('payment-modal');
                if (!walletModal) return;

                const balanceEl = walletModal.querySelector('.wallet-balance h3');
                const addMoneySection = document.getElementById('add-money-section');
                const addMoneyAmountInput = document.getElementById('add-money-amount');

                if (window.currentUserData && window.currentUserData.walletBalance !== undefined) {
                    const balance = window.currentUserData.walletBalance;
                    if (balanceEl) balanceEl.textContent = `₹${balance.toFixed(2)}`;
                } else {
                    if (balanceEl) balanceEl.textContent = '₹0.00';
                }

                // Reset add money section
                if (addMoneySection) addMoneySection.style.display = 'none';
                if (addMoneyAmountInput) addMoneyAmountInput.value = '';
            };

            // Add Money button toggle
            const showAddMoneyBtn = document.getElementById('show-add-money-btn');
            const addMoneySection = document.getElementById('add-money-section');
            if (showAddMoneyBtn && addMoneySection) {
                showAddMoneyBtn.addEventListener('click', () => {
                    const isVisible = addMoneySection.style.display === 'block';
                    addMoneySection.style.display = isVisible ? 'none' : 'block';
                });
            }

            // Confirm Add Money
            const confirmAddMoneyBtn = document.getElementById('confirm-add-money-btn');
            if (confirmAddMoneyBtn) {
                confirmAddMoneyBtn.addEventListener('click', () => {
                    const amountInput = document.getElementById('add-money-amount');
                    const amount = parseFloat(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        showAlert('Invalid Amount', 'Please enter a valid positive amount.', 'warning');
                        return;
                    }

                    // This is a simulation
                    // In a real app, you'd integrate a payment gateway
                    showAlert('Payment Gateway', `Simulating payment for ₹${amount.toFixed(2)}...<br/>(This is a demo, no real payment is processed.)`, 'info');

                    // Simulate success and update balance
                    setTimeout(async () => {
                        try {
                            if (!window.currentUserId || !window.db || !window.fs) {
                                throw new Error('User not logged in or Firebase not ready.');
                            }

                            const newBalance = (window.currentUserData.walletBalance || 0) + amount;
                            const userDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', window.currentUserId);
                            await window.fs.updateDoc(userDocRef, {
                                walletBalance: newBalance
                            });

                            // Update local data
                            window.currentUserData.walletBalance = newBalance;
                            // Update UI
                            window.populateWallet();

                            showAlert('Success', `₹${amount.toFixed(2)} added to your wallet!`, 'success');
                        } catch (error) {
                            console.error("Error adding money:", error);
                            showAlert('Error', `Could not update wallet: ${error.message}`, 'error');
                        }
                    }, 2000);
                });
            }
            // --- END Wallet Modal Logic ---

            // --- NEW: Populate My Rides Modal ---
            window.populateRides = async () => {
                const ridesListEl = document.querySelector('#rides-modal .ride-history-list');
                if (!ridesListEl) return;

                if (!window.currentUserId || !window.db || !window.fs) {
                    ridesListEl.innerHTML = '<li><p>Please log in to see your ride history.</p></li>';
                    return;
                }

                try {
                    const ridesColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rides');
                    const querySnapshot = await window.fs.getDocs(ridesColRef);

                    if (querySnapshot.empty) {
                        ridesListEl.innerHTML = '<li><p>You have not taken any rides yet.</p></li>';
                        return;
                    }

                    ridesListEl.innerHTML = ''; // Clear loading
                    querySnapshot.forEach(doc => {
                        const ride = doc.data();
                        const rideDate = new Date(ride.date).toLocaleDateString('en-IN', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        });
                        const iconClass = ride.type === 'motorcycle' ? 'fa-motorcycle' : 'fa-car';

                        const rideEl = document.createElement('li');
                        rideEl.innerHTML = `
                            <div class="ride-item">
                                <div class="icon"><i class="fas ${iconClass}"></i></div>
                                <div class="ride-details">
                                    <p>${ride.location}</p>
                                    <span>${rideDate} - ${ride.driver}</span>
                                </div>
                                <div class="ride-price">₹${ride.price}</div>
                            </div>
                        `;
                        ridesListEl.appendChild(rideEl);
                    });
                } catch (error) {
                    console.error("Error fetching rides:", error);
                    ridesListEl.innerHTML = `<li><p>Error loading rides: ${error.message}</p></li>`;
                }
            };
            // --- END My Rides Modal Logic ---

            // --- NEW: Populate My Rewards Modal ---
            window.populateRewards = async () => {
                const rewardsListEl = document.querySelector('#rewards-modal .rewards-list');
                if (!rewardsListEl) return;

                if (!window.currentUserId || !window.db || !window.fs) {
                    rewardsListEl.innerHTML = '<li><p>Please log in to see your rewards.</p></li>';
                    return;
                }

                try {
                    const rewardsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rewards');
                    const querySnapshot = await window.fs.getDocs(rewardsColRef);

                    if (querySnapshot.empty) {
                        rewardsListEl.innerHTML = '<li><p>You have no rewards at this time.</p></li>';
                        return;
                    }

                    rewardsListEl.innerHTML = ''; // Clear loading
                    querySnapshot.forEach(doc => {
                        const reward = doc.data();
                        const claimed = reward.claimed || false;

                        const rewardEl = document.createElement('li');
                        rewardEl.innerHTML = `
                            <div class="reward-item">
                                <div class="icon"><i class="fas ${reward.icon || 'fa-gift'}"></i></div>
                                <div class="details">
                                    <h4>${reward.title}</h4>
                                    <p>${reward.description}</p>
                                </div>
                                <button class="claim-btn" data-reward-id="${doc.id}" ${claimed ? 'disabled' : ''}>
                                    ${claimed ? 'Claimed' : 'Claim'}
                                </button>
                            </div>
                        `;
                        rewardsListEl.appendChild(rewardEl);
                    });

                    // Add event listeners to new buttons
                    rewardsListEl.querySelectorAll('.claim-btn:not([disabled])').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const rewardId = e.target.dataset.rewardId;
                            // Simulate claiming
                            e.target.disabled = true;
                            e.target.textContent = 'Claimed';
                            showAlert('Reward Claimed!', 'Your reward has been applied to your account.', 'success');

                            // In a real app, you'd also update this in Firestore
                            // e.g., updateDoc(doc(rewardsColRef, rewardId), { claimed: true });
                        });
                    });

                } catch (error) {
                    console.error("Error fetching rewards:", error);
                    rewardsListEl.innerHTML = `<li><p>Error loading rewards: ${error.message}</p></li>`;
                }
            };
            // --- END My Rewards Modal Logic ---


            // --- NEW: Help Modal (FAQ) Accordion Logic ---
            const faqItems = document.querySelectorAll('#help-modal .faq-item');
            if (faqItems.length > 0) {
                faqItems.forEach(item => {
                    const title = item.querySelector('.faq-title');
                    const details = item.querySelector('.faq-details');

                    if (title && details) {
                        title.addEventListener('click', () => {
                            const isOpen = item.classList.contains('active');

                            // Close all others
                            faqItems.forEach(otherItem => {
                                otherItem.classList.remove('active');
                                const otherDetails = otherItem.querySelector('.faq-details');
                                if (otherDetails) {
                                    otherDetails.classList.remove('open');
                                    otherDetails.style.maxHeight = null;
                                }
                            });

                            // Open the clicked one
                            if (!isOpen) {
                                item.classList.add('active');
                                details.classList.add('open');
                                // Set max-height to its scroll height
                                details.style.maxHeight = details.scrollHeight + 'px';
                            }
                        });

                        // Set initial max-height after a delay to allow for rendering
                        if (details.classList.contains('open')) {
                            setTimeout(() => {
                                details.style.maxHeight = details.scrollHeight + 'px';
                            }, 100);
                        }
                    }
                });
            }
            // --- END Help Modal Logic ---

            // --- NEW: Safety Modal Logic ---
            const shareRideBtn = document.getElementById('share-ride-btn');
            const sosBtn = document.getElementById('sos-btn');

            if (shareRideBtn) {
                shareRideBtn.addEventListener('click', async () => { // <-- MODIFIED: Added async
                    // --- NEW: Full "Share My Ride" Firestore Logic ---
                    if (!window.db || !window.fs || !window.currentUserId) {
                        showAlert('Error', 'Cannot share ride. You are not logged in.', 'error');
                        return;
                    }

                    const tripId = `SRT-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;

                    showAlert('Sharing Ride...', 'Activating your live trip...', 'info');

                    try {
                        const shareData = {
                            tripId: tripId,
                            userId: window.currentUserId,
                            userName: window.currentUserData.name || 'A Traveler',
                            status: 'active',
                            sharedAt: new Date().toISOString(),
                            // In a real app, this would update with live location data
                            lastLocation: window.currentUserData.defaultLocation || 'Unknown'
                        };

                        // Add to a PRIVATE 'shared-trips' collection for this user
                        const shareColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'shared-trips');
                        await window.fs.addDoc(shareColRef, shareData);

                        showAlert('Ride Sharing Active!', `Your trip (ID: <strong>${tripId}</strong>) is now being shared with your trusted contacts. (This is a demo)`, 'success');

                    } catch (error) {
                        console.error("Error sharing ride:", error);
                        showAlert('Sharing Failed', `Could not share your ride: ${error.message}.`, 'error');
                    }
                    // --- END NEW LOGIC ---
                });
            }

            if (sosBtn) {
                sosBtn.addEventListener('click', async () => {
                    if (!window.db || !window.fs || !window.currentUserId) {
                        showAlert('Error', 'Cannot send SOS. You are not logged in or Firebase is not ready.', 'error');
                        return;
                    }

                    const user = window.currentUserData;
                    const location = user.defaultLocation || user.destination || 'Unknown (User has no default location)';

                    showAlert('Sending SOS...', 'Contacting emergency services...', 'warning');

                    try {
                        const sosAlertData = {
                            userId: window.currentUserId,
                            userName: user.name || user.operatorName || 'Unknown User',
                            userPhone: user.phone || 'Unknown Phone',
                            userRole: user.role || 'unknown',
                            location: location,
                            timestamp: new Date().toISOString()
                        };

                        // Add to the PUBLIC 'sos-alerts' collection
                        const sosColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'sos-alerts');
                        await window.fs.addDoc(sosColRef, sosAlertData);

                        showAlert('SOS ACTIVATED!', 'Your location and details have been sent to emergency services and trusted contacts.', 'error');

                    } catch (error) {
                        console.error("Error sending SOS:", error);
                        showAlert('SOS Failed', `Could not send SOS: ${error.message}. Please call for help!`, 'error');
                    }
                });
            }
            // --- END Safety Modal Logic ---

            // --- NEW: Refer Modal Logic ---
            const copyBtn = document.getElementById('referral-copy-btn');
            const copyInput = document.getElementById('referral-code');

            if (copyBtn && copyInput) {
                copyBtn.addEventListener('click', () => {
                    try {
                        // Use document.execCommand for iFrame compatibility
                        copyInput.select();
                        document.execCommand('copy');
                        showAlert('Copied!', 'Referral code copied to clipboard.', 'success');
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        showAlert('Failed', 'Could not copy code. Please copy it manually.', 'error');
                    }
                });
            }

            // --- MODIFIED: Make Refer Share buttons functional ---
            const referralCodeInput = document.getElementById('referral-code');

            const getShareText = () => {
                const code = referralCodeInput ? referralCodeInput.value : 'LOGIN-TO-SEE-CODE';
                return encodeURIComponent(`Join me on SafeReturn! It's a great app for road safety. Use my code ${code} to sign up and get a reward! #SafeReturn`);
            };

            const shareWhatsappBtn = document.getElementById('share-whatsapp');
            if (shareWhatsappBtn) {
                shareWhatsappBtn.addEventListener('click', (e) => {
                    if (!window.currentUserId) {
                        e.preventDefault();
                        showAlert('Login Required', 'Please log in to get your referral code.', 'warning');
                        return;
                    }
                    shareWhatsappBtn.href = `https://api.whatsapp.com/send?text=${getShareText()}`;
                    shareWhatsappBtn.target = '_blank'; // Open in new tab
                });
            }

            const shareTwitterBtn = document.getElementById('share-twitter');
            if (shareTwitterBtn) {
                shareTwitterBtn.addEventListener('click', (e) => {
                    if (!window.currentUserId) {
                        e.preventDefault();
                        showAlert('Login Required', 'Please log in to get your referral code.', 'warning');
                        return;
                    }
                    shareTwitterBtn.href = `https://twitter.com/intent/tweet?text=${getShareText()}`;
                    shareTwitterBtn.target = '_blank'; // Open in new tab
                });
            }

            const shareFacebookBtn = document.getElementById('share-facebook');
            if (shareFacebookBtn) {
                shareFacebookBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!window.currentUserId) {
                        showAlert('Login Required', 'Please log in to get your referral code.', 'warning');
                        return;
                    }
                    // Facebook sharing is complex and needs a real URL. We simulate.
                    showAlert('Share', 'Open Facebook in a new tab to share. (This is a demo)', 'info');
                });
            }

            const shareSmsBtn = document.getElementById('share-sms');
            if (shareSmsBtn) {
                shareSmsBtn.addEventListener('click', (e) => {
                    if (!window.currentUserId) {
                        e.preventDefault();
                        showAlert('Login Required', 'Please log in to get your referral code.', 'warning');
                        return;
                    }
                    // SMS href is not reliable, so we just show the alert.
                    showAlert('Share via SMS', `Your SMS app will open with your referral code. (This is a demo)`, 'info');
                });
            }
            // --- END Refer Modal Logic ---


            // --- Accordion Logic for Education & Tips ---
            const accordions = document.querySelectorAll('.education, .tips');

            accordions.forEach(accordion => {
                const items = accordion.querySelectorAll('.edu-item, .tip');
                items.forEach(item => {
                    const details = item.nextElementSibling; // Get the .edu-details or .tip-details

                    if (details) {
                        const toggleItem = () => {
                            const isOpen = item.classList.contains('active');

                            // Close all items in this section
                            items.forEach(i => {
                                i.classList.remove('active');
                                const d = i.nextElementSibling;
                                if (d) {
                                    d.classList.remove('open');
                                    d.style.maxHeight = null;
                                }
                            });

                            // Open the clicked item if it wasn't already open
                            if (!isOpen) {
                                item.classList.add('active');
                                details.classList.add('open');
                                // Set max-height to its scroll height
                                details.style.maxHeight = details.scrollHeight + 'px';
                            }
                        };

                        item.addEventListener('click', toggleItem);
                        // Add keyboard accessibility
                        item.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                toggleItem();
                            }
                        });

                        // Set initial max-height for any pre-opened items (if any)
                        if (details.classList.contains('open')) {
                            setTimeout(() => {
                                details.style.maxHeight = details.scrollHeight + 'px';
                            }, 100);
                        }
                    }
                });
            });


            // --- Certificate / Pledge Logic ---
            const generatePledgeBtn = document.getElementById('generate-pledge-btn');
            const pledgeNameInput = document.getElementById('pledge-name');
            const pledgeOutput = document.getElementById('pledge-output');

            const heroModal = document.getElementById('hero-modal');
            const heroCloseBtn = document.getElementById('hero-close-btn');

            const certModal = document.getElementById('certificate-modal');
            const certCloseBtn = document.getElementById('cert-close-btn');
            const certNameEl = document.getElementById('cert-name');
            const certDateEl = document.getElementById('current-date');
            const certPrintBtn = document.getElementById('cert-print-btn');
            const certPdfBtn = document.getElementById('cert-pdf-btn');
            const certWhatsappBtn = document.getElementById('cert-whatsapp');
            const confettiCanvas = document.getElementById('confetti-canvas');
            let myConfetti = confetti.create(confettiCanvas, {
                resize: true,
                useWorker: true
            });

            const showHeroModal = () => {
                if (heroModal) heroModal.style.display = 'flex';
            };

            const closeHeroModal = () => {
                if (heroModal) heroModal.style.display = 'none';
                // Show the certificate modal after closing the hero modal
                if (certModal) certModal.style.display = 'flex';
                // Launch confetti!
                myConfetti({
                    particleCount: 150,
                    spread: 180,
                    origin: {
                        y: 0.6
                    }
                });
            };

            if (heroCloseBtn) heroCloseBtn.addEventListener('click', closeHeroModal);

            const showCertificate = (name) => {
                if (certNameEl) certNameEl.textContent = name;
                if (certDateEl) certDateEl.textContent = new Date().toLocaleDateString('en-IN');
                // First, show the "Hero" modal
                showHeroModal();
            };

            const closeCertificate = () => {
                if (certModal) certModal.style.display = 'none';
            };

            if (certCloseBtn) certCloseBtn.addEventListener('click', closeCertificate);

            if (generatePledgeBtn) {
                generatePledgeBtn.addEventListener('click', () => {
                    const name = pledgeNameInput.value.trim();
                    if (name === '') {
                        if (pledgeOutput) {
                            pledgeOutput.innerHTML = '<p style="color: red; font-weight: bold;">Please enter your name to take the pledge.</p>';
                        }
                        return;
                    }

                    if (pledgeOutput) {
                        pledgeOutput.innerHTML = `
                            <p>Thank you, <strong>${name}</strong>!</p>
                            <p><em>"I, <strong>${name}</strong>, commit to never drive distracted, to always follow traffic laws, and to prioritize the safety of myself and others."</em></p>
                        `;
                    }
                    showCertificate(name);
                });
            }

            // Certificate Button Handlers
            if (certPrintBtn) {
                certPrintBtn.addEventListener('click', () => {
                    window.print();
                });
            }

            if (certPdfBtn) {
                certPdfBtn.addEventListener('click', () => {
                    const {
                        jsPDF
                    } = window.jspdf;
                    const certContainer = document.querySelector('.certificate-container');
                    const certName = document.getElementById('cert-name').textContent || 'pledge';

                    html2canvas(certContainer, {
                        scale: 2,
                        useCORS: true
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        // Calculate dimensions for PDF
                        const pdfWidth = 210; // A4 width in mm
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        const pdf = new jsPDF({
                            orientation: pdfWidth > pdfHeight ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        // Center the image on the A4 page
                        const x = (pdf.internal.pageSize.getWidth() - pdfWidth) / 2;
                        const y = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;

                        pdf.addImage(imgData, 'PNG', x, y, pdfWidth, pdfHeight);
                        pdf.save(`SafeReturn_Pledge_${certName.replace(/ /g, '_')}.pdf`);
                    }).catch(err => {
                        console.error("Error generating PDF:", err);
                        alert("Could not generate PDF. Please try printing.");
                    });
                });
            }

            if (certWhatsappBtn) {
                certWhatsappBtn.addEventListener('click', (e) => {
                    const name = certNameEl.textContent;
                    const text = encodeURIComponent(`I just took the SafeReturn Road Safety Pledge! Join me in making our roads safer. #SafeReturn`);
                    certWhatsappBtn.href = `https://api.whatsapp.com/send?text=${text}`;
                });
            }

            // --- Map Preview Logic ---
            const loadMapPreview = (containerId, destinationInputId) => {
                const mapContainer = document.getElementById(containerId);
                const destinationEl = document.getElementById(destinationInputId);
                if (!mapContainer || !destinationEl) return;

                const destination = destinationEl.value;
                if (!destination) {
                    mapContainer.innerHTML = '<div class="map-api-notice"><i class="fas fa-exclamation-triangle"></i>Please enter a destination first.</div>';
                    mapContainer.style.display = 'block';
                    return;
                }

                if (GOOGLE_MAPS_API_KEY === "GOOGLE_MAPS_API_KEY" || !GOOGLE_MAPS_API_KEY) {
                    mapContainer.innerHTML = `
                        <div class="map-api-notice">
                            <i class="fas fa-key"></i>
                            <strong>Map Preview Unavailable</strong>
                            <p>A Google Maps API key is required to show the map preview.</p>
                        </div>`;
                    mapContainer.style.display = 'block';
                    return;
                }

                const mapUrl = `https://www.google.com/maps/embed/v1/place?key=${GOOGLE_MAPS_API_KEY}&q=${encodeURIComponent(destination)}`;
                mapContainer.innerHTML = `<iframe
                    width="100%"
                    height="100%"
                    frameborder="0" style="border:0"
                    src="${mapUrl}" allowfullscreen>
                </iframe>`;
                mapContainer.style.display = 'block';
            };

            const previewDriverMapBtn = document.getElementById('previewDriverMapBtn');
            const previewEmergencyMapBtn = document.getElementById('previewEmergencyMapBtn');

            if (previewDriverMapBtn) {
                previewDriverMapBtn.addEventListener('click', () => {
                    loadMapPreview('driver-map-container', 'baseLocation'); // <-- MODIFIED
                });
            }

            if (previewEmergencyMapBtn) {
                previewEmergencyMapBtn.addEventListener('click', () => {
                    loadMapPreview('emergency-map-container', 'baseLocation'); // <-- MODIFIED
                });
            }

            // --- NEW: Role-Specific Action Button Listeners ---

            // --- 1. Traveler: Book a Ride ---
            const bookRideBtn = document.getElementById('book-my-ride-btn');
            const bookRideModal = document.getElementById('book-ride-modal');
            const bookRideForm = document.getElementById('book-ride-form');
            const bookRideError = document.getElementById('book-ride-error');

            // --- 4. Emergency: Priority Route ---
            const priorityRouteBtn = document.getElementById('get-priority-route-btn');
            const priorityRouteModal = document.getElementById('priority-route-modal');
            const priorityRouteForm = document.getElementById('priority-route-form');
            const priorityRouteError = document.getElementById('priority-route-error');


            if (bookRideBtn && bookRideModal) {
                bookRideBtn.addEventListener('click', () => {
                    bookRideModal.classList.add('active');
                    // Pre-fill location if available
                    const pickupInput = document.getElementById('pickup-location');
                    if (pickupInput && window.currentUserData && window.currentUserData.defaultLocation) {
                        pickupInput.value = window.currentUserData.defaultLocation;
                    }
                });
            }

            if (bookRideForm) {
                bookRideForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!window.db || !window.fs || !window.currentUserId) {
                        if (bookRideError) bookRideError.textContent = 'Error: Not logged in.';
                        return;
                    }

                    const from = bookRideForm['pickup-location'].value;
                    const to = bookRideForm['dropoff-location'].value;
                    const vehicle = bookRideForm['ride-vehicle-type'].value;
                    const submitBtn = bookRideForm.querySelector('.submit-btn');

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Finding...';
                    if (bookRideError) bookRideError.style.display = 'none';

                    try {
                        const rideRequestData = {
                            travelerId: window.currentUserId,
                            travelerName: window.currentUserData.name || 'A Traveler',
                            from: from,
                            to: to,
                            vehicle: vehicle,
                            status: 'pending', // pending, accepted, completed
                            createdAt: new Date().toISOString(),
                            locality: window.currentUserData.defaultLocation ? window.currentUserData.defaultLocation.split(',').pop().trim() : 'unknown' // <-- MODIFIED: Add locality for filtering
                        };

                        // Add to the PUBLIC 'ride-requests' collection
                        const rideRequestsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests');
                        await window.fs.addDoc(rideRequestsColRef, rideRequestData);

                        showAlert('Request Sent!', `Your ride request from ${from} to ${to} has been sent to nearby drivers.`, 'success'); // <-- MODIFIED: Updated alert

                        if (bookRideModal) bookRideModal.classList.remove('active');
                        bookRideForm.reset();

                    } catch (error) {
                        console.error("Error booking ride:", error);
                        if (bookRideError) {
                            bookRideError.textContent = `Error: ${error.message}`;
                            bookRideError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Find My Ride';
                    }
                });
            }

            if (priorityRouteBtn && priorityRouteModal) {
                priorityRouteBtn.addEventListener('click', () => {
                    priorityRouteModal.classList.add('active');
                    // --- NEW: Pre-fill location if available ---
                    const fromInput = document.getElementById('incident-location');
                    if (fromInput && window.currentUserData && window.currentUserData.baseLocation) { // <-- MODIFIED
                        fromInput.value = window.currentUserData.baseLocation; // <-- MODIFIED
                    }
                    // --- END NEW ---
                });
            }

            // --- FIX: This block was incorrectly nested and duplicated ---
            if (priorityRouteForm) {
                priorityRouteForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const from = priorityRouteForm['incident-location'].value;
                    const to = priorityRouteForm['incident-destination'].value;

                    if (!from || !to) {
                        if (priorityRouteError) {
                            priorityRouteError.textContent = 'Please fill in both locations.';
                            priorityRouteError.style.display = 'block';
                        }
                        return;
                    }

                    if (priorityRouteError) priorityRouteError.style.display = 'none';

                    // --- MODIFIED: Link route to phone number (simulation) ---
                    const submitBtn = priorityRouteForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Generating...';

                    // Get phone number
                    const phone = window.currentUserData?.phone || 'your registered number';
                    // Create Google Maps link
                    const mapsLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=driving`;

                    setTimeout(() => {
                        showAlert(
                            'Route Generated!',
                            `An AI-optimized route has been sent via SMS to <strong>${phone}</strong>.<br/><br/><a href="${mapsLink}" target="_blank" style="color: var(--primary-color); text-decoration: underline; font-weight: 600;">Click Here to View Route Now</a><br/><br/>(This is a demo)`,
                            'success'
                        );
                        if (priorityRouteModal) priorityRouteModal.classList.remove('active');
                        priorityRouteForm.reset();
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Generate Route';
                    }, 1500);
                    // --- END MODIFICATION ---
                });
            }

            // --- FIX: This block was incorrectly nested and duplicated ---
            // --- FIX 2: Corrected selector from .payment-method to .saved-payment-method ---
            const paymentModal = document.getElementById('payment-modal');
            if (paymentModal) {
                paymentModal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-btn') || e.target.closest('.remove-btn')) {
                        const paymentMethodEl = e.target.closest('.saved-payment-method'); // <-- Fixed selector
                        if (paymentMethodEl) {
                            paymentMethodEl.style.opacity = '0';
                            paymentMethodEl.style.transform = 'translateX(20px)';
                            paymentMethodEl.style.transition = 'all 0.3s ease';
                            setTimeout(() => {
                                paymentMethodEl.remove();
                                showAlert('Success', 'Payment method removed. (This is a demo)', 'success');
                            }, 300);
                        }
                    }
                });
            }
            // --- END FIX ---


            // --- NEW: Add listeners for ride/alert population functions ---

            // --- Populate Ride Requests (Driver) ---
            const populateAndListenForRideRequests = () => {
                const requestsListEl = document.getElementById('ride-requests-list');
                if (!requestsListEl) return;

                if (!window.db || !window.fs || !window.currentUserId || !window.currentUserData?.onDuty) {
                    requestsListEl.innerHTML = '<li><p>You must be logged in and "On Duty" to see ride requests.</p></li>';
                    return;
                }

                // --- NEW: Get driver's locality ---
                const driverLocality = window.currentUserData.baseLocation ? window.currentUserData.baseLocation.toLowerCase() : '';

                if (!driverLocality) {
                    requestsListEl.innerHTML = '<li><p>Please update your profile with a "Base Location / City" to see local requests.</p></li>';
                    return;
                }
                // --- END NEW ---

                // Detach old listener if it exists
                if (window.rideRequestsListener) {
                    window.rideRequestsListener(); // Call the unsubscribe function
                    window.rideRequestsListener = null;
                }

                requestsListEl.innerHTML = '<li><p>Listening for new ride requests...</p></li>';

                const requestsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests');
                // Query for pending requests
                const q = window.fs.query(requestsColRef, window.fs.where('status', '==', 'pending'));

                // Save the unsubscribe function returned by onSnapshot
                window.rideRequestsListener = window.fs.onSnapshot(q, (querySnapshot) => {

                    requestsListEl.innerHTML = ''; // Clear list
                    let requestsFound = 0; // --- NEW: Counter for filtered requests ---

                    querySnapshot.forEach(doc => {
                        const request = doc.data();

                        // --- NEW: Filter by locality ---
                        const requestLocation = request.from ? request.from.toLowerCase() : '';
                        if (requestLocation.includes(driverLocality)) {
                            requestsFound++;
                            // --- END NEW ---

                            const requestEl = document.createElement('li');
                            requestEl.className = 'modal-list-item ride-request-item';
                            requestEl.innerHTML = `
                                <span><strong>Vehicle:</strong> ${request.vehicle}</span>
                            </div>
                            <button class="accept-btn" data-id="${doc.id}">Accept</button>
                        `;
                            requestsListEl.appendChild(requestEl);

                            // --- NEW: Close filter condition ---
                        }
                        // --- END NEW ---
                    });

                    // --- NEW: Check if any requests were found *after* filtering ---
                    if (requestsFound === 0) {
                        requestsListEl.innerHTML = '<li><p>No pending ride requests found in your locality.</p></li>';
                    }
                    // --- END NEW ---

                    // Add listeners to new accept buttons
                    requestsListEl.querySelectorAll('.accept-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const requestId = e.target.dataset.id;
                            e.target.disabled = true;
                            e.target.textContent = 'Accepting...';

                            try {
                                const requestDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', requestId);
                                await window.fs.updateDoc(requestDocRef, {
                                    status: 'accepted',
                                    driverId: window.currentUserId,
                                    driverName: window.currentUserData.name || 'Community Driver'
                                });
                                showAlert('Ride Accepted!', 'The traveler has been notified.', 'success');
                                // The ride will disappear from the list automatically due to the onSnapshot query
                            } catch (error) {
                                console.error("Error accepting ride:", error);
                                showAlert('Error', `Could not accept ride: ${error.message}`, 'error');
                                e.target.disabled = false;
                                e.target.textContent = 'Accept';
                            }
                        });
                    });

                }, (error) => {
                    console.error("Error listening to ride requests:", error);
                    requestsListEl.innerHTML = `<li><p>Error loading requests: ${error.message}</p></li>`;
                });
            };

            // --- Populate Active Alerts (Emergency) ---
            const populateAndListenForActiveAlerts = () => {
                const alertsListEl = document.getElementById('active-alerts-list');
                if (!alertsListEl) return;

                if (!window.db || !window.fs || !window.currentUserId || !window.currentUserData?.onDuty) {
                    alertsListEl.innerHTML = '<li><p>You must be logged in and "On Duty" to see active alerts.</p></li>';
                    return;
                }

                // Detach old listener
                if (window.activeAlertsListener) {
                    window.activeAlertsListener(); // Call the unsubscribe function
                    window.activeAlertsListener = null;
                }

                alertsListEl.innerHTML = '<li><p>Listening for new SOS alerts...</p></li>';

                const alertsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'sos-alerts');

                // Save the unsubscribe function returned by onSnapshot
                window.activeAlertsListener = window.fs.onSnapshot(alertsColRef, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        alertsListEl.innerHTML = '<li><p>No active SOS alerts found.</p></li>';
                        return;
                    }

                    alertsListEl.innerHTML = ''; // Clear list
                    let alerts = [];
                    querySnapshot.forEach(doc => {
                        alerts.push(doc.data());
                    });

                    // Sort by timestamp, newest first
                    alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    alerts.forEach(alert => {
                        const alertEl = document.createElement('li');
                        alertEl.className = 'modal-list-item alert-item';
                        const alertTime = new Date(alert.timestamp).toLocaleString('en-IN');

                        alertEl.innerHTML = `
                            <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="details">
                                <p>SOS from ${alert.userName} (${alert.userRole})</p>
                                <span><strong>Location:</strong> ${alert.location}</span>
                                <span><strong>Contact:</strong> ${alert.userPhone}</span>
                                <span class="timestamp">${alertTime}</span>
                            </div>
                        `;
                        alertsListEl.appendChild(alertEl);
                    });

                }, (error) => {
                    console.error("Error listening to active alerts:", error);
                    alertsListEl.innerHTML = `<li><p>Error loading alerts: ${error.message}</p></li>`;
                });
            };

            // --- Add listeners to the buttons that open these modals ---
            const viewRideRequestsBtn = document.getElementById('view-ride-requests-btn');
            const rideRequestsModal = document.getElementById('ride-requests-modal');

            if (viewRideRequestsBtn && rideRequestsModal) {
                viewRideRequestsBtn.addEventListener('click', () => {
                    rideRequestsModal.classList.add('active');
                    populateAndListenForRideRequests(); // Call the function
                });
            }

            const viewActiveAlertsBtn = document.getElementById('view-active-alerts-btn');
            const activeAlertsModal = document.getElementById('active-alerts-modal');

            if (viewActiveAlertsBtn && activeAlertsModal) {
                viewActiveAlertsBtn.addEventListener('click', () => {
                    activeAlertsModal.classList.add('active');
                    populateAndListenForActiveAlerts(); // Call the function
                });
            }


        }); // --- End of DOMContentLoaded ---
    </script>