<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Safety Awareness – Safe Return</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- === FIREBASE SDKs === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            setLogLevel,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NEW: Import Firebase Storage
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAhRd4r8xBzJFKpgAIgXoR1rsun0F7p4_Q",
            authDomain: "road-safety05.firebaseapp.com",
            databaseURL: "https://road-safety05-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-safety05",
            storageBucket: "road-safety05.firebasestorage.app",
            messagingSenderId: "710275213811",
            appId: "1:710275213811:web:6a66835798ae912d47ca86",
            measurementId: "G-70YQ76X8H1"
        };

        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // NEW: Initialize Storage
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- NEW: Make critical instances available globally ---
        window.db = db;
        window.auth = auth;
        window.storage = storage; // NEW: Add storage to global window
        window.appId = appId;
        window.currentUserId = null;
        window.currentUserData = {};
        
        // --- FIX: Attach Firestore FUNCTIONS to window ---
        window.fs = {
            doc,
            setDoc,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc,
            // NEW: Add storage functions to global fs object
            storage_ref: ref,
            uploadBytes,
            getDownloadURL
        };
        // --- END FIX ---


        // --- NEW: Helper function to format email as name ---
        const formatEmailAsName = (email) => {
            if (!email || email.indexOf('@') === -1) return 'User'; // Return 'User' if no email or invalid
            try {
                const namePart = email.split('@')[0];
                return namePart
                    .split(/[\._\-]/) // Split by dot, underscore, or dash
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1)) // Capitalize each part
                    .join(' '); // Join with space
            } catch (e) {
                console.warn("Could not format email:", email, e);
                return 'User'; // Fallback
            }
        };
        // --- END NEW ---

        // --- FIX: Wait for DOM to be loaded before accessing elements ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- AUTHENTICATION LOGIC ---

            // Get elements for showing auth state
            const navAuthLinks = document.getElementById('nav-auth-links'); // Container for Login/Sign Up
            const navUserInfo = document.getElementById('nav-user-info');
            const navUserPhoto = document.getElementById('nav-user-photo'); // <-- CHANGED from navUserInitial
            const navLogoutBtn = document.getElementById('nav-logout-btn');

            // --- FIX 2: Moved these definitions up ---
            // Get elements for dynamic content
            const communityLoginPrompt = document.getElementById('community-login-prompt');
            const communityRegisterView = document.getElementById('community-register-view');
            const communityProfileView = document.getElementById('community-profile-view');
            const communityProfileName = document.getElementById('community-profile-name');
            const communityRegisterTitle = document.getElementById('community-register-title');
            const communityRegisterSubtitle = document.getElementById('community-register-subtitle');

            // --- NEW: Profile Dropdown Elements ---
            const profileDropdownName = document.getElementById('profile-dropdown-name');
            const profileDropdownContact = document.getElementById('profile-dropdown-contact');
            // --- END NEW ---

            // --- NEW: Referral Modal Elements ---
            const referralCodeInput = document.getElementById('referral-code');
            const referralCopyBtn = document.getElementById('referral-copy-btn');
            // --- END NEW ---


            // Listen for authentication state changes (login/logout)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    console.log('User logged in:', user.email);
                    navAuthLinks.style.display = 'none'; // Hide Login/Sign Up
                    navUserInfo.style.display = 'flex';
                    // navUserEmail.textContent = user.email; // <-- REMOVED

                    // --- LOGIC TO FETCH USER ROLE AND NAME ---
                    let userRole = 'unknown';
                    let userName = formatEmailAsName(user.email); // Default to formatted email
                    const userId = user.uid;
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId);

                    window.currentUserId = userId; // <-- NEW: Set global userId

                    let userData = {}; // --- FIX 3: Initialize userData ---
                    let photoUrl; // <-- NEW: Declare photoUrl here

                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            userData = userDoc.data(); // --- FIX 3: Assign userData here ---
                            userRole = userData.role || 'unknown';

                            // Get name based on role
                            if (userRole === 'driver') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'traveler') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'emergency') userName = userData.operatorName || formatEmailAsName(user.email);
                            else userName = user.isAnonymous ? 'Guest' : formatEmailAsName(user.email); // No role yet or anonymous

                            // --- NEW: Set photoUrl from userData ---
                            photoUrl = userData.photoUrl;
                            // --- END NEW ---

                            // --- NEW: Seed Demo Data (Rides & Rewards) ---
                            if (!userData.demoDataSeeded && !user.isAnonymous) {
                                console.log("Seeding demo data for user...");
                                const ridesColRef = collection(db, 'artifacts', appId, 'users', userId, 'rides');
                                await addDoc(ridesColRef, {
                                    location: "City Center to Airport",
                                    date: "2025-10-28T15:30:00Z",
                                    driver: "Ramesh Kumar",
                                    price: 450,
                                    type: "car"
                                });
                                await addDoc(ridesColRef, {
                                    location: "Sector 14 to Cyber Hub",
                                    date: "2025-10-27T09:00:00Z",
                                    driver: "Priya Singh",
                                    price: 120,
                                    type: "motorcycle"
                                });

                                const rewardsColRef = collection(db, 'artifacts', appId, 'users', userId, 'rewards');
                                await addDoc(rewardsColRef, {
                                    title: "50% Off First Ride",
                                    description: "Valid for your first ride. Expires in 7 days.",
                                    icon: "fa-percentage",
                                    claimed: false
                                });
                                await addDoc(rewardsColRef, {
                                    title: "₹25 Wallet Credit",
                                    description: "From 'Refer a Friend' bonus.",
                                    icon: "fa-rupee-sign",
                                    claimed: true
                                });

                                // Mark as seeded
                                await updateDoc(userDocRef, { demoDataSeeded: true });
                                userData.demoDataSeeded = true; // Update local copy
                            }
                            // --- END Seed Demo Data ---


                        } else {
                            if (!user.isAnonymous) {
                                console.warn("User document not found for UID:", userId, "Creating one.");
                                // This is a new user who just signed up, create a base doc
                                await setDoc(userDocRef, {
                                    email: user.email,
                                    role: 'unknown',
                                    createdAt: new Date().toISOString(),
                                    walletBalance: 0
                                });
                                userRole = 'unknown';
                                userData = { role: 'unknown', email: user.email, walletBalance: 0 };
                            } else {
                                userRole = 'guest';
                                userName = 'Guest';
                                userData = { role: 'guest', name: 'Guest' };
                            }
                        }

                        window.currentUserData = userData; // <-- NEW: Set global userData

                        // --- NEW: Populate Profile Dropdown ---
                        // --- FIX 3: This code is now safe because userData is always an object ---
                        let userPhone = userData.phone || (user.isAnonymous ? 'Anonymous Guest' : 'No contact info');
                        if (profileDropdownName) profileDropdownName.textContent = userName;
                        if (profileDropdownContact) profileDropdownContact.textContent = userPhone;
                        // --- END NEW ---

                        // --- NEW: Populate Referral Code ---
                        if (referralCodeInput) {
                            // Generate a simple code from the user's ID
                            referralCodeInput.value = `SR-${userId.substring(0, 6).toUpperCase()}`;
                        }
                        // --- END NEW ---

                    } catch (error) {
                        console.error("Error fetching user document:", error);
                        window.currentUserData = { role: 'guest' }; // Set fallback
                    }

                    // --- NEW LOGIC FOR PROFILE PHOTO ---
                    if (navUserPhoto) {
                        if (photoUrl) {
                            navUserPhoto.src = photoUrl;
                        } else {
                            let initial = 'G'; // Default 'Guest'
                            if (userName) {
                                initial = userName.charAt(0).toUpperCase();
                            }
                            // Use placeholder service to generate an initial image
                            navUserPhoto.src = `https://placehold.co/40x40/ccc/eee?text=${initial}`;
                        }
                    }
                    // --- END NEW LOGIC ---

                    // --- NEW LOGIC TO SHOW CORRECT COMMUNITY VIEW ---
                    // --- FIX 2: These variables are now defined and this block will work ---
                    if (userRole === 'driver' || userRole === 'traveler' || userRole === 'emergency') {
                        // User is logged in AND has a role
                        communityLoginPrompt.style.display = 'none';
                        communityRegisterView.style.display = 'none';
                        communityProfileView.style.display = 'block';

                        communityProfileName.textContent = userName;
                        communityProfileView.className = `profile-view-${userRole}`;
                        if (navUserInfo) navUserInfo.className = `dropdown profile-role-${userRole}`; // <!-- ADDED LINE -->
                    } else {
                        // User is logged in but has NO role (e.g., 'unknown' or 'guest')
                        communityLoginPrompt.style.display = 'none';
                        communityRegisterView.style.display = 'block'; // Show role selection
                        communityProfileView.style.display = 'none';
                        if (navUserInfo) navUserInfo.className = `dropdown profile-role-${userRole}`; // <!-- ADDED LINE -->

                        // Update titles to prompt for profile completion
                        communityRegisterTitle.innerHTML = '<i class="fas fa-user-plus"></i> Complete Your Profile';
                        communityRegisterSubtitle.textContent = 'You are logged in. Please select your role in the community to continue.';
                    }

                    // --- NEW: Populate Modals ---
                    if (window.populateWallet) window.populateWallet();
                    if (window.populateRides) window.populateRides();
                    if (window.populateRewards) window.populateRewards();
                    // --- END NEW ---

                    closeModal(); // Hide any open auth modals

                } else {
                    // User is signed out
                    console.log('User logged out');
                    navAuthLinks.style.display = 'flex'; // Show Login/Sign Up
                    navUserInfo.style.display = 'none';
                    if (navUserPhoto) navUserPhoto.src = 'https://placehold.co/40x40/ccc/eee?text=G'; // <-- ADDED: Reset photo
                    if (navUserInfo) navUserInfo.className = 'dropdown'; // <!-- ADDED LINE -->

                    window.currentUserId = null; // <-- NEW
                    window.currentUserData = {}; // <-- NEW

                    // --- NEW: Reset Profile Dropdown ---
                    if (profileDropdownName) profileDropdownName.textContent = 'Guest';
                    if (profileDropdownContact) profileDropdownContact.textContent = 'Please log in';
                    // --- END NEW ---

                    // --- NEW: Reset Referral Code ---
                    if (referralCodeInput) referralCodeInput.value = 'LOGIN-TO-SEE-CODE';
                    // --- END NEW ---

                    // --- FIX 2: These variables are now defined and this block will work ---
                    // Show the default "login prompt" view
                    communityLoginPrompt.style.display = 'block';
                    communityRegisterView.style.display = 'none';
                    communityProfileView.style.display = 'none';
                    communityProfileView.className = '';

                    // --- NEW: Clear Modals ---
                    if (window.populateWallet) window.populateWallet();
                    if (window.populateRides) window.populateRides();
                    if (window.populateRewards) window.populateRewards();
                    // --- END NEW ---
                }
            });

            // Sign in with custom token if available, otherwise anonymously
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial authentication:", error);
                }
            })();


            // --- Get all modal elements ---
            const regModal = document.getElementById('reg-modal');
            const regCloseBtn = regModal.querySelector('.reg-form-close');

            // Form Wrappers
            const loginFormWrapper = document.getElementById('login-form-wrapper');
            const signupFormWrapper = document.getElementById('signup-form-wrapper'); // NEW
            const driverFormWrapper = document.getElementById('driver-form-wrapper');
            const emergencyFormWrapper = document.getElementById('emergency-form-wrapper');
            const travelerFormWrapper = document.getElementById('traveler-form-wrapper');

            // Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form'); // NEW
            const driverForm = document.getElementById('driver-registration-form');
            const emergencyForm = document.getElementById('emergency-registration-form');
            const travelerForm = document.getElementById('traveler-registration-form');

            // Success Messages
            const driverSuccess = document.getElementById('driver-success-message');
            const emergencySuccess = document.getElementById('emergency-success-message');
            const travelerSuccess = document.getElementById('traveler-success-message');

            // Error Messages
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error'); // NEW
            const driverRegError = document.getElementById('driver-reg-error');
            const travelerRegError = document.getElementById('traveler-reg-error');
            const emergencyRegError = document.getElementById('emergency-reg-error');

            // Map Containers
            const driverMapContainer = document.getElementById('driver-map-container');
            const emergencyMapContainer = document.getElementById('emergency-map-container');

            // --- NEW: Photo File Holders ---
            let driverPhotoFile = null;
            let travelerPhotoFile = null;
            let emergencyPhotoFile = null;
            // --- END NEW ---

            // --- Modal Control Functions ---
            const allFormWrappers = [loginFormWrapper, signupFormWrapper, driverFormWrapper, emergencyFormWrapper, travelerFormWrapper];
            const allSuccessMessages = [driverSuccess, emergencySuccess, travelerSuccess];
            const allErrorMessages = [loginError, signupError, driverRegError, travelerRegError, emergencyRegError];

            // Reset all modal content
            const resetModalForms = () => {
                allFormWrappers.forEach(form => {
                    if (form) form.style.display = 'none';
                });
                allSuccessMessages.forEach(msg => {
                    if (msg) msg.style.display = 'none';
                });
                allErrorMessages.forEach(msg => {
                    if (msg) {
                        msg.style.display = 'none';
                        msg.textContent = '';
                    }
                });

                // Reset the forms themselves
                if (loginForm) loginForm.reset();
                if (signupForm) signupForm.reset(); // NEW
                if (driverForm) driverForm.reset();
                if (emergencyForm) emergencyForm.reset();
                if (travelerForm) travelerForm.reset();

                // --- NEW: Reset photo previews ---
                const previews = document.querySelectorAll('.photo-preview');
                const icons = document.querySelectorAll('.upload-icon');
                previews.forEach(p => p.classList.remove('active'));
                icons.forEach(i => i.classList.remove('hidden'));
                driverPhotoFile = null;
                travelerPhotoFile = null;
                emergencyPhotoFile = null;
                // --- END NEW ---

                if (driverMapContainer) {
                    driverMapContainer.style.display = 'none';
                    driverMapContainer.innerHTML = '';
                }
                if (emergencyMapContainer) {
                    emergencyMapContainer.style.display = 'none';
                    emergencyMapContainer.innerHTML = '';
                }
            };

            // Close Modal
            const closeModal = () => {
                if (regModal) regModal.classList.remove('active');
                setTimeout(resetModalForms, 300);
            };

            if (regCloseBtn) regCloseBtn.addEventListener('click', closeModal);
            if (regModal) regModal.addEventListener('click', (e) => {
                if (e.target === regModal) {
                    closeModal();
                }
            });

            // --- EVENT LISTENERS ---

            // 1. Listen for clicks on "Login" button in nav
            const navLoginBtn = document.getElementById('nav-login-btn');
            if (navLoginBtn) {
                navLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (loginFormWrapper) loginFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 2. NEW: Listen for clicks on "Sign Up" button in nav
            const navSignupBtn = document.getElementById('nav-signup-btn');
            if (navSignupBtn) {
                navSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (signupFormWrapper) signupFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 3. Listen for clicks on the "Logout" button
            if (navLogoutBtn) {
                navLogoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });
            }

            // 4. Listen for clicks on the role registration cards (Driver, Traveler, Emergency)
            document.querySelectorAll('.reg-card[data-form-type]').forEach(card => {
                card.addEventListener('click', () => {
                    resetModalForms();
                    const formType = card.dataset.formType;

                    if (formType === 'driver') {
                        if (driverFormWrapper) driverFormWrapper.style.display = 'block';
                    } else if (formType === 'emergency') {
                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'block';
                    } else if (formType === 'traveler') {
                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'block';
                    }

                    if (regModal) regModal.classList.add('active');
                });
            });

            // --- FORM SUBMISSION LOGIC ---

            // 1. Handle Login Form Submission
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = loginForm.loginEmail.value;
                    const password = loginForm.loginPassword.value;
                    if (loginError) loginError.style.display = 'none';

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();
                    } catch (error) {
                        console.error("Login Error:", error.message);
                        if (loginError) {
                            loginError.textContent = `Login Failed: ${error.message}`;
                            loginError.style.display = 'block';
                        }
                    }
                });
            }

            // 2. NEW: Handle Sign Up Form Submission
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = signupForm.signupEmail.value;
                    const password = signupForm.signupPassword.value;
                    const confirmPassword = signupForm.signupConfirmPassword.value;
                    if (signupError) signupError.style.display = 'none';

                    if (password.length < 6) {
                        if (signupError) {
                            signupError.textContent = 'Password must be at least 6 characters long.';
                            signupError.style.display = 'block';
                        }
                        return;
                    }

                    if (password !== confirmPassword) {
                        if (signupError) {
                            signupError.textContent = 'Passwords do not match.';
                            signupError.style.display = 'block';
                        }
                        return;
                    }

                    try {
                        // Step 1: Create user in Auth
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const userId = user.uid;

                        // Step 2: Create a basic user doc in Firestore with 'unknown' role
                        // onAuthStateChanged will see this 'unknown' role and prompt user to select one
                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), {
                            email: email,
                            role: 'unknown',
                            createdAt: new Date().toISOString(),
                            walletBalance: 0
                        });

                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();

                    } catch (error) {
                        console.error("Sign Up Error:", error.message);
                        if (signupError) {
                            signupError.textContent = `Sign Up Failed: ${error.message}`;
                            signupError.style.display = 'block';
                        }
                    }
                });
            }

            // 3. Handle Driver Registration (Role Completion)
            if (driverForm) {
                driverForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (driverRegError) driverRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (driverRegError) {
                            driverRegError.textContent = 'You are not logged in. Please log in first.';
                            driverRegError.style.display = 'block';
                        }
                        return;
                    }

                    const formData = new FormData(driverForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED driverPhoto from data destructuring ---
                    const { driverName, driverPhone, vehicleType, licensePlate, vehicleMake, vehicleModel, driverDestination } = data;

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (driverPhotoFile) {
                            if (driverRegError) {
                                driverRegError.textContent = 'Uploading photo...'; // Show status
                                driverRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, driverPhotoFile);
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (driverRegError) driverRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from the logged-in user
                            name: driverName,
                            phone: driverPhone,
                            role: 'driver', // Set the role
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            vehicleType: vehicleType,
                            licensePlate: licensePlate,
                            vehicleMake: vehicleMake,
                            vehicleModel: vehicleModel,
                            destination: driverDestination,
                            createdAt: new Date().toISOString() // Or update, but new timestamp is fine
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        driverPhotoFile = null;
                        const driverPreview = document.getElementById('driver-photo-preview');
                        const driverIcon = document.getElementById('driver-photo-icon');
                        if(driverPreview) driverPreview.classList.remove('active');
                        if(driverIcon) driverIcon.classList.remove('hidden');
                        // --- END NEW ---

                        // Show success
                        if (driverFormWrapper) driverFormWrapper.style.display = 'none';
                        if (driverSuccess) driverSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Driver Registration Error:", error.message);
                        if (driverRegError) {
                            driverRegError.textContent = `Registration Failed: ${error.message}`;
                            driverRegError.style.display = 'block';
                        }
                    }
                });
            }

            // 4. Handle Traveler Registration (Role Completion)
            if (travelerForm) {
                travelerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (travelerRegError) travelerRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (travelerRegError) {
                            travelerRegError.textContent = 'You are not logged in. Please log in first.';
                            travelerRegError.style.display = 'block';
                        }
                        return;
                    }

                    const formData = new FormData(travelerForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED travelerPhoto from data destructuring ---
                    const { travelerName, travelerPhone, travelerLocation } = data;

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (travelerPhotoFile) {
                            if (travelerRegError) {
                                travelerRegError.textContent = 'Uploading photo...'; // Show status
                                travelerRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, travelerPhotoFile);
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (travelerRegError) travelerRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from logged-in user
                            name: travelerName,
                            phone: travelerPhone,
                            role: 'traveler', // Set the role
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            defaultLocation: travelerLocation,
                            createdAt: new Date().toISOString()
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        travelerPhotoFile = null;
                        const travelerPreview = document.getElementById('traveler-photo-preview');
                        const travelerIcon = document.getElementById('traveler-photo-icon');
                        if(travelerPreview) travelerPreview.classList.remove('active');
                        if(travelerIcon) travelerIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'none';
                        if (travelerSuccess) travelerSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Traveler Registration Error:", error.message);
                        if (travelerRegError) {
                            travelerRegError.textContent = `Registration Failed: ${error.message}`;
                            travelerRegError.style.display = 'block';
                        }
                    }
                });
            }

            // 5. Handle Emergency Registration (Role Completion)
            if (emergencyForm) {
                emergencyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (emergencyRegError) emergencyRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (emergencyRegError) {
                            emergencyRegError.textContent = 'You are not logged in. Please log in first.';
                            emergencyRegError.style.display = 'block';
                        }
                        return;
                    }

                    const formData = new FormData(emergencyForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED servicePhoto from data destructuring ---
                    const { serviceType, serviceId, serviceName, servicePhone, serviceVehicleId, serviceVehicleType, emergencyDestination } = data;

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (emergencyPhotoFile) {
                            if (emergencyRegError) {
                                emergencyRegError.textContent = 'Uploading photo...'; // Show status
                                emergencyRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, emergencyPhotoFile);
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (emergencyRegError) emergencyRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---
                        
                        const serviceData = {
                            email: user.email, // Get email from logged-in user
                            operatorName: serviceName,
                            phone: servicePhone,
                            role: 'emergency', // Set the role
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            serviceType: serviceType,
                            serviceId: serviceId,
                            vehicleId: serviceVehicleId,
                            vehicleType: serviceVehicleType,
                            destination: emergencyDestination,
                            bestRoute: formData.has('bestRoute'),
                            createdAt: new Date().toISOString()
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), serviceData, { merge: true });

                        // --- NEW: Reset file and preview ---
                        emergencyPhotoFile = null;
                        const emergencyPreview = document.getElementById('emergency-photo-preview');
                        const emergencyIcon = document.getElementById('emergency-photo-icon');
                        if(emergencyPreview) emergencyPreview.classList.remove('active');
                        if(emergencyIcon) emergencyIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'none';
                        if (emergencySuccess) emergencySuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Emergency Registration Error:", error.message);
                        if (emergencyRegError) {
                            emergencyRegError.textContent = `Registration Failed: ${error.message}`;
                            emergencyRegError.style.display = 'block';
                        }
                    }
                });
            }
        }); // --- End of DOMContentLoaded ---
    </script>

    <style>
        :root {
            --primary-color: #ff4d4d;
            --secondary-color: #222;
            --light-bg: #f4f4f4;
            --card-bg: #fff;
            --text-color: #333;
            --hover-color: #e63939;
            --dark-red-outline: #cc0000;
            --transition-speed: 0.3s;
            --footer-bg: #1a1a1a;
            --footer-text: #fff;
            --footer-accent: #ffcc00;
            --footer-hover: #e6b800;
            --dark-bg: #1a1a1a;
            --light-text: #fff;
            --accent-color: #ffcc00;
            --accent-hover: #e6b800;
            --border-color: #444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* * ===========================================
         * HERE IS THE BACKGROUND IMAGE FIX
         * ===========================================
        */
        body {
            font-family: 'Open Sans', sans-serif;

            /* 1. Make sure your image (e.g., 'my-background.jpg') is inside the 'Photoes' folder.
               2. Change 'your-background-image.jpg' below to match your image file name.
            */
            background: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)),
                url('Photoes/index.jpg') center/cover no-repeat fixed;



            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            /* === NEW STICKY FOOTER STYLES === */
            display: flex;
            flex-direction: column;
        }

        /* =========================================== */


        .sidebar-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 999;
            border-radius: 10px 0 0 10px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .sidebar-toggle i {
            margin-bottom: 8px;
            display: block;
        }

        .sidebar-toggle:hover {
            background: var(--hover-color);
            padding-right: 15px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90%;
            height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }

        .sidebar-header h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .sidebar-close:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .news-item,
        .event-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .news-item:hover,
        .event-item:hover {
            box-shadow: 0 5px 20px rgba(255, 77, 77, 0.3);
            transform: translateX(-5px);
            border-left-color: var(--primary-color);
        }

        .news-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .news-item h4,
        .event-item h4 {
            color: var(--secondary-color);
            font-size: 1em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .news-item p,
        .event-item p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .news-date,
        .event-date {
            color: var(--primary-color);
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .event-date i {
            color: var(--primary-color);
        }

        .event-item {
            border-left: 4px solid var(--footer-accent);
        }

        .event-item:hover {
            border-left-color: var(--footer-hover);
            box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em 3em;
            background: rgba(34, 34, 34, 0.85);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: background 0.3s ease;
        }

        nav:hover {
            background: rgba(34, 34, 34, 0.95);
        }

        .nav-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
            transition: color 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .nav-title:hover {
            color: var(--primary-color);
        }

        #website_logo {
            height: 40px;
            width: auto;
            vertical-align: middle;
            margin-right: 10px;
            transition: transform 0.3s ease;
            background-color: #fff;
            border-radius: 50%;
        }

        .nav-title:hover #website_logo {
            transform: scale(1.1);
        }

        .nav-links {
            display: flex;
            gap: 2em;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 1em;
            padding: 0.5em 0;
            font-weight: 600;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3em;
        }

        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* === END NEW === */

        .nav-links li.dropdown:hover>a {
            color: var(--primary-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(34, 34, 34, 0.95);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            list-style: none;
            padding: 10px 0;
            border-radius: 0 0 5px 5px;
            z-index: 2000;
        }

        .dropdown-menu li {
            padding: 0;
            width: 100%;
        }

        .dropdown-menu a {
            padding: 10px 20px;
            display: block;
            white-space: nowrap;
            font-weight: 400;
            color: #ccc;
        }

        .dropdown-menu a::after {
            display: none;
        }

        .dropdown-menu a:hover {
            color: var(--footer-accent);
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-links li.dropdown:hover .dropdown-menu {
            display: block;
        }

        /* --- NEW: Profile Dropdown Menu Styles --- */
        #nav-user-info {
            cursor: pointer;
            position: relative;
            /* Needed for the dropdown */
        }

        /* === NEW: Profile Initial Circle Style === */
        /* This now targets the IMG tag */
        .nav-user-photo-class {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--primary-color); /* Fallback bg */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            border: 2px solid #fff;
            transition: all 0.3s ease;
            object-fit: cover; /* Ensures image covers the circle */
            cursor: pointer;
        }

        #nav-user-info:hover .nav-user-photo-class {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        /* === END NEW === */

        /* --- NEW: Profile Icon Color by Role --- */
        .profile-role-traveler .nav-user-photo-class {
            background: #007bff;
            border-color: #f0f7ff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-traveler:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-driver .nav-user-photo-class {
            background: #4CAF50;
            border-color: #f0fff0;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-driver:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-emergency .nav-user-photo-class {
            background: var(--primary-color);
            /* Already red */
            border-color: #fff0f0;
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover #nav-user-initial {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        /* --- END NEW --- */

        .dropdown-menu#profile-dropdown-menu {
            display: none;
            /* Hidden by default */
            position: absolute;
            top: 100%;
            /* Position below the icon */
            right: 0;
            /* Align to the right */
            left: auto;
            background: #fff;
            /* Light background */
            color: var(--secondary-color);
            min-width: 300px;
            /* Wider than other menus */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 0;
            margin-top: 10px;
            /* Space from icon */
            z-index: 2000;
            border: 1px solid #eee;
            overflow: hidden;
            /* For border-radius on items */

            /* Animation */
            transform-origin: top right;
            transition: all 0.2s ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        .dropdown-menu#profile-dropdown-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Stop CSS hover from opening this specific menu */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu {
            display: none;
        }

        /* ...but allow it to stay open if active */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu.active {
            display: block;
        }

        #profile-dropdown-menu li {
            width: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        /* Special Header Item */
        .profile-dropdown-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-dropdown-header .icon {
            font-size: 1.8em;
            color: var(--primary-color);
            background: #fef0f0;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .profile-dropdown-header .details {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .profile-dropdown-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: #222;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-dropdown-header p {
            margin: 0;
            font-size: 0.9em;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- NEW: Photo Upload Options --- */
        .profile-photo-options {
            display: flex;
            justify-content: space-around;
            padding: 10px 5px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
        }
        .profile-photo-options a {
            flex: 1;
            text-align: center;
            padding: 10px 5px !important;
            font-size: 0.9em !important;
            gap: 8px !important;
            flex-direction: column;
            color: #555 !important;
        }
        .profile-photo-options a i {
            margin: 0 !important;
            width: auto !important;
            font-size: 1.4em !important;
            color: var(--primary-color);
        }
        .profile-photo-options a:hover {
            background: #f5f5f5 !important;
            color: var(--primary-color) !important;
        }
         /* --- END NEW --- */

        /* Standard Menu Items */
        #profile-dropdown-menu li a {
            color: #333;
            /* Dark text for links */
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            padding: 15px 20px;
            font-size: 1em;
            transition: background 0.2s ease, color 0.2s ease;
        }

        #profile-dropdown-menu li a::after {
            display: none;
            /* Remove underline effect */
        }

        #profile-dropdown-menu li a i {
            width: 25px;
            text-align: center;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        #profile-dropdown-menu li a .chevron {
            margin-left: auto;
            color: #aaa;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }

        #profile-dropdown-menu li a:hover {
            background: #f9f9f9;
            color: var(--primary-color);
            /* Hover color */
        }

        #profile-dropdown-menu li a:hover .chevron {
            color: var(--primary-color);
        }

        /* Special item styles */
        .profile-menu-rating {
            background: #fdfaf0;
            /* Light yellow bg */
        }

        .profile-menu-rating a:hover {
            background: #fbf5e6;
        }

        .profile-menu-rating a i.fa-star {
            color: #f39c12;
            /* Star color */
        }

        #profile-dropdown-menu li.logout-item a {
            color: var(--primary-color);
            /* Red for logout */
        }

        #profile-dropdown-menu li.logout-item a:hover {
            background: #fef0f0;
        }

        /* --- END NEW Profile Dropdown Styles --- */


        /* --- NEW: Generic Profile Modal Styles --- */
        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9998;
            /* Below reg-modal (9999) but above rest */
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .profile-modal-content {
            background: #fff;
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .profile-modal-overlay.active .profile-modal-content {
            transform: scale(1);
        }

        .profile-modal-content h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Make sure modal h2 styles don't conflict */
        .profile-modal-content h2 {
            color: var(--primary-color) !important;
            border-bottom: 2px solid #eee !important;
        }


        .profile-modal-content p {
            font-size: 1em;
            color: #555;
            line-height: 1.6;
        }

        .profile-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .profile-modal-close:hover {
            color: var(--primary-color);
        }

        /* --- END NEW Profile Modal Styles --- */

        /* --- NEW: Styles for Rating Modal --- */
        .star-rating-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2.5em;
            /* Bigger stars */
            color: #ccc;
            margin: 20px 0 25px;
            cursor: pointer;
        }

        .star-rating-container .star {
            transition: color 0.2s, transform 0.2s;
        }

        /* Hover effect: all stars up to and including the hovered one */
        .star-rating-container:hover .star {
            color: var(--accent-color);
        }

        .star-rating-container .star:hover~.star {
            color: #ccc;
        }

        /* Selected stars (after click) */
        .star-rating-container .star.selected {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        /* Keep hover effect working */
        .star-rating-container:hover .star.selected {
            color: var(--accent-color);
        }

        .star-rating-container .star.selected:hover~.star {
            color: #ccc;
        }

        .star-rating-container .star.selected~.star {
            color: #ccc;
        }


        .review-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            resize: vertical;
            margin-bottom: 20px;
        }

        .review-textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .submit-review-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-review-btn:hover {
            background: var(--hover-color);
        }

        #rating-modal .success-message {
            /* display: none; */
            /* Handled inline */
            padding: 20px 0;
            text-align: center;
        }

        #rating-modal .success-message i {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        #rating-modal .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        #rating-modal .success-message p {
            color: #666;
            font-size: 1em;
        }

        /* --- END Rating Modal Styles --- */

        /* --- NEW: Styles for FAQ in Help Modal --- */
        .faq-accordion {
            margin-top: 25px;
        }

        .faq-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            /* To contain details */
        }

        .faq-title {
            padding: 15px 20px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .faq-title:hover {
            background: #f1f1f1;
        }

        .faq-chevron {
            font-size: 0.9em;
            color: #aaa;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .faq-item.active .faq-title {
            color: var(--primary-color);
        }

        .faq-item.active .faq-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .faq-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out;
            padding: 0 20px;
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .faq-details.open {
            opacity: 1;
            padding: 0 20px 20px;
            /* Add bottom padding when open */
        }

        .faq-details p {
            margin: 0;
        }

        .faq-details a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }

        .faq-details a:hover {
            text-decoration: underline;
        }

        /* --- END FAQ Styles --- */

        /* --- NEW: Styles for Wallet Modal --- */
        #payment-modal .wallet-balance {
            background: linear-gradient(135deg, var(--secondary-color), #444);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #payment-modal .wallet-balance p {
            font-size: 1.1em;
            color: #eee;
            margin: 0;
        }

        #payment-modal .wallet-balance h3 {
            font-size: 3em;
            color: white;
            margin: 5px 0 15px;
            font-family: 'Montserrat', sans-serif;
        }

        .add-money-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-money-btn:hover {
            background: var(--hover-color);
        }

        #add-money-section {
            display: none;
            /* Hidden by default */
            padding: 20px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 20px;
        }

        #add-money-section .form-group {
            margin-bottom: 15px;
        }

        #add-money-section .form-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        #add-money-section .form-group input {
            padding: 10px 12px;
            font-size: 1.2em;
        }

        #payment-modal h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .saved-payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .saved-payment-method .icon {
            font-size: 2.2em;
            color: #007bff;
            /* Visa blue */
        }

        .saved-payment-method .details {
            flex-grow: 1;
        }

        .saved-payment-method .details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .saved-payment-method .details span {
            font-size: 0.9em;
            color: #777;
        }

        .saved-payment-method .remove-btn {
            font-size: 0.9em;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            background: none;
            border: none;
        }

        .saved-payment-method .remove-btn:hover {
            text-decoration: underline;
        }

        /* --- END Wallet Styles --- */

        /* --- NEW: Styles for My Rides Modal --- */
        .ride-history-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ride-history-list li {
            padding: 10px 5px;
        }

        .ride-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .ride-item .icon {
            font-size: 1.8em;
            color: var(--primary-color);
        }

        .ride-item .ride-details {
            flex-grow: 1;
        }

        .ride-item .ride-details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .ride-item .ride-details span {
            font-size: 0.9em;
            color: #777;
            display: block;
        }

        .ride-item .ride-price {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--secondary-color);
        }

        /* --- NEW: Styles for Safety Modal --- */
        .safety-features {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        .safety-feature-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .safety-feature-btn i {
            font-size: 1.8em;
        }

        .safety-feature-btn.share-btn {
            background: #007bff;
            color: white;
        }

        .safety-feature-btn.share-btn:hover {
            background: #0056b3;
            transform: translateY(-3px);
        }

        .safety-feature-btn.sos-btn {
            background: var(--primary-color);
            color: white;
        }

        .safety-feature-btn.sos-btn:hover {
            background: var(--hover-color);
            transform: translateY(-3px);
        }

        .safety-tips-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .safety-tips-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .safety-tips-list li i {
            color: #4CAF50;
            font-size: 1.2em;
        }

        /* --- END Safety & Rides Styles --- */

        /* --- NEW: Styles for Refer & Rewards Modals --- */
        #refer-modal .referral-code-box {
            display: flex;
            margin: 25px 0;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
        }

        #referral-code {
            flex-grow: 1;
            padding: 15px;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--secondary-color);
            border: none;
            background: #fdf0f0;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
        }

        #referral-code:focus {
            outline: none;
        }

        #referral-copy-btn {
            padding: 0 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        #referral-copy-btn:hover {
            background: var(--hover-color);
        }

        #referral-copy-btn:active {
            transform: scale(0.95);
        }

        #refer-modal .social-share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .social-share-btn {
            font-size: 1.8em;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .social-share-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .social-share-btn.whatsapp {
            background: #25D366;
        }

        .social-share-btn.twitter {
            background: #1DA1F2;
        }

        .social-share-btn.facebook {
            background: #1877F2;
        }

        .social-share-btn.sms {
            background: #777;
        }

        .rewards-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .rewards-list li {
            padding: 5px 0;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }

        .reward-item .icon {
            font-size: 2.5em;
            color: var(--accent-color);
        }

        .reward-item .details {
            flex-grow: 1;
        }

        .reward-item .details h4 {
            font-size: 1.1em;
            color: var(--secondary-color);
            margin: 0 0 5px;
            padding: 0;
            border: none;
        }

        .reward-item .details p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }

        .reward-item .claim-btn {
            background: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 8px 15px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .reward-item .claim-btn:hover {
            background: var(--accent-hover);
        }

        .reward-item .claim-btn[disabled] {
            background: #ccc;
            cursor: not-allowed;
        }

        /* --- END Refer & Rewards Styles --- */


        header {
            margin-top: 70px;
            background: rgba(255, 77, 77, 0.9);
            color: var(--card-bg);
            padding: 2em 1em 2.5em;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        header main h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(2em, 4vw, 2.6em);
            margin-bottom: 0.5em;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }

        header main p {
            font-size: 1.1em;
            color: #f0f0f0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            margin-bottom: 1em;
        }

        header main figure {
            margin: 0;
            padding: 0;
        }

        header main figure blockquote {
            font-style: italic;
            font-size: 1.1em;
            margin: 1em auto 0;
            color: #ffffff;
            max-width: 600px;
            padding: 0.8em 1em;
            border-left: 5px solid rgb(255, 255, 255);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        .content {
            max-width: 1000px;
            margin: 2.5em auto;
            padding: 2em 1.5em;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .content h2#why-ai-traffic-lights {
            font-size: 2em;
            text-align: center;
            padding-bottom: 0.5em;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 1.5em;
        }

        .flex-cards {
            display: flex;
            gap: 2em;
            flex-wrap: wrap;
            margin-bottom: 2.5em;
        }

        .flex-cards>article {
            flex: 1;
            min-width: 300px;
        }

        .education,
        .tips {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow var(--transition-speed);
        }

        .education:hover,
        .tips:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        h2:not(#why-ai-traffic-lights) {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            margin-bottom: 1.5em;
        }

        .tip,
        .edu-item {
            margin-bottom: 15px;
            padding: 1.2em 1.5em;
            background: var(--light-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .tip.active,
        .edu-item.active {
            background: #ffffff;
            border-color: var(--primary-color);
        }

        .tip-title,
        .edu-title {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .tip-title i,
        .edu-title i {
            margin-right: 10px;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .tip-chevron,
        .edu-chevron {
            flex-shrink: 0;
            transition: transform var(--transition-speed) ease, color var(--transition-speed);
            color: #aaa;
        }

        .tip.active .tip-chevron,
        .edu-item.active .edu-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .tip-details,
        .edu-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out, opacity 0.4s ease-in-out 0.2s, padding 0.5s ease;
            padding: 0 1.5em;
            color: #555;
            font-weight: normal;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .tip-details.open,
        .edu-details.open {
            opacity: 1;
            padding: 0 1.5em 1.5em;
        }

        .community-box {
            margin: 3em 0;
            padding: 2.5em;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 2px solid var(--footer-accent);
        }

        .community-box h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .community-box h2 i {
            color: var(--footer-accent);
        }

        .community-box>p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 2em;
            line-height: 1.7;
        }

        /* === NEW: Style for the logged-out prompt === */
        #community-login-prompt {
            text-align: center;
        }

        #community-login-prompt p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 1.5em;
        }

        .community-login-btns {
            display: flex;
            justify-content: center;
            gap: 1em;
            flex-wrap: wrap;
        }

        .community-login-btns .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .community-login-btns .btn-primary {
            background: var(--primary-color);
        }

        .community-login-btns .btn-primary:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .community-login-btns .btn-secondary {
            background: #007bff;
        }

        .community-login-btns .btn-secondary:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        /* === END NEW === */


        .registration-options {
            display: flex;
            gap: 1.5em;
            /* Reduced from 2em */
            justify-content: center;
            flex-wrap: wrap;
        }

        .reg-card {
            flex: 1;
            min-width: 260px;
            /* Reduced from 280px */
            max-width: 400px;
            background: white;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .reg-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .reg-card.driver:hover {
            border-color: #4CAF50;
        }

        .reg-card.emergency:hover {
            border-color: var(--primary-color);
        }

        .reg-card-icon {
            font-size: 4em;
            margin-bottom: 0.5em;
        }

        .reg-card.driver .reg-card-icon {
            color: #4CAF50;
        }

        .reg-card.emergency .reg-card-icon {
            color: var(--primary-color);
        }

        .reg-card h3 {
            font-size: 1.5em;
            margin-bottom: 0.5em;
            color: var(--secondary-color);
        }

        .reg-card p {
            color: #666;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }

        .reg-btn {
            padding: 12px 30px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reg-btn:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .reg-card.driver .reg-btn {
            background: #4CAF50;
        }

        .reg-card.driver .reg-btn:hover {
            background: #45a049;
        }

        /* === NEW TRAVELER CARD STYLES === */
        .reg-card.traveler:hover {
            border-color: #007bff;
            /* Blue */
        }

        .reg-card.traveler .reg-card-icon {
            color: #007bff;
        }

        .reg-card.traveler .reg-btn {
            background: #007bff;
        }

        .reg-card.traveler .reg-btn:hover {
            background: #0056b3;
        }

        /* === END TRAVELER CARD STYLES === */

        .reg-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .reg-modal-overlay.active {
            display: flex;
        }

        .reg-form-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* === NEW: Hide wrappers by default === */
        #login-form-wrapper,
        #signup-form-wrapper,
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            display: none;
        }

        /* === END NEW === */


        .reg-form-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .reg-form-close:hover {
            color: var(--primary-color);
        }

        .reg-form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .reg-form-header h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }

        .reg-form-header p {
            color: #666;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: 'Open Sans', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .success-message i {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            font-size: 1.1em;
        }

        /* Styles for new registration forms */
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        /* Add traveler wrapper */
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            /* Add traveler success */
            display: none;
            /* Hidden by default */
        }

        .form-group-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-group-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
            color: #555;
        }

        .submit-btn.emergency-btn {
            background: var(--primary-color);
        }

        .submit-btn.emergency-btn:hover {
            background: var(--hover-color);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .submit-btn.driver-btn {
            background: #4CAF50;
        }

        .submit-btn.driver-btn:hover {
            background: #45a049;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        /* === NEW TRAVELER BUTTON STYLE === */
        .submit-btn.traveler-btn {
            background: #007bff;
        }

        .submit-btn.traveler-btn:hover {
            background: #0056b3;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        /* === END TRAVELER BUTTON STYLE === */

        /* === NEW MAP STYLES === */
        .map-preview-btn {
            background-color: #6c757d;
            /* A neutral gray */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
            padding: 12px;
        }

        .map-preview-btn:hover {
            background-color: #5a6268;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f4f4f4;
            border: 2px solid #ddd;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .map-api-notice {
            color: #b22222;
            /* Firebrick red */
            text-align: center;
            padding: 20px;
            font-weight: 600;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .map-api-notice i {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* === END NEW MAP STYLES === */

        /* End of new styles */


        .pledge-box {
            margin-top: 3em;
            padding: 2.5em;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        .pledge-box h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5em;
            margin-bottom: 0.8em;
            font-size: 2em;
        }

        .pledge-box p {
            margin-bottom: 1.5em;
            color: var(--text-color);
        }

        .pledge-form-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 2em;
        }

        .pledge-form-group label {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pledge-form-group input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1;
            max-width: 300px;
            transition: border-color 0.3s;
        }

        .pledge-form-group input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.5);
        }

        #generate-pledge-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
        }

        #generate-pledge-btn:hover {
            background-color: var(--hover-color);
        }

        #generate-pledge-btn:active {
            transform: scale(0.98);
        }

        .pledge-output {
            margin-top: 1.5em;
            padding: 1.5em;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            background: #ffecec;
            font-style: italic;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.6;
        }

        .pledge-output p {
            margin-bottom: 0;
        }

        .pledge-output strong {
            color: var(--secondary-color);
            font-size: 1.1em;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: auto;
            padding: 20px;
        }

        .certificate-container {
            width: 750px;
            max-width: 95%;
            background: #fff8e7;
            border: 12px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
            font-family: 'Montserrat', sans-serif;
            margin: 20px 0;
        }

        .cert-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #d4af37;
            cursor: pointer;
        }

        .certificate-logo {
            height: 80px;
            margin-bottom: 10px;
        }

        .certificate-header h2 {
            color: #b8860b;
            margin-bottom: 5px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .certificate-header p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        .certificate-body {
            margin: 20px 0;
        }

        .certificate-body blockquote {
            font-style: italic;
            margin: 20px auto;
            padding: 15px;
            border-left: 5px solid #d4af37;
            background: #fff3c2;
            border-radius: 5px;
            max-width: 600px;
            color: #555;
            font-size: 1em;
        }

        .cert-name {
            display: block;
            font-size: 1.6em;
            font-weight: 700;
            margin: 10px 0;
            color: #b8860b;
            text-transform: uppercase;
        }

        .certificate-footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .signature-img {
            height: 60px;
        }

        .certificate-date p,
        .certificate-signature p {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .cert-btn {
            background: #d4af37;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .cert-btn:hover {
            background: #b8860b;
        }

        .cert-btn i {
            margin-right: 8px;
        }

        .cert-btn.fab {
            background-color: #25D366;
        }

        .cert-btn.fab:hover {
            background-color: #128C7E;
        }

        .cert-button-group {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }

        .hero-modal-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #c0392b 100%);
            color: #fff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            font-family: 'Montserrat', sans-serif;
            border: 4px solid #fff;
        }

        #hero-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        #hero-close-btn:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        .hero-modal-content h1 {
            font-size: 2.8em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero-modal-content h2 {
            font-size: 1.5em;
            font-weight: 400;
            opacity: 0.9;
            color: #fff !important;
            border: none !important;
            margin-bottom: 0 !important;
        }

        .hero-modal-content p {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .hero-modal-content p.emphasis {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--footer-accent);
        }

        /* Simple error message style for forms */
        .form-error {
            color: var(--primary-color);
            background: #ffecec;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: none;
            /* Hidden by default */
            text-align: center;
            font-weight: 600;
        }

        /* === NEW: Circular Photo Uploader === */
        .profile-photo-uploader {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px; /* Center it */
            cursor: pointer;
            border-radius: 50%;
            background: #f0f0f0;
            border: 3px dashed #ccc;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* To keep image circular */
        }
        .profile-photo-uploader:hover {
            border-color: var(--primary-color);
            background: #e9e9e9;
        }
        .profile-photo-uploader .upload-icon {
            font-size: 3em;
            color: #aaa;
            transition: all 0.3s ease;
        }
        .profile-photo-uploader:hover .upload-icon {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .profile-photo-uploader .photo-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* This is key */
            border-radius: 50%;
            display: none; /* Hide by default */
        }
        .profile-photo-uploader .photo-preview.active {
            display: block;
        }
        .profile-photo-uploader .upload-icon.hidden {
            display: none;
        }
        /* === END NEW === */

        /* === NEW: File Input Styles === */
        .form-group-file label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        .form-group-file input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            background: #f9f9f9;
        }
        .form-group-file input[type="file"]::file-selector-button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        .form-group-file input[type="file"]::file-selector-button:hover {
            background: #555;
        }
        /* === END NEW === */

        /* === NEW PROFILE VIEW STYLES === */
        #community-profile-view {
            border: 4px solid var(--border-color);
            border-radius: 12px;
            padding: 2em;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        /* Driver Profile = Green */
        .profile-view-driver {
            border-color: #4CAF50 !important;
            background: #f0fff0 !important;
        }

        .profile-view-driver h2 i {
            color: #4CAF50;
        }

        .profile-view-driver #community-profile-name {
            color: #4CAF50;
        }

        /* Traveler Profile = Blue */
        .profile-view-traveler {
            border-color: #007bff !important;
            background: #f0f7ff !important;
        }

        .profile-view-traveler h2 i {
            color: #007bff;
        }

        .profile-view-traveler #community-profile-name {
            color: #007bff;
        }

        /* Emergency Profile = Red */
        .profile-view-emergency {
            border-color: var(--primary-color) !important;
            background: #fff0f0 !important;
        }

        .profile-view-emergency h2 i {
            color: var(--primary-color);
        }

        .profile-view-emergency #community-profile-name {
            color: var(--primary-color);
        }

        /* Default/Unknown/Guest */
        .profile-view-unknown h2 i,
        .profile-view-guest h2 i {
            color: var(--secondary-color);
        }

        .profile-view-unknown #community-profile-name,
        .profile-view-guest #community-profile-name {
            color: var(--secondary-color);
        }

        /* === END NEW PROFILE STYLES === */

        /* === NEW STICKY FOOTER STYLES === */
        #main-footer {
            background-color: var(--dark-bg);
            color: var(--light-text);
            padding: 50px 0;
            font-family: 'Poppins', sans-serif;
            margin-top: auto;
            /* This pushes it to the bottom */
        }

        /* === END NEW STICKY FOOTER STYLES === */

        @media print {
            body>*:not(#certificate-modal) {
                display: none;
            }

            #certificate-modal {
                display: flex !important;
                background: none !important;
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }

            .certificate-container {
                box-shadow: none !important;
                border: 10px solid #d4af37 !important;
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100% !important;
                page-break-inside: avoid;
                border-radius: 0 !important;
            }

            .cert-close-btn,
            .cert-button-group {
                display: none !important;
            }

            #confetti-canvas {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-newspaper"></i> NEWS & EVENTS
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-newspaper"></i> Latest Updates</h2>
            <button class="sidebar-close" id="sidebarClose">&times;</button>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-newspaper"></i> News & Updates</h3>
            <div class="news-item">
                <img src="Photoes/report 1.png" alt="Road safety news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>Road Accident Deaths Rise by 12%</h4>
                <p>Latest government reports show a concerning increase in road fatalities across major highways.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 22, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report3.png" alt="Traffic rules update"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>New Helmet Law Enforcement</h4>
                <p>Stricter penalties announced for riding without helmets. Fine increased to ₹5,000 for repeat
                    offenders.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 18, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 4.jpg" alt="Safety campaign"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>National Road Safety Week Announced</h4>
                <p>Government launches awareness campaign with focus on drunk driving prevention and seatbelt usage.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 15, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 2 .png" alt="Technology news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>AI Traffic Signals Reduce Congestion by 30%</h4>
                <p>Pilot project in Delhi shows promising results with intelligent traffic management systems.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 10, 2025
                </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
            <div class="event-item">
                <h4>🎓 Road Safety Workshop</h4>
                <p>Free workshop for drivers on defensive driving techniques and road safety awareness.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Mph
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 5, 2025 - 10:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>🚦 Traffic Rules Seminar</h4>
                <p>Interactive session covering updated traffic laws and regulations with traffic police officials.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Amphitheater
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 12, 2025 - 3:00 PM
                </div>
            </div>
            <div class="event-item">
                <h4>🏃 Road Safety Marathon</h4>
                <p>Join the city-wide marathon to promote awareness about pedestrian safety and responsible driving.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i>cricket ground
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 20, 2025 - 6:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>👨‍👩‍👧‍👦 Family Safety Day</h4>
                <p>Fun-filled day with safety demonstrations, first-aid training, and activities for children.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Seminar Hall
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 25, 2025 - 9:00 AM
                </div>
            </div>
        </div>
    </aside>

    <nav aria-label="Main Navigation">
        <a href="#home" class="nav-title" aria-label="Home">
            <img id="website_logo" src="Photoes/logo.png" alt="SafeReturn Logo"
                onerror="this.src='https://placehold.co/40x40/ffffff/E63939?text=SR'; this.onerror=null;">
            SafeReturn
        </a>

        <ul class="nav-links">
            <li><a href="#home">Home</a></li>
            <li class="dropdown">
                <a href="#road-safety" aria-expanded="false" aria-haspopup="true">Road Safety Tips <i
                        class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="Road Safety.html">Fundamentals</a></li>
                    <li><a href="vehicles Mechanics.html">Vehicles Mechanics</a></li>
                    <li><a href="Essential Road Safety Instructions.html">Essential Road Safety Instructions</a></li>
                </ul>
            </li>
            <li><a href="Quiz.html">Quiz</a></li>
            <li class="dropdown">
                <a href="#why-AI-traffic-lights" aria-expanded="false" aria-haspopup="true">Why AI Traffic Lights <i
                        class="fas fa-caret-down"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="AI based traffic lights image.html">AI Based traffic lights</a></li>
                    <li><a href="#how-it-works">How it Works</a></li>
                    <li><a href="#benefits">Benefits</a></li>
                    <li><a href="#challenges">Challenges</a></li>
                </ul>
            </li>
            <li><a href="Collage.html">Collage</a></li>
            <li><a href="footer.html">Contact</a></li>

            <!-- === NEW AUTH LINKS === -->
            <!-- These show when logged OUT -->
            <span id="nav-auth-links" style="display: flex; gap: 1.5em; align-items: center;">
                <li><a href="#" id="nav-login-btn">Login</a></li>
                <li><a href="#" id="nav-signup-btn">Sign Up</a></li>
            </span>

            <!-- This shows when logged IN -->
            <li id="nav-user-info" class="dropdown" style="display: none; align-items: center; gap: 15px;">
                <!-- NEW: Profile Photo Circle -->
                <img id="nav-user-photo" src="https://placehold.co/40x40/ccc/eee?text=G" alt="Profile" class="nav-user-photo-class">
                <!-- <a href="#" id="nav-logout-btn" style="color: #fff; background: var(--primary-color); padding: 5px 10px; border-radius: 5px;">Logout</a> -->
                <!-- OLD LOGOUT BTN - REMOVED -->

                <!-- === NEW PROFILE DROPDOWN MENU === -->
                <ul class="dropdown-menu" id="profile-dropdown-menu">
                    <li class="profile-dropdown-header">
                        <div class="icon"><i class="fas fa-user"></i></div>
                        <div class="details">
                            <h4 id="profile-dropdown-name">Guest</h4>
                            <p id="profile-dropdown-contact">Please log in</p>
                        </div>
                    </li>
                    <!-- NEW PHOTO UPLOAD OPTIONS -->
                    <li class="profile-photo-options">
                        <a href="#" id="photo-gallery-btn">
                            <i class="fas fa-images"></i>
                            <span>Add from Gallery</span>
                        </a>
                        <a href="#" id="photo-camera-btn">
                            <i class="fas fa-camera"></i>
                            <span>Click a Photo</span>
                        </a>
                    </li>
                    <!-- END NEW PHOTO UPLOAD OPTIONS -->
                    <li class="profile-menu-rating">
                        <a href="#" data-modal-target="rating-modal">
                            <i class="fas fa-star"></i>
                            <span>My Rating</span>
                            <i class="fas fa-chevron-right chevron"></i>
                        </a>
                    </li>
                    <li><a href="#" data-modal-target="help-modal"><i
                                class="fas fa-question-circle"></i><span>Help</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="payment-modal"><i
                                class="fas fa-credit-card"></i><span>Wallet</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="rides-modal"><i class="fas fa-route"></i><span>My Rides</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="safety-modal"><i
                                class="fas fa-shield-alt"></i><span>Safety</span><i
                                class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="refer-modal"><i class="fas fa-gift"></i><span>Refer and
                                Earn</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="rewards-modal"><i class="fas fa-trophy"></i><span>My
                                Rewards</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li><a href="#" data-modal-target="pass-modal"><i class="fas fa-ticket-alt"></i><span>Power
                                Pass</span><i class="fas fa-chevron-right chevron"></i></a></li>
                    <li class="logout-item">
                        <!-- Moved logout button here -->
                        <a href="#" id="nav-logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
                <!-- === END NEW MENU === -->
            </li>
        </ul>
    </nav>

    <header id="home">
        <main>
            <h1>Drive Smart. Stay Safe.</h1>
            <p>Your journey is precious. Awareness is your best defense.</p>
            <figure>
                <blockquote>"The only thing we need from your trip is your safe return."</blockquote>
            </figure>
        </main>
    </header>

    <main class="content">
        <div class="flex-cards">
            <article class="education" id="education">
                <h2><i class="fas fa-book-open"></i> Safety Education</h2>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-car-crash"></i> Understanding Blind Spots</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>A blind spot is an area around a vehicle that the driver cannot see through their mirrors or by
                        looking directly. These hidden zones can exist on both sides of the car, behind it, and
                        sometimes even in front of large vehicles like trucks and buses. Blind spots are dangerous
                        because another vehicle, a cyclist, or a pedestrian can be present without the driver realizing
                        it. Many crashes happen when drivers change lanes or turn without checking these areas properly.
                        To stay safe, drivers should always adjust their mirrors correctly, look over their shoulder
                        before switching lanes, and be extra careful around heavy vehicles, which have much bigger blind
                        spots. Road users like cyclists and pedestrians should also avoid staying close to the sides of
                        large vehicles. Understanding blind spots helps everyone share the road more safely and prevent
                        accidents.</p>
                </div>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-road"></i> Hydroplaning Explained</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>Hydroplaning (or aquaplaning) happens when a vehicle’s tires lose contact with the road due to a
                        layer of water between the tire and the surface. This causes the vehicle to “float” on water,
                        reducing the driver’s ability to steer, brake, or control speed. Hydroplaning usually occurs at
                        higher speeds on wet roads, especially when tires are worn-out or water on the road is deep. To
                        prevent hydroplaning, drivers should slow down during rain, maintain proper tire pressure, avoid
                        sudden turns or braking, and stay away from areas where water collects.</p>
                </div>
            </article>

            <article class="tips" id="tips">
                <h2><i class="fas fa-lightbulb"></i> Top Safety Tips</h2>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-mobile-alt"></i> Avoid Distractions</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Avoiding distractions while driving is essential for road safety. Drivers should keep their
                        phones away, avoid multitasking like eating or adjusting controls while the vehicle is moving,
                        and set up mirrors, navigation, and music before starting the journey. Passengers, children, or
                        pets should be managed so they do not divert the driver’s attention. If phone use or any other
                        task becomes necessary, it is always safer to pull over first. Even a moment of distraction can
                        lead to a serious crash, so staying focused on the road is the key to preventing accidents.</p>
                </div>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-tachometer-alt"></i> Watch Your Speed</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Controlling your speed is one of the most important aspects of safe driving. Driving too fast
                        reduces your reaction time and increases the distance your vehicle travels before you can
                        stop—this means hazards that you might otherwise avoid become much more dangerous. Roads vary in
                        surface, condition, and layout, so even the posted speed limit may be too fast under certain
                        conditions like rain, fog, heavy traffic, or when sharing the road with pedestrians and
                        cyclists. Always adjust your speed to suit the conditions, anticipate hazards ahead, and
                        maintain safe following distance. By doing so, you give yourself a better chance to respond
                        safely and avoid serious accidents.</p>
                </div>
            </article>
        </div>

        <!-- 
            FIX: REMOVED DUPLICATE COMMUNITY SECTION. 
            The section below is the correct, complete one.
        -->

        <section class="community-box" id="community">

            <!-- View 1: Logged OUT (NEW) -->
            <div id="community-login-prompt">
                <h2><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p>Register or log in to get localized alerts, contribute to safer roads, and access community features.
                </p>
                <div class="community-login-btns">
                    <button id="community-signup-btn" class="btn btn-primary"
                        onclick="document.getElementById('nav-signup-btn').click();">Sign Up Now</button>
                    <button id="community-login-btn" class="btn btn-secondary"
                        onclick="document.getElementById('nav-login-btn').click();">Login</button>
                </div>
            </div>

            <!-- View 2: Logged IN, No Role Selected (MOVED) -->
            <div id="community-register-view" style="display: none;">
                <h2 id="community-register-title"><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p id="community-register-subtitle">Register as a community driver or an emergency responder to get
                    localized alerts and contribute to safer
                    roads for everyone.</p>
                <div class="registration-options">
                    <div class="reg-card driver" data-form-type="driver">
                        <div class="reg-card-icon"><i class="fas fa-car"></i></div>
                        <h3>Driver Registration</h3>
                        <p>Get alerts on road conditions, accidents, and construction in your area. Report hazards and
                            help
                            others.</p>
                        <button class="reg-btn">Register as Driver</button>
                    </div>

                    <!-- === NEW TRAVELER CARD === -->
                    <div class="reg-card traveler" data-form-type="traveler">
                        <div class="reg-card-icon"><i class="fas fa-user-plus"></i></div>
                        <h3>Community Registration</h3>
                        <p>Register as a traveler to book cabs, bikes, and other registered vehicles from our community.
                        </p>
                        <button class="reg-btn">Register as Traveler</button>
                    </div>
                    <!-- === END NEW TRAVELER CARD === -->

                    <div class="reg-card emergency" data-form-type="emergency">
                        <div class="reg-card-icon"><i class="fas fa-first-aid"></i></div>
                        <h3>Emergency Services</h3>
                        <p>Register your service to get priority access to AI-optimized routes and real-time incident
                            data.
                        </p>
                        <button class="reg-btn">Register Service</button>
                    </div>
                </div>
            </div> <!-- End register view -->

            <!-- View 3: Logged IN, Role Selected (MOVED) -->
            <div id="community-profile-view" style="display: none;"> <!-- Class will be added by JS -->
                <h2><i class="fas fa-user-check"></i> Welcome to the Community!</h2>
                <p style="font-size: 1.2em;">You are logged in as: <strong id="community-profile-name"></strong></p>
                <p>You can now access community features, manage your profile, and help keep our roads safe.</p>
                <!-- You could add buttons here like "Edit My Profile" or "View Hazard Map" -->
            </div>
        </section>


        <section class="pledge-box" id="pledge">
            <h2><i class="fas fa-hands-helping"></i> Take the Road Safety Pledge</h2>
            <p>Enter your name below and commit to safer roads for everyone. Let's drive responsibly!</p>
            <div class="pledge-form-group">
                <label for="pledge-name">Your Name:</label>
                <input type="text" id="pledge-name" placeholder="Eg : vivek yadav "
                    aria-label="Enter your name for the pledge">
                <button id="generate-pledge-btn" aria-label="Generate my road safety pledge">Generate Pledge</button>
            </div>
            <div id="pledge-output" class="pledge-output">
                <p>
                    <strong>This pledge is not just a promise,</strong>
                    It is a movement</em> —<br>
                    a movement that begins with one responsible citizen…<br>
                    <strong>And Today</strong>, that responsible citizen is <strong><em>YOU</em>.</strong><br>
                    <strong>Your decision</strong> can influence others,<br>
                    <em>Your voice</em> can inspire change,<br>
                    and <strong><em>Your action</em> can save lives.</strong>
                </p>
            </div>
        </section>

    </main>

    <!-- Hidden File Inputs for Profile Photo -->
    <input type="file" id="photo-gallery-input" accept="image/*" style="display: none;">
    <input type="file" id="photo-camera-input" accept="image/*" capture="user" style="display: none;">

    <!-- === NEW: Custom Alert Modal === -->
    <div id="custom-alert-modal" class="profile-modal-overlay" style="z-index: 10001;"> <!-- Highest z-index -->
        <div class="profile-modal-content" style="max-width: 400px; text-align: center;">
            <span class="profile-modal-close">&times;</span>
            <div id="custom-alert-icon" style="font-size: 3em; margin-bottom: 15px;">
                <!-- Icon will be set by JS -->
            </div>
            <h3 id="custom-alert-title" style="font-size: 1.5em; color: var(--secondary-color); margin-bottom: 10px;"></h3>
            <p id="custom-alert-message" style="font-size: 1em; color: #555; line-height: 1.6;"></p>
            <button id="custom-alert-close-btn" class="submit-btn" style="margin-top: 20px;">OK</button>
        </div>
    </div>
    <!-- === END Custom Alert Modal === -->


    <!-- 
        FIX: The broken HTML fragment that was here has been removed.
        The block below is the correct, functioning modal.
    -->
    <div class="reg-modal-overlay" id="reg-modal">
        <div class="reg-form-container">
            <span class="reg-form-close">&times;</span>

            <!-- === LOGIN FORM === -->
            <div id="login-form-wrapper">
                <div class="reg-form-header">
                    <h2>Community Login</h2>
                    <p>Welcome back! Sign in to access your account.</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="loginEmail" name="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i>Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required>
                    </div>
                    <div id="login-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: #007bff;">Login</button>
                </form>
            </div>

            <!-- === NEW SIGNUP FORM === -->
            <div id="signup-form-wrapper">
                <div class="reg-form-header">
                    <h2>Create Your Account</h2>
                    <p>Sign up to join the community. It's fast and free.</p>
                </div>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signupEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="signupEmail" name="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword"><i class="fas fa-lock"></i>Password (min. 6 characters)</label>
                        <input type="password" id="signupPassword" name="signupPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword"><i class="fas fa-check-circle"></i>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" name="signupConfirmPassword" required
                            minlength="6">
                    </div>
                    <div id="signup-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: var(--primary-color);">Create
                        Account</button>
                </form>
            </div>

            <!-- === DRIVER REGISTRATION FORM (Role Completion) === -->
            <div id="driver-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-driver">Complete Driver Profile</h2>
                    <p id="reg-form-subtitle-driver">Please provide your driver and vehicle details.</p>
                </div>
                <form id="driver-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="driver-photo-uploader-port" title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="driver-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="driver-photo-preview">
                    </div>
                    <input type="file" id="driver-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="driverName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="driverName" name="driverName" required>
                    </div>
                    <div class="form-group">
                        <label for="driverPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="driverPhone" name="driverPhone" required>
                    </div>
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleType"><i class="fas fa-car-side"></i>Vehicle Type</label>
                            <select id="vehicleType" name="vehicleType">
                                <option value="car">Car</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="truck">Truck</option>
                                <option value="bus">Bus</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="licensePlate"><i class="fas fa-id-card"></i>License Plate</label>
                            <input type="text" id="licensePlate" name="licensePlate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleMake"><i class="fas fa-industry"></i>Vehicle Make</label>
                            <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., Toyota">
                        </div>
                        <div class="form-group">
                            <label for="vehicleModel"><i class="fas fa-car"></i>Vehicle Model</label>
                            <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., Camry">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Trip Details</h3>
                    <div class="form-group">
                        <label for="driverDestination"><i class="fas fa-map-marker-alt"></i>Destination Location</label>
                        <input type="text" id="driverDestination" name="driverDestination"
                            placeholder="Enter destination address or area">
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewDriverMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="driver-map-container" class="map-container" style="display: none;"></div>

                    <div id="driver-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn">Register Driver</button>
                </form>
            </div>

            <!-- === TRAVELER REGISTRATION FORM (Role Completion) === -->
            <div id="traveler-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-traveler">Complete Traveler Profile</h2>
                    <p id="reg-form-subtitle-traveler">Tell us a bit about yourself.</p>
                </div>
                <form id="traveler-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="traveler-photo-uploader-port" title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="traveler-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="traveler-photo-preview">
                    </div>
                    <input type="file" id="traveler-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="travelerName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="travelerName" name="travelerName" required>
                    </div>
                    <div class="form-group">
                        <label for="travelerPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="travelerPhone" name="travelerPhone" required>
                    </div>
                    <!-- === REMOVED OLD PHOTO INPUT === -->
                    <div class="form-group">
                        <label for="travelerLocation"><i class="fas fa-map-marker-alt"></i>Default Pickup Location
                            (Optional)</label>
                        <input type="text" id="travelerLocation" name="travelerLocation"
                            placeholder="Enter your home or work address">
                    </div>

                    <div id="traveler-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn traveler-btn">Register as Traveler</button>
                </form>
            </div>
            <!-- === END TRAVELER REGISTRATION FORM === -->

            <!-- === EMERGENCY REGISTRATION FORM (Role Completion) === -->
            <div id="emergency-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-emergency">Complete Service Profile</h2>
                    <p id="reg-form-subtitle-emergency">Register your service for priority routing.</p>
                </div>
                <form id="emergency-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="emergency-photo-uploader-port" title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="emergency-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="emergency-photo-preview">
                    </div>
                    <input type="file" id="emergency-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Service Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceType"><i class="fas fa-briefcase-medical"></i>Service Type</label>
                            <select id="serviceType" name="serviceType">
                                <option value="ambulance">Ambulance</option>
                                <option value="police">Police</option>
                                <option value="fire">Fire Dept.</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceId"><i class="fas fa-id-badge"></i>Service ID / Unit No.</label>
                            <input type="text" id="serviceId" name="serviceId" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="serviceName"><i class="fas fa-user-md"></i>Operator Name</label>
                        <input type="text" id="serviceName" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label for="servicePhone"><i class="fas fa-phone-alt"></i>Dispatch Phone</label>
                        <input type="tel" id="servicePhone" name="servicePhone" required>
                    </div>
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceVehicleId"><i class="fas fa-car"></i>Vehicle ID / Plate</label>
                            <input type="text" id="serviceVehicleId" name="serviceVehicleId" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceVehicleType"><i class="fas fa-ambulance"></i>Vehicle Type</label>
                            <input type="text" id="serviceVehicleType" name="serviceVehicleType"
                                placeholder="e.g., Type II Ambulance">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Routing Details</h3>
                    <div class="form-group">
                        <label for="emergencyDestination"><i class="fas fa-map-marked-alt"></i>Destination
                            Location</label>
                        <input type="text" id="emergencyDestination" name="emergencyDestination"
                            placeholder="Enter incident address or area">
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewEmergencyMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="emergency-map-container" class="map-container" style="display: none;"></div>

                    <div class="form-group-checkbox">
                        <input type="checkbox" id="bestRoute" name="bestRoute">
                        <label for="bestRoute">Give best possible route option</label>
                    </div>

                    <div id="emergency-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn emergency-btn">Register Service</button>
                </form>
            </div>

            <!-- === SUCCESS MESSAGES === -->
            <div class="success-message" id="driver-success-message">
                <i class="fas fa-check-circle"></i>
                <h3>Registration Successful!</h3>
                <p>Thank you for joining the driver community.</p>
            </div>
            <div class="success-message" id="emergency-success-message">
                <i class="fas fa-check-circle" style="color: var(--primary-color);"></i>
                <h3>Service Registered!</h3>
                <p>Your unit is now active. Thank you for your service.</p>
            </div>

            <!-- === TRAVELER SUCCESS MESSAGE === -->
            <div class="success-message" id="traveler-success-message">
                <i class="fas fa-check-circle" style="color: #007bff;"></i>
                <h3>Welcome to the Community!</h3>
                <p>You can now book rides from registered community vehicles.</p>
            </div>
            <!-- === END TRAVELER SUCCESS MESSAGE === -->

        </div>
    </div>

    <!-- === NEW: Profile Modals === -->

    <!-- My Rating Modal -->
    <div id="rating-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>

            <!-- Rating Content -->
            <div id="rating-content">
                <h2><i class="fas fa-star"></i> Rate Your Experience</h2>
                <p>We value your feedback. Please rate your experience with safe return and leave a comment below.</p>

                <div class="star-rating-container" data-rating="0">
                    <span class="star" data-value="1"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="2"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="3"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="4"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="5"><i class="fas fa-star"></i></span>
                </div>

                <textarea id="review-comment" class="review-textarea"
                    placeholder="Write your review here... (optional)"></textarea>

                <button id="submit-review-btn" class="submit-review-btn">Submit Review</button>
            </div>

            <!-- Success Message -->
            <div id="rating-success-message" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>Thank You!</h3>
                <p>Your feedback has been submitted.</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-question-circle"></i> Help & Support</h2>
            <p>Welcome to our support center. Find answers to common questions below or contact us directly for
                assistance.</p>

            <!-- NEW: FAQ Accordion -->
            <div class="faq-accordion">
                <!-- FAQ 1 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How do I reset my password?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>To reset your password, please log out, click "Sign In" on the main page, and then look for a
                            "Forgot Password?" link on the sign-in form. (Note: This link is not yet implemented, but
                            this is where it would be.)</I></p>
                    </div>
                </div>

                <!-- FAQ 2 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How does community registration work?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>First, you must "Create Account" with your email and password. After you are logged in, the
                            "Join Our Safety Community" section on the main page will allow you to select a role
                            (Driver, Traveler, or Emergency) and complete your profile.</p>
                    </div>
                </div>

                <!-- FAQ 3 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>How do I report a road hazard?</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>Once you are registered as a "Driver," a "Report Hazard" button will become available on your
                            community dashboard. This feature allows you to report accidents, construction, or other
                            dangers in real-time. (This feature is coming soon!)</p>
                    </div>
                </div>

                <!-- FAQ 4 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        <span>Contact Us</span>
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>For any technical issues or support requests not covered here, please email our team directly
                            at <a href="mailto:support@safereturn.com">support@safereturn.com</a>.</p>
                    </div>
                </div>
            </div>
            <!-- END NEW FAQ -->

        </div>
    </div>



    <!-- Payment Modal -->
    <div id="payment-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-wallet"></i> Wallet</h2>

            <div class="wallet-balance">
                <p>Current Balance</p>
                <h3>₹0.00</h3>
                <button id="show-add-money-btn" class="add-money-btn"><i class="fas fa-plus-circle"></i> Add
                    Money</button>
            </div>

            <div id="add-money-section">
                <div class="form-group">
                    <label for="add-money-amount">Enter Amount (₹)</label>
                    <input type="number" id="add-money-amount" placeholder="e.g., 500">
                </div>
                <button id="confirm-add-money-btn" class="submit-btn driver-btn" style="background: #4CAF50;">Proceed to
                    Pay</button>
            </div>

            <h4>Saved Payment Methods</h4>
            <div class="saved-payment-method">
                <div class="icon"><i class="fab fa-cc-visa"></i></div>
                <div class="details">
                    <p>Visa .... 4242</p>
                    <span>Expires 12/26</span>
                </div>
                <button class="remove-btn"><i class="fas fa-trash"></i> Remove</button>
            </div>
            <div class="saved-payment-method">
                <div class="icon" style="color: #5abf2e;"><i class="fas fa-mobile-alt"></i></div>
                <div class="details">
                    <p>UPI</p>
                    <span>vivek@okbank</span>
                </div>
                <button class="remove-btn"><i class="fas fa-trash"></i> Remove</button>
            </div>

        </div>
    </div>

    <!-- My Rides Modal -->
    <div id="rides-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-route"></i> My Rides</h2>
            <p>Here is a history of your recent rides with SafeReturn community drivers.</p>

            <ul class="ride-history-list">
                <!-- Static content removed, will be populated by JS -->
                <li><p>Loading ride history...</p></li>
            </ul>
        </div>
    </div>

    <!-- Safety Modal -->
    <div id="safety-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-shield-alt"></i> Safety Center</h2>
            <p>Your safety is our priority. Use these tools in case of an emergency or to share your trip details.</p>

            <div class="safety-features">
                <button class="safety-feature-btn share-btn" id="share-ride-btn">
                    <i class="fas fa-share-alt"></i>
                    <span>Share My Ride</span>
                </button>
                <button class="safety-feature-btn sos-btn" id="sos-btn">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Emergency SOS</span>
                </button>
            </div>

            <h4
                style="font-family: 'Montserrat', sans-serif; color: var(--secondary-color); font-size: 1.2em; margin-top: 30px; margin-bottom: 15px;">
                Safety Tips:</h4>
            <ul class="safety-tips-list">
                <li><i class="fas fa-check-circle"></i> Always verify the driver's name and vehicle license plate.</li>
                <li><i class="fas fa-check-circle"></i> Wear your seatbelt at all times.</li>
                <li><i class="fas fa-check-circle"></i> Share your trip status with a trusted contact.</li>
                <li><i class="fas fa-check-circle"></i> Avoid sharing personal information with the driver.</li>
            </ul>
        </div>
    </div>

    <!-- Refer and Earn Modal -->
    <div id="refer-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-gift"></i> Refer and Earn</h2>
            <p>Share your code with friends. When they sign up, you both get a reward!</p>

            <div class="referral-code-box">
                <input type="text" id="referral-code" value="LOGIN-TO-SEE-CODE" readonly>
                <button id="referral-copy-btn"><i class="fas fa-copy"></i></button>
            </div>

            <div class="social-share-buttons">
                <a href="#" class="social-share-btn whatsapp" id="share-whatsapp"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="social-share-btn twitter" id="share-twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="social-share-btn facebook" id="share-facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-share-btn sms" id="share-sms"><i class="fas fa-comment-dots"></i></a>
            </div>
        </div>
    </div>

    <!-- My Rewards Modal -->
    <div id="rewards-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-trophy"></i> My Rewards</h2>
            <p>Here are your available coupons and rewards. Click "Claim" to use them.</p>

            <ul class="rewards-list">
                <!-- Static content removed, will be populated by JS -->
                <li><p>Loading rewards...</p></li>
            </ul>
        </div>
    </div>

    <!-- Power Pass Modal -->
    <div id="pass-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-ticket-alt"></i> Power Pass</h2>
            <p>This section will contain information about subscription passes for rides or services. (Content to be
                built)</p>
        </div>
    </div>

    <!-- === END NEW Profile Modals === -->


    <!-- THIS IS THE CERTIFICATE CODE YOU PROVIDED -->
    <div id="certificate-modal" class="modal-overlay">
        <div class="certificate-container">
            <span id="cert-close-btn" class="cert-close-btn">&times;</span>
            <div class="certificate-header">
                <img src="Photoes/logo.png" class="certificate-logo" alt="SafeReturn Logo"
                    onerror="this.src='https://placehold.co/80x80/ffffff/E63939?text=SR'; this.onerror=null;">
                <h2 id="certificate-title">Certificate of Road Safety</h2>
                <p>For a steadfast commitment to responsible driving</p>
            </div>
            <div class="certificate-body">
                <p>This certificate is proudly presented to:</p>
                <span id="cert-name" class="cert-name">[Your Name Here]</span>
                <p>for pledging to be a responsible road user:</p>
                <blockquote>
                    "I commit to never drive distracted, to always follow traffic laws, and to prioritize the safety of
                    myself and others."
                </blockquote>
            </div>
            <div class="certificate-footer">
                <div class="certificate-signature">
                    <img src="Photoes/signature.png" class="signature-img" alt="Signature"
                        onerror="this.src='https://placehold.co/150x60/333333/ffffff?text=Signature'; this.onerror=null;">
                    <p>The SafeReturn Team</p>
                </div>
                <div class="certificate-date">
                    <p>Date: <span id="current-date"></span></p>
                </div>
            </div>
            <div class="cert-button-group">
                <button id="cert-print-btn" class="cert-btn"><i class="fas fa-print"></i> Print</button>
                <button id="cert-pdf-btn" class="cert-btn"><i class="fas fa-file-pdf"></i> Download PDF</button>
                <a id="cert-whatsapp" target="_blank" class="cert-btn fab fa-whatsapp"><i class="fab fa-whatsapp"></i>
                    Share
                    WhatsApp</a>
            </div>
        </div>
        <canvas id="confetti-canvas"></canvas>
    </div>

    <div id="hero-modal" class="modal-overlay">
        <div class="hero-modal-content">
            <span id="hero-close-btn">&times;</span>
            <h2>We are proud to call you a:</h2>
            <h1>ROAD SAFETY HERO</h1>
            <p>A defender of lives.</p>
            <p>A protector of families.</p>
            <!-- 
                FIX 1: This block of JS was here, causing a syntax error.
                It has been MOVED to the main <script> tag below.
            -->
        </div>
    </div>


    <script>
        // --- FIX: This script block needs to be *outside* the <script type="module"> block ---
        // --- but *inside* a DOMContentLoaded listener ---

        // --- Google Maps API Key ---
        // TODO: Replace "YOUR_API_KEY_GOES_HERE" with your actual Google Maps API Key
        const GOOGLE_MAPS_API_KEY = "YOUR_API_KEY_GOES_HERE";

        document.addEventListener('DOMContentLoaded', () => {

            // --- FIX 1: This logic was moved from the hero-modal div ---
            // --- NEW PROFILE MENU CLICK LOGIC ---
            const profileMenuTrigger = document.getElementById('nav-user-info');
            const profileMenu = document.getElementById('profile-dropdown-menu');

            if (profileMenuTrigger && profileMenu) {
                profileMenuTrigger.addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop click from bubbling to the document
                    profileMenu.classList.toggle('active');
                });
            }

            // Listener to close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (profileMenu && profileMenu.classList.contains('active')) {
                    // Check if the click was outside the menu AND outside the trigger
                    if (!profileMenu.contains(e.target) && !profileMenuTrigger.contains(e.target)) {
                        profileMenu.classList.remove('active');
                    }
                }
            });
            // --- END NEW PROFILE MENU CLICK LOGIC ---
            // --- END FIX 1 ---

            // --- NEW: Custom Alert Modal Logic ---
            const alertModal = document.getElementById('custom-alert-modal');
            const alertIcon = document.getElementById('custom-alert-icon');
            const alertTitle = document.getElementById('custom-alert-title');
            const alertMessage = document.getElementById('custom-alert-message');
            const alertClose = alertModal.querySelector('.profile-modal-close');
            const alertCloseBtn = document.getElementById('custom-alert-close-btn');

            const showAlert = (title, message, icon = 'info') => {
                if (!alertModal) return; // Safety check

                alertTitle.textContent = title;
                alertMessage.innerHTML = message; // Use innerHTML to allow simple line breaks

                // Set icon
                if (icon === 'success') {
                    alertIcon.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i>';
                } else if (icon === 'warning') {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i>';
                } else if (icon === 'error') {
                    alertIcon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--primary-color);"></i>';
                } else {
                    alertIcon.innerHTML = '<i class="fas fa-info-circle" style="color: #007bff;"></i>';
                }

                alertModal.classList.add('active');
            };

            const closeAlertModal = () => {
                if (alertModal) alertModal.classList.remove('active');
            };

            if (alertClose) alertClose.addEventListener('click', closeAlertModal);
            if (alertCloseBtn) alertCloseBtn.addEventListener('click', closeAlertModal);
            // --- END Custom Alert Modal Logic ---


            // --- NEW: Photo Upload Logic ---
            const galleryBtn = document.getElementById('photo-gallery-btn');
            const cameraBtn = document.getElementById('photo-camera-btn');
            const galleryInput = document.getElementById('photo-gallery-input');
            const cameraInput = document.getElementById('photo-camera-input');
            const navUserPhotoEl = document.getElementById('nav-user-photo');

            if (galleryBtn) {
                galleryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (galleryInput) galleryInput.click();
                });
            }

            if (cameraBtn) {
                cameraBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (cameraInput) cameraInput.click();
                });
            }

            const handlePhotoUpload = (file) => {
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    showAlert('Invalid File', 'Please select an image file.', 'warning');
                    return;
                }

                // Use the globally set instances
                if (!window.currentUserId || !window.storage || !window.db || !window.fs) {
                    showAlert('Not Logged In', 'You must be logged in to change your photo.', 'error');
                    return;
                }

                // Close the profile dropdown
                const profileMenu = document.getElementById('profile-dropdown-menu');
                if (profileMenu) profileMenu.classList.remove('active');
                
                showAlert('Uploading...', 'Your photo is being uploaded. Please wait.', 'info');

                const userId = window.currentUserId;
                const appId = window.appId;
                // Use window.fs.storage_ref
                const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                let fileDownloadURL = ''; // Variable to hold the URL

                // Use window.fs.uploadBytes
                window.fs.uploadBytes(photoRef, file)
                    .then(snapshot => {
                        // Use window.fs.getDownloadURL
                        return window.fs.getDownloadURL(snapshot.ref);
                    })
                    .then(downloadURL => {
                        fileDownloadURL = downloadURL; // Store URL
                        // Update Firestore
                        // Use window.fs.doc
                        const userDocRef = window.fs.doc(window.db, 'artifacts', appId, 'users', userId);
                        // Use window.fs.updateDoc
                        return window.fs.updateDoc(userDocRef, {
                            photoUrl: fileDownloadURL
                        });
                    })
                    .then(() => {
                        // Update UI
                        if (navUserPhotoEl) {
                            navUserPhotoEl.src = fileDownloadURL; // Use stored URL
                        }
                        // Update global data
                        if (window.currentUserData) {
                            window.currentUserData.photoUrl = fileDownloadURL;
                        }
                        
                        showAlert('Success', 'Profile photo updated!', 'success');
                    })
                    .catch(error => {
                        console.error("Photo upload error:", error);
                        showAlert('Upload Failed', `Error: ${error.message}`, 'error');
                    });
            };

            if (galleryInput) {
                galleryInput.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files[0]);
                    e.target.value = null; // Reset input
                });
            }

            if (cameraInput) {
                cameraInput.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files[0]);
                    e.target.value = null; // Reset input
                });
            }
            // --- END Photo Upload Logic ---


            // --- NEW: Circular Photo Uploader Logic ---
            const setupPhotoUploader = (portId, inputId, previewId, iconId, fileStore) => {
                const port = document.getElementById(portId);
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const icon = document.getElementById(iconId);

                if (!port || !input || !preview || !icon) return;

                port.addEventListener('click', () => input.click());

                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.add('active');
                            icon.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                        
                        // Store the file object
                        if (fileStore === 'driver') window.driverPhotoFile = file;
                        if (fileStore === 'traveler') window.travelerPhotoFile = file;
                        if (fileStore === 'emergency') window.emergencyPhotoFile = file;

                    } else {
                        // Reset
                        preview.src = '#';
                        preview.classList.remove('active');
                        icon.classList.remove('hidden');
                        if (fileStore === 'driver') window.driverPhotoFile = null;
                        if (fileStore === 'traveler') window.travelerPhotoFile = null;
                        if (fileStore === 'emergency') window.emergencyPhotoFile = null;
                    }
                    // Clear the input value to allow re-uploading the same file
                    e.target.value = null;
                });
            };

            setupPhotoUploader('driver-photo-uploader-port', 'driver-photo-input-hidden', 'driver-photo-preview', 'driver-photo-icon', 'driver');
            setupPhotoUploader('traveler-photo-uploader-port', 'traveler-photo-input-hidden', 'traveler-photo-preview', 'traveler-photo-icon', 'traveler');
            setupPhotoUploader('emergency-photo-uploader-port', 'emergency-photo-input-hidden', 'emergency-photo-preview', 'emergency-photo-icon', 'emergency');
            // --- END NEW ---


            // --- Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            const toggleSidebar = () => {
                if (sidebar) sidebar.classList.toggle('active');
                if (sidebarOverlay) sidebarOverlay.classList.toggle('active');
            };

            if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
            if (sidebarClose) sidebarClose.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            // --- NEW: Profile Dropdown Modal Logic ---
            const profileMenuLinks = document.getElementById('profile-dropdown-menu');

            if (profileMenuLinks) {
                profileMenuLinks.addEventListener('click', (e) => {
                    // Find the clicked <a> tag
                    const link = e.target.closest('a');
                    if (!link) return; // Didn't click a link

                    // Check if it's a modal trigger
                    const modalTargetId = link.dataset.modalTarget;
                    if (modalTargetId) {
                        e.preventDefault(); // Stop page from jumping

                        // Find the modal
                        const modal = document.getElementById(modalTargetId);
                        if (modal) {
                            // Show the target modal
                            modal.classList.add('active');

                            // Hide the profile dropdown
                            if (profileMenu) profileMenu.classList.remove('active');
                        }
                    }

                    // If it's the logout button, the existing listener in the other script block will handle it.
                });
            }

            // Add close logic for ALL new profile modals
            document.querySelectorAll('.profile-modal-overlay').forEach(modal => {
                // Close on 'X' button click
                const closeBtn = modal.querySelector('.profile-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        modal.classList.remove('active');
                    });
                }

                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            // --- END NEW Profile Dropdown Modal Logic ---


            // --- NEW: Star Rating Logic ---
            const ratingModal = document.getElementById('rating-modal');
            const starContainer = ratingModal ? ratingModal.querySelector('.star-rating-container') : null;
            const stars = starContainer ? starContainer.querySelectorAll('.star') : [];
            const submitReviewBtn = document.getElementById('submit-review-btn');
            const ratingContent = document.getElementById('rating-content');
            const ratingSuccess = document.getElementById('rating-success-message');

            let currentRating = 0;

            const setRating = (rating) => {
                currentRating = rating;
                if (starContainer) starContainer.dataset.rating = rating;
                stars.forEach(star => {
                    if (star.dataset.value <= rating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            };

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    setRating(value);
                });

                // Keep hover effect in JS to avoid CSS-only limitations
                star.addEventListener('mouseover', () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        s.style.color = s.dataset.value <= value ? 'var(--accent-color)' : '#ccc';
                    });
                });
            });

            if (starContainer) {
                starContainer.addEventListener('mouseout', () => {
                    // Reset to selected rating
                    stars.forEach(star => {
                        // Use .selected class to check, not style.color
                        if (star.classList.contains('selected')) {
                            star.style.color = 'var(--accent-color)';
                        } else {
                            star.style.color = '#ccc';
                        }
                    });
                });
            }

            if (submitReviewBtn) {
                submitReviewBtn.addEventListener('click', async () => {
                    const comment = document.getElementById('review-comment').value;
                    
                    if (!window.currentUserId || !window.db) {
                        showAlert('Not Logged In', 'You must be logged in to leave a review.', 'error');
                        return;
                    }

                    if (currentRating === 0) {
                         showAlert('No Rating', 'Please select at least one star.', 'warning');
                        return;
                    }

                    submitReviewBtn.disabled = true;
                    submitReviewBtn.textContent = 'Submitting...';

                    try {
                        const reviewData = {
                            userId: window.currentUserId,
                            name: window.currentUserData.name || 'Anonymous',
                            rating: currentRating,
                            comment: comment,
                            createdAt: new Date().toISOString()
                        };
                        // Save to a new public collection: /artifacts/{appId}/public/reviews
                        // --- FIX: Use window.fs.addDoc and window.fs.collection ---
                        await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'reviews'), reviewData);

                        // Show success message
                        if (ratingContent) ratingContent.style.display = 'none';
                        if (ratingSuccess) ratingSuccess.style.display = 'block';

                        // Reset modal after a delay
                        setTimeout(() => {
                            // Hide modal
                            if (ratingModal) ratingModal.classList.remove('active');

                            // Reset content
                            setTimeout(() => {
                                if (ratingContent) ratingContent.style.display = 'block';
                                if (ratingSuccess) ratingSuccess.style.display = 'none';
                                setRating(0); // Reset stars
                                document.getElementById('review-comment').value = '';
                            }, 400);
                        }, 2500);

                    } catch (error) {
                        console.error("Error submitting review:", error);
                        showAlert('Error', 'Could not submit your review. Please try again.', 'error');
                    } finally {
                        submitReviewBtn.disabled = false;
                        submitReviewBtn.textContent = 'Submit Review';
                    }
                });
            }

            // --- END Star Rating Logic ---


            // --- Accordion Logic (Tips & Education) ---
            const accordionItems = document.querySelectorAll('.tip, .edu-item');

            accordionItems.forEach(item => {
                item.addEventListener('click', () => {
                    const details = item.nextElementSibling;
                    if (!details || !details.classList.contains('tip-details') && !details.classList.contains('edu-details')) return;

                    const isOpen = details.classList.contains('open');

                    document.querySelectorAll('.tip-details, .edu-details').forEach(d => {
                        d.classList.remove('open');
                        d.style.maxHeight = null;
                        if (d.previousElementSibling) {
                            d.previousElementSibling.classList.remove('active');
                        }
                    });

                    if (!isOpen) {
                        item.classList.add('active');
                        details.classList.add('open');
                        details.style.maxHeight = details.scrollHeight + 'px';
                    }
                });
            });

            // --- NEW: FAQ Accordion Logic ---
            const faqItems = document.querySelectorAll('.faq-item');
            faqItems.forEach(item => {
                const title = item.querySelector('.faq-title');

                const toggleItem = () => {
                    const details = item.querySelector('.faq-details');
                    const isOpen = item.classList.contains('active');

                    if (isOpen) {
                        item.classList.remove('active');
                        details.classList.remove('open');
                        details.style.maxHeight = null;
                    } else {
                        item.classList.add('active');
                        details.classList.add('open');
                        details.style.maxHeight = details.scrollHeight + 'px';
                    }
                };

                if (title) {
                    title.addEventListener('click', toggleItem);
                    // Add keyboard support
                    title.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleItem();
                        }
                    });
                }
            });
            // --- END NEW FAQ Logic ---


            // --- NEW: Wallet Modal Logic ---
            const populateWallet = () => {
                const balanceEl = document.querySelector('#payment-modal .wallet-balance h3');
                if (!balanceEl) return;

                if (window.currentUserId && window.currentUserData.walletBalance) {
                    balanceEl.textContent = `₹${parseFloat(window.currentUserData.walletBalance).toFixed(2)}`;
                } else {
                    balanceEl.textContent = '₹0.00';
                }
            };
            window.populateWallet = populateWallet; // Attach to window so module script can call it.

            const showAddMoneyBtn = document.getElementById('show-add-money-btn');
            const addMoneySection = document.getElementById('add-money-section');
            const confirmAddMoneyBtn = document.getElementById('confirm-add-money-btn');
            const addMoneyAmountInput = document.getElementById('add-money-amount');

            if (showAddMoneyBtn) {
                showAddMoneyBtn.addEventListener('click', () => {
                    // Toggle the add money section
                    if (addMoneySection.style.display === 'block') {
                        addMoneySection.style.display = 'none';
                        showAddMoneyBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Money';
                    } else {
                        addMoneySection.style.display = 'block';
                        showAddMoneyBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                        if (addMoneyAmountInput) addMoneyAmountInput.focus();
                    }
                });
            }

            if (confirmAddMoneyBtn) {
                confirmAddMoneyBtn.addEventListener('click', async () => {
                    const amount = addMoneyAmountInput ? addMoneyAmountInput.value : 0;

                    if (!window.currentUserId || !window.db) {
                        showAlert('Not Logged In', 'You must be logged in to add money.', 'error');
                        return;
                    }

                    if (amount > 0) {
                        const originalText = confirmAddMoneyBtn.textContent;
                        confirmAddMoneyBtn.textContent = `Processing ₹${amount}...`;
                        confirmAddMoneyBtn.disabled = true;

                        try {
                            const newBalance = (parseFloat(window.currentUserData.walletBalance) || 0) + parseFloat(amount);
                            // --- FIX: Use window.fs.doc and window.fs.updateDoc ---
                            const userDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', window.currentUserId);
                            await window.fs.updateDoc(userDocRef, {
                                walletBalance: newBalance
                            });

                            // Manually update global state so UI refreshes
                            window.currentUserData.walletBalance = newBalance;
                            populateWallet(); // Re-render wallet UI
                            
                            showAlert('Success', `₹${amount} added to your wallet.`, 'success');

                        } catch (error) {
                            console.error("Error adding money:", error);
                            showAlert('Error', 'Could not add money. Please try again.', 'error');
                        } finally {
                            // Reset
                            confirmAddMoneyBtn.textContent = originalText;
                            confirmAddMoneyBtn.disabled = false;
                            if (addMoneyAmountInput) addMoneyAmountInput.value = '';
                            if (addMoneySection) addMoneySection.style.display = 'none';
                            if (showAddMoneyBtn) showAddMoneyBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Money';
                        }

                    } else {
                        showAlert('Invalid Amount', 'Please enter a valid amount.', 'warning');
                        if (addMoneyAmountInput) addMoneyAmountInput.focus();
                    }
                });
            }
            // --- END Wallet Modal Logic ---

            // --- NEW: Rides Modal Logic ---
            const populateRides = async () => {
                const rideListEl = document.querySelector('.ride-history-list');
                if (!rideListEl) return;

                if (!window.currentUserId) {
                    rideListEl.innerHTML = '<li><p>Please log in to see your ride history.</p></li>';
                    return;
                }

                rideListEl.innerHTML = '<li><p>Loading rides...</p></li>';
                try {
                    // --- FIX: Use window.fs.collection, .query, and .getDocs ---
                    const ridesColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rides');
                    const querySnapshot = await window.fs.getDocs(window.fs.query(ridesColRef)); // Don't order, sort in JS

                    if (querySnapshot.empty) {
                        rideListEl.innerHTML = '<li><p>You have no ride history.</p></li>';
                        return;
                    }

                    let rides = [];
                    querySnapshot.forEach(doc => rides.push({ id: doc.id, ...doc.data() }));
                    
                    // Sort by date in JS (newest first)
                    rides.sort((a, b) => new Date(b.date) - new Date(a.date));

                    rideListEl.innerHTML = ''; // Clear loading
                    rides.forEach(ride => {
                        const li = document.createElement('li');
                        li.className = 'ride-item';
                        li.innerHTML = `
                            <div class="icon"><i class="fas ${ride.type === 'motorcycle' ? 'fa-motorcycle' : 'fa-car-side'}"></i></div>
                            <div class="ride-details">
                                <p>${ride.location || 'Unknown Ride'}</p>
                                <span>${new Date(ride.date).toLocaleString()}</span>
                                <span>Driver: ${ride.driver || 'N/A'}</span>
                            </div>
                            <div class="ride-price">₹${ride.price || 0}</div>
                        `;
                        rideListEl.appendChild(li);
                    });

                } catch (error) {
                    console.error("Error fetching rides:", error);
                    rideListEl.innerHTML = '<li><p>Could not load ride history.</p></li>';
                }
            };
            window.populateRides = populateRides; // Attach to window
            // --- END Rides Modal Logic ---


            // --- NEW: Safety Modal Button Logic ---
            const shareRideBtn = document.getElementById('share-ride-btn');
            const sosBtn = document.getElementById('sos-btn');

            if (shareRideBtn) {
                shareRideBtn.addEventListener('click', () => {
                    showAlert('Share My Ride (Demo)', 'Your live location will be shared with your trusted contacts.', 'info');
                });
            }

            if (sosBtn) {
                sosBtn.addEventListener('click', async () => {
                    showAlert('Emergency SOS', 'Connecting to emergency services and sharing your location...', 'error');
                
                    if (window.currentUserId && window.db) {
                        try {
                            // Log this event to a new collection
                            // --- FIX: Use window.fs.addDoc and window.fs.collection ---
                            await window.fs.addDoc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'sosEvents'), {
                                userId: window.currentUserId,
                                name: window.currentUserData.name || 'Unknown',
                                role: window.currentUserData.role || 'unknown',
                                timestamp: new Date().toISOString()
                            });
                        } catch (error) {
                            console.error("Failed to log SOS event:", error);
                        }
                    }
                });
            }
            // --- END Safety Modal Logic ---


            // --- NEW: Refer & Rewards Logic ---
            const referralCopyBtn = document.getElementById('referral-copy-btn');
            const referralCodeInput = document.getElementById('referral-code');
            const shareWhatsapp = document.getElementById('share-whatsapp');
            const shareTwitter = document.getElementById('share-twitter');
            const shareFacebook = document.getElementById('share-facebook');
            const shareSms = document.getElementById('share-sms');

            const copyReferralCode = () => {
                if (!referralCodeInput) return;
                try {
                    referralCodeInput.select();
                    document.execCommand('copy');
                    const originalIcon = referralCopyBtn.innerHTML;
                    referralCopyBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        referralCopyBtn.innerHTML = originalIcon;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy code: ', err);
                    showAlert('Copy Failed', 'Failed to copy. Please copy it manually.', 'error');
                }
            };

            if (referralCopyBtn) {
                referralCopyBtn.addEventListener('click', copyReferralCode);
            }

            const updateShareLinks = () => {
                const code = referralCodeInput ? referralCodeInput.value : '';
                const text = encodeURIComponent(`Hey! Join me on SafeReturn, the best road safety app. Use my referral code: ${code}`);
                const url = encodeURIComponent("https.safereturn.com"); // Placeholder URL

                if (shareWhatsapp) shareWhatsapp.href = `https://wa.me/?text=${text}`;
                if (shareTwitter) shareTwitter.href = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
                if (shareFacebook) shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`;
                if (shareSms) shareSms.href = `sms:?&body=${text}`;
            };

            // Update links when the modal is opened (the code might populate after load)
            const referModalTrigger = document.querySelector('a[data-modal-target="refer-modal"]');
            if (referModalTrigger) {
                referModalTrigger.addEventListener('click', updateShareLinks);
            }

            // --- NEW: Rewards Population & Claim Logic ---
            const populateRewards = async () => {
                const rewardsListEl = document.querySelector('.rewards-list');
                if (!rewardsListEl) return;

                if (!window.currentUserId) {
                    rewardsListEl.innerHTML = '<li><p>Please log in to see your rewards.</p></li>';
                    return;
                }

                rewardsListEl.innerHTML = '<li><p>Loading rewards...</p></li>';
                try {
                    // --- FIX: Use window.fs.collection, .query, and .getDocs ---
                    const rewardsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rewards');
                    const querySnapshot = await window.fs.getDocs(window.fs.query(rewardsColRef)); // No ordering

                    if (querySnapshot.empty) {
                        rewardsListEl.innerHTML = '<li><p>You have no rewards yet.</p></li>';
                        return;
                    }

                    let rewards = [];
                    querySnapshot.forEach(doc => rewards.push({ id: doc.id, ...doc.data() }));
                    
                    rewardsListEl.innerHTML = ''; // Clear loading
                    rewards.forEach(reward => {
                        const li = document.createElement('li');
                        li.className = 'reward-item';
                        li.innerHTML = `
                            <div class="icon"><i class="fas ${reward.icon || 'fa-gift'}"></i></div>
                            <div class="details">
                                <h4>${reward.title}</h4>
                                <p>${reward.description}</p>
                            </div>
                            <button class="claim-btn" data-id="${reward.id}" ${reward.claimed ? 'disabled' : ''}>
                                ${reward.claimed ? 'Claimed' : 'Claim'}
                            </button>
                        `;
                        rewardsListEl.appendChild(li);
                    });
                    
                    // Add event listeners to the new buttons
                    attachClaimButtonListeners();

                } catch (error) {
                    console.error("Error fetching rewards:", error);
                    rewardsListEl.innerHTML = '<li><p>Could not load rewards.</p></li>';
                }
            };
            window.populateRewards = populateRewards; // Attach to window

            const attachClaimButtonListeners = () => {
                document.querySelectorAll('.claim-btn').forEach(btn => {
                    // Remove old listener to prevent duplicates
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    newBtn.addEventListener('click', async () => {
                        if (newBtn.disabled) return;
                        const rewardId = newBtn.dataset.id;
                        if (!window.currentUserId || !rewardId || !window.db) return;

                        newBtn.disabled = true;
                        newBtn.textContent = 'Claiming...';

                        try {
                            // --- FIX: Use window.fs.doc and window.fs.updateDoc ---
                            const rewardDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rewards', rewardId);
                            await window.fs.updateDoc(rewardDocRef, {
                                claimed: true
                            });

                            newBtn.textContent = 'Claimed!';
                            newBtn.style.background = '#ccc';
                            newBtn.style.cursor = 'not-allowed';
                            showAlert('Success', 'Reward has been claimed!', 'success');

                        } catch (error) {
                            console.error("Error claiming reward:", error);
                            showAlert('Error', 'Could not claim reward. Please try again.', 'error');
                            newBtn.disabled = false;
                            newBtn.textContent = 'Claim';
                        }
                    });
                });
            };
            // --- END Refer & Rewards Logic ---


            // --- Registration Modal Logic (MOVED to top script) ---


            // --- NEW Map Preview Logic ---
            const previewDriverMapBtn = document.getElementById('previewDriverMapBtn');
            const driverMapContainer = document.getElementById('driver-map-container');
            const driverDestinationInput = document.getElementById('driverDestination');

            const previewEmergencyMapBtn = document.getElementById('previewEmergencyMapBtn');
            const emergencyMapContainer = document.getElementById('emergency-map-container');
            const emergencyDestinationInput = document.getElementById('emergencyDestination');

            const displayMap = (container, location) => {
                if (!container) return; // Guard against null

                if (!location) {
                    container.innerHTML = `<div class="map-api-notice"><i class="fas fa-exclamation-triangle"></i>Please enter a destination first.</div>`;
                    container.style.display = 'block';
                    return;
                }

                if (GOOGLE_MAPS_API_KEY === "YOUR_API_KEY_GOES_HERE" || !GOOGLE_MAPS_API_KEY) {
                    container.innerHTML = `<div class="map-api-notice"><i class="fas fa-key"></i><b>Action Required</b><br>Please add your Google Maps API Key in the script to enable map previews.</div>`;
                    container.style.display = 'block';
                    return;
                }

                const embedUrl = `https://www.google.com/maps/embed/v1/place?key=${GOOGLE_MAPS_API_KEY}&q=${encodeURIComponent(location + ', India')}`;

                container.innerHTML = `
                    <iframe
                        loading="lazy"
                        allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="${embedUrl}">
                    </iframe>
                `;
                container.style.display = 'block';
            };

            if (previewDriverMapBtn) {
                previewDriverMapBtn.addEventListener('click', () => {
                    if (!driverDestinationInput) return;
                    const location = driverDestinationInput.value.trim();
                    displayMap(driverMapContainer, location);
                });
            }

            if (previewEmergencyMapBtn) {
                previewEmergencyMapBtn.addEventListener('click', () => {
                    if (!emergencyDestinationInput) return;
                    const location = emergencyDestinationInput.value.trim();
                    displayMap(emergencyMapContainer, location);
                });
            }



            // --- Pledge & Certificate Logic ---
            const pledgeBtn = document.getElementById('generate-pledge-btn');
            const pledgeNameInput = document.getElementById('pledge-name');
            const pledgeOutputP = document.querySelector('#pledge-output p');

            // FIX: Check if pledgeOutputP exists before accessing innerHTML
            const originalPledgeHTML = pledgeOutputP ? pledgeOutputP.innerHTML : 'I pledge to be <strong><em>YOU</em>.</strong> A responsible road user.';

            const certModal = document.getElementById('certificate-modal');
            const certCloseBtn = document.getElementById('cert-close-btn');
            const certName = document.getElementById('cert-name');
            const certDate = document.getElementById('current-date');
            const downloadPdfBtn = document.getElementById('cert-pdf-btn');
            const printBtn = document.getElementById('cert-print-btn');
            const whatsappBtn = document.getElementById('cert-whatsapp');
            const certificateContainer = certModal ? certModal.querySelector('.certificate-container') : null;
            const confettiCanvas = document.getElementById('confetti-canvas');

            const heroModal = document.getElementById('hero-modal');
            const heroCloseBtn = document.getElementById('hero-close-btn');

            let myConfetti;
            if (confettiCanvas) {
                myConfetti = confetti.create(confettiCanvas, {
                    resize: true,
                    useWorker: true
                });
            }


            if (pledgeBtn) {
                pledgeBtn.addEventListener('click', () => {
                    if (!pledgeNameInput) return;

                    const name = pledgeNameInput.value.trim();
                    if (name === "") {
                        pledgeNameInput.focus();
                        pledgeNameInput.style.borderColor = 'var(--primary-color)';
                        return;
                    }
                    pledgeNameInput.style.borderColor = '#ccc';


                    const newPledgeHTML = originalPledgeHTML.replace(
                        '<strong><em>YOU</em>.</strong>',
                        `<strong style="color: var(--primary-color);"><em>${name}</em>.</strong>`
                    );

                    if (pledgeOutputP) pledgeOutputP.innerHTML = newPledgeHTML;

                    if (certName) certName.textContent = name;
                    if (certDate) certDate.textContent = new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    const shareText = encodeURIComponent(
                        `I just took the SafeReturn Road Safety Pledge! Join me in committing to safer roads. #SafeReturn #RoadSafetyHero`
                    );
                    if (whatsappBtn) whatsappBtn.href = `https://wa.me/?text=${shareText}`;

                    if (certModal) certModal.style.display = 'flex';

                    if (myConfetti) {
                        myConfetti({
                            particleCount: 150,
                            spread: 90,
                            origin: { y: 0.6 },
                            zIndex: 10001
                        });
                    }
                });
            }

            if (certCloseBtn) {
                certCloseBtn.addEventListener('click', () => {
                    if (certModal) certModal.style.display = 'none';
                    if (heroModal) heroModal.style.display = 'flex';
                });
            }

            if (heroCloseBtn) {
                heroCloseBtn.addEventListener('click', () => {
                    if (heroModal) heroModal.style.display = 'none';
                });
            }

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', () => {
                    if (!certificateContainer) return;

                    const buttons = certificateContainer.querySelector('.cert-button-group');
                    const closeBtn = certificateContainer.querySelector('.cert-close-btn');

                    if (buttons) buttons.style.display = 'none';
                    if (closeBtn) closeBtn.style.display = 'none';

                    html2canvas(certificateContainer, {
                        scale: 2,
                        useCORS: true
                    }).then(canvas => {
                        if (buttons) buttons.style.display = 'flex';
                        if (closeBtn) closeBtn.style.display = 'block';

                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;

                        const pdfWidth = 210;
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        const pdf = new jsPDF('p', 'mm', 'a4');

                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save('SafeReturn_Pledge.pdf');
                    }).catch(err => {
                        console.error("Error generating PDF:", err);
                        if (buttons) buttons.style.display = 'flex';
                        if (closeBtn) closeBtn.style.display = 'block';
                    });
                });
            }

            if (printBtn) {
                printBtn.addEventListener('click', () => {
                    window.print();
                });
            }

            if (certModal) {
                certModal.addEventListener('click', (e) => {
                    if (e.target === certModal) {
                        certModal.style.display = 'none';
                        if (heroModal) heroModal.style.display = 'flex';
                    }
                });
            }

            if (heroModal) {
                heroModal.addEventListener('click', (e) => {
                    if (e.target === heroModal) {
                        heroModal.style.display = 'none';
                    }
                });
            }

        });
    </script>





    <!-- footer -->
    <footer id="main-footer">
        <div
            style="max-width: 1200px; margin: auto; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 40px; padding: 0 20px;">

            <div class="footer-section">
                <h3
                    style="color: var(--accent-color); margin-bottom: 20px; font-size: 1.5em; display: flex; align-items: center;">
                    <span style="margin-right: 10px;">🚦</span> Road Safety Club
                </h3>
                <p style="line-height: 1.6;">
                    Our mission is to empower everyone with the knowledge to drive and walk safely. Join us in making
                    roads safer
                    for all!
                </p>

                <button onclick="window.scrollTo({top:0, behavior:'smooth'});" class="back-to-top-btn"
                    style="margin-top: 25px; padding: 12px 25px; background-color: var(--accent-color); border: none; color: var(--dark-bg); font-weight: 700; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    ↑ Zoom Back Up!
                </button>
            </div>

            <div class="footer-section">
                <h3 style="color: var(--accent-color); margin-bottom: 20px; font-size: 1.2em;">📞 Connect With Us</h3>
                <ul style="list-style: none; padding: 0; line-height: 2;">
                    <li><a href="mailto:info@roadsafetyclub.com"
                            class="footer-link email-link">info@roadsafetyclub.com</a>
                    </li>
                </ul>

                <h4 style="color: var(--light-text); margin-top: 15px; margin-bottom: 5px; font-weight: 600;">Team
                    Contacts:</h4>
                <ul style="list-style: none; padding: 0; line-height: 1.8;">
                    <li><a href="tel:9996445592" class="footer-link contact-list-link"><strong>Vivek Yadav:</strong>
                            9996445592</a>
                    </li>
                    <li><a href="tel:9251399133" class="footer-link contact-list-link"><strong>Shri ji
                                Aggarwal:</strong>
                            9457057473</a></li>
                    <li><a href="tel:9389864319" class="footer-link contact-list-link"><strong>Shreya
                                Chaudhary:</strong>
                            9389864319</a></li>
                    <li><a href="tel:7056123205" class="footer-link contact-list-link"><strong>Ekta Pannu:</strong>
                            7056123205</a>
                    </li>
                    <li><a href="tel:9457057473" class="footer-link contact-list-link"><strong>Khush Raghav:</strong>
                            9251399133</a>
                    </li>
                </ul>
            </div>

            <div class="footer-section">
                <h3 style="color: var(--accent-color); margin-bottom: 20px; font-size: 1.2em;">🔗 Quick Resources</h3>
                <ul style="list-style: none; padding: 0; line-height: 2;">
                    <!-- This is the updated link -->
                    <li><a href="Road-safety-handbook.pdf" class="footer-link">Traffic Rules Handbook</a></li>
                    <li><a href="/events" class="footer-link">Upcoming Safety Events</a></li>
                    <li><a href="/blog" class="footer-link">Safety Blog</a></li>
                    <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSf4sZdUmq6lhWxHyZ9yFuACp7wRLufzcB2VzmCBoVyg7qvn7w/viewform"
                            class="footer-link">Join Our Volunteer Team</a></li>
                </ul>

                <div style="margin-top: 20px;">
                    <a href="#" class="social-icon" aria-label="Follow us on World Wide Web">🌐</a>
                    <a href="#" class="social-icon" aria-label="Follow us on Facebook">📘</a>
                    <a href="#" class="social-icon" aria-label="Follow us on Twitter">🐦</a>
                    <a href="#" classs="social-icon" aria-label="Follow us on LinkedIn">💼</a>
                </div>
            </div>

        </div> <!-- This closes the max-width div -->

        <div class="footer-bottom-bar"
            style="text-align: center; padding: 25px 20px; border-top: 1px solid var(--border-color); margin-top: 40px; background-color: rgba(0,0,0,0.2);">
            <p style="margin: 0; font-size: 0.9em; color: #ccc;">
                &copy; 2024 Road Safety Club (Vivek Yadav & Team). All Rights Reserved.
            </p>
            <p style="margin: 5px 0 0; font-size: 0.85em; color: #888;">
                Disclaimer: This website is for educational and awareness purposes only. Always follow official traffic
                laws.
            </p>
        </div>

        <!-- STYLING FOR THE FOOTER LINKS -->
        <style>
            .footer-section {
                flex: 1;
                min-width: 280px;
            }

            .footer-link {
                color: #ccc;
                text-decoration: none;
                transition: color 0.3s, text-decoration 0.3s;
                display: inline-block;
                position: relative;
            }

            .footer-link::after {
                content: '';
                display: block;
                width: 0;
                height: 1px;
                background: var(--accent-color);
                transition: width 0.3s ease; /* Completed this line */
            }

            /* Added the rest of the styles */
            .footer-link:hover {
                color: var(--accent-color);
            }

            .footer-link:hover::after {
                width: 100%;
            }

            .email-link {
                font-weight: 600;
                color: #fff;
            }

            .contact-list-link strong {
                color: #fff;
                font-weight: 600;
            }

            .social-icon {
                color: #fff;
                font-size: 1.5em;
                margin-right: 15px;
                text-decoration: none;
                transition: color 0.3s, transform 0.3s;
                display: inline-block;
            }

            .social-icon:hover {
                color: var(--accent-color);
                transform: scale(1.1);
            }

            .back-to-top-btn:hover {
                background-color: var(--accent-hover);
                box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
                transform: translateY(-2px);
            }
        </style>
    </footer> <!-- Added closing footer tag -->

</body> <!-- Added closing body tag -->

</html> <!-- Added closing html tag -->



